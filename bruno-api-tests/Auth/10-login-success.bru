meta {
  name: 用户登录 - 成功并保存Token
  type: http
  seq: 10
}

post {
  url: {{authBaseUrl}}/login
  body: json
  auth: none
}

body:json {
  // {
    // "username": "newUser1234",
    // "password": "newPassword123"
  // }
  
  // {
    // "username": "weiting1",
    // "password": "Weiting1"
  // }
  
  {
    "username": "weiting2",
    "password": "Weiting2"
  }
  
  // {
    // "username": "admin",
    // "password": "Admin123"
  // }
}

assert {
  res.status: in [200, 201]
}

script:post-response {
  if (res.status === 200 || res.status === 201) {
    // 正确的路径：res.body.data.accessToken
    const token = res.body.data.accessToken;
    
    // 调试输出
    console.log("========== 登录成功 ==========");
    console.log("完整响应:", JSON.stringify(res.body, null, 2));
    console.log("Access Token:", token);
    console.log("Token 长度:", token?.length);
    console.log("用户信息:", res.body.data.user);
    
    // 保存到环境变量
    bru.setVar("token", token);
    bru.setVar("adminToken", token);
    
    // 验证是否保存成功
    console.log("已保存的 token:", bru.getVar("token"));
    console.log("=============================");
  } else {
    console.error("登录失败 - 状态码:", res.status);
    console.error("错误信息:", res.body);
  }
}

tests {
  test("登录成功并获取Token", function() {
    expect(res.status).to.be.oneOf([200, 201]);
    expect(res.body.data).to.have.property('accessToken');
    expect(res.body.data.accessToken).to.be.a('string');
    expect(res.body.data).to.have.property('user');
    expect(res.body.data.user).to.have.property('username');
  });
}
