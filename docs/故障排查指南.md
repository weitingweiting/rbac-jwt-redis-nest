# NestJS 服务故障排查和预防指南

## 问题现象

运行 `pnpm dev` 一段时间后，服务自动停止，浏览器返回：`ERR_CONNECTION_REFUSED`

## 根本原因

### 1. 数据库连接池耗尽

- **原因**：连接池默认只有 10 个连接，高并发或长查询会导致连接池耗尽
- **症状**：请求变慢，最终服务崩溃

### 2. MySQL 连接超时

- **原因**：MySQL 默认 `wait_timeout` 为 8 小时，但连接可能更早失效
- **症状**：长时间空闲后首次请求失败

### 3. Redis 连接断开

- **原因**：网络波动、Redis 重启、超时设置不当
- **症状**：缓存操作失败，可能导致服务崩溃

### 4. 内存泄漏

- **原因**：频繁的热重载（watch 模式）、未释放的事件监听器
- **症状**：内存持续增长，最终 Node.js 进程崩溃

## 已实施的解决方案

### ✅ 1. 优化数据库连接池配置

**文件**: `src/shared/config/database.config.ts`

**改进内容**:

```typescript
extra: {
  connectionLimit: 20,        // 增加到 20 个连接
  waitForConnections: true,
  queueLimit: 0,
  connectTimeout: 60000,      // 60秒连接超时
  acquireTimeout: 60000,      // 60秒获取连接超时
  timeout: 60000,             // 60秒查询超时
  keepAliveInitialDelay: 10000, // TCP keepalive
  enableKeepAlive: true
},
poolSize: 20,
maxQueryExecutionTime: 5000   // 慢查询警告
```

### ✅ 2. 增强健康检查端点

**文件**: `src/app.controller.ts`

**功能**:

- 实时监控数据库连接状态
- 显示连接池使用情况
- 监控内存使用情况

**访问**: `GET http://localhost:3000/api/health`

### ✅ 3. 优化 Redis 连接配置

**文件**: `src/shared/config/redis.config.ts`

**改进内容**:

```typescript
connectTimeout: 10000,        // 10秒连接超时
commandTimeout: 5000,         // 5秒命令超时
maxRetriesPerRequest: 3,      // 最多重试3次
reconnectOnError: true,       // 自动重连
retryStrategy: (times) => {   // 智能重试策略
  if (times > 10) return null;
  return Math.min(times * 100, 3000);
}
```

### ✅ 4. 进程监控脚本

**文件**: `scripts/monitor-process.sh`

**使用方法**:

```bash
# 持续监控模式（每30秒检查一次）
./scripts/monitor-process.sh monitor

# 单次检查
./scripts/monitor-process.sh check
```

## 最佳实践建议

### 1. 开发环境使用 PM2 管理进程

安装 PM2:

```bash
pnpm add -D pm2
```

创建 `ecosystem.config.js`:

```javascript
module.exports = {
  apps: [
    {
      name: 'rbac-nest-dev',
      script: 'pnpm',
      args: 'start:dev',
      watch: false,
      max_memory_restart: '500M', // 内存超过500MB自动重启
      restart_delay: 4000, // 重启延迟
      autorestart: true,
      max_restarts: 10, // 最多重启10次
      min_uptime: '10s' // 最小运行时间
    }
  ]
}
```

启动:

```bash
pm2 start ecosystem.config.js
pm2 logs rbac-nest-dev
pm2 monit  # 实时监控
```

### 2. 使用 nodemon 代替 nest start --watch

在 `package.json` 中添加:

```json
{
  "scripts": {
    "dev": "nodemon --watch src --ext ts --exec 'cross-env NODE_ENV=development nest start'"
  }
}
```

创建 `nodemon.json`:

```json
{
  "watch": ["src"],
  "ext": "ts",
  "ignore": ["src/**/*.spec.ts"],
  "exec": "cross-env NODE_ENV=development nest start",
  "delay": 1000
}
```

### 3. 启用日志文件

修改 `.env`:

```env
LOG_TO_FILE=true
LOG_LEVEL=debug
```

这样即使服务崩溃，也能在 `logs/` 目录查看详细日志。

### 4. Docker 容器健康检查

修改 `docker-compose.yml`，为 MySQL 和 Redis 添加更激进的健康检查:

```yaml
mysql:
  healthcheck:
    test: ['CMD', 'mysqladmin', 'ping', '-h', 'localhost']
    interval: 5s # 每5秒检查
    timeout: 3s
    retries: 3
    start_period: 20s

redis:
  healthcheck:
    test: ['CMD', 'redis-cli', 'ping']
    interval: 5s
    timeout: 2s
    retries: 3
```

### 5. 定期清理 Redis 缓存

在 `src/app.module.ts` 添加定时任务:

```typescript
import { ScheduleModule } from '@nestjs/schedule'

@Module({
  imports: [
    ScheduleModule.forRoot(),
    // ...其他模块
  ]
})
```

### 6. 监控慢查询

在开发环境启用 SQL 日志:

```typescript
// database.config.ts
logging: nodeEnv === 'development' ? ['query', 'error', 'warn'] : ['error'],
maxQueryExecutionTime: 1000, // 超过1秒的查询都会被记录
```

## 故障排查步骤

### 1. 检查服务状态

```bash
# 快速检查
./scripts/monitor-process.sh check

# 或手动检查
curl http://localhost:3000/api/health
```

### 2. 查看进程

```bash
ps aux | grep -E "node|nest"
```

### 3. 查看日志

```bash
# 应用日志
tail -f logs/app-*.log
tail -f logs/error-*.log

# 监控日志
tail -f logs/monitor.log
```

### 4. 检查 Docker 容器

```bash
docker ps | grep rbac-demo
docker logs rbac-demo-mysql
docker logs rbac-demo-redis
```

### 5. 测试数据库连接

```bash
# MySQL
docker exec -it rbac-demo-mysql mysql -uroot -ppassword -e "SELECT 1"

# Redis
docker exec -it rbac-demo-redis redis-cli ping
```

### 6. 查看资源使用

```bash
# 内存使用
docker stats --no-stream

# 系统资源
top -l 1 | grep -E "CPU|PhysMem"
```

## 预防措施

1. **开发时使用监控脚本**

   ```bash
   # 终端1: 启动服务
   pnpm dev

   # 终端2: 监控服务
   ./scripts/monitor-process.sh monitor
   ```

2. **定期重启开发服务**
   - 建议每 2-3 小时重启一次
   - 或使用 PM2 自动管理

3. **及时查看健康检查**
   - 定期访问 `/api/health` 查看连接池状态
   - 关注内存使用情况

4. **避免长时间空闲**
   - 如果长时间不用，建议停止服务
   - 重新启动时检查 Docker 容器状态

## 常见错误和解决方案

### Error: connect ECONNREFUSED

**原因**: 服务未启动或端口被占用
**解决**:

```bash
lsof -i :3000  # 查看端口占用
pnpm dev       # 重新启动
```

### Error: ER_TOO_MANY_USER_CONNECTIONS

**原因**: MySQL 连接数超限
**解决**:

```bash
# 重启 MySQL 容器
docker restart rbac-demo-mysql

# 或增加 MySQL max_connections
# 在 docker-compose.yml 中添加:
# --max_connections=200
```

### Error: Redis connection lost

**原因**: Redis 连接断开
**解决**:

```bash
# 检查 Redis
docker logs rbac-demo-redis

# 重启 Redis
docker restart rbac-demo-redis
```

## 联系支持

如果问题持续存在，请收集以下信息:

1. 错误日志 (`logs/error-*.log`)
2. 健康检查输出 (`curl http://localhost:3000/api/health`)
3. Docker 容器状态 (`docker ps -a`)
4. 系统资源使用情况
