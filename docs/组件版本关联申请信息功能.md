# 组件版本关联研发申请信息功能

## 功能概述

为组件版本列表和详情接口添加研发申请信息的关联，使前端可以查看每个版本对应的申请单号、申请人等信息，便于追溯版本来源和审批历史。

## 修改内容

### 1. 实体层修改 (`component-version.entity.ts`)

#### 新增关联关系

```typescript
/**
 * 关联的研发申请
 * 每个版本对应一个创建它的研发申请
 */
@OneToOne(() => DevelopmentApplication, (app) => app.componentVersionId, { nullable: true })
@JoinColumn({ name: 'id', referencedColumnName: 'componentVersionId' })
developmentApplication: DevelopmentApplication | null
```

**说明：**

- 使用 `@OneToOne` 装饰器建立一对一关系
- 通过 `componentVersionId` 字段关联（DevelopmentApplication 表中的外键）
- 可空关系（nullable: true），因为历史版本可能没有申请记录

### 2. 服务层修改 (`component-versions.service.ts`)

#### 修改 `findAllWithPagination` 方法

```typescript
const queryBuilder = this.versionRepository
  .createQueryBuilder('version')
  .leftJoinAndSelect('version.component', 'component')
  .leftJoinAndSelect('version.developmentApplication', 'application') // 新增
  .leftJoinAndSelect('application.applicant', 'applicant') // 新增
  .where('version.deletedAt IS NULL')
```

#### 修改 `findOneVersion` 方法

```typescript
const version = await this.versionRepository.findOne({
  where: { id },
  relations: [
    'component',
    'developmentApplication', // 新增
    'developmentApplication.applicant' // 新增
  ],
  withDeleted: false
})
```

**说明：**

- 使用 `leftJoinAndSelect` 关联加载申请信息
- 级联加载申请人（applicant）信息
- 使用左连接（left join）确保即使没有申请记录的版本也能查询出来

### 3. 控制器层修改 (`component-versions.controller.ts`)

#### 更新接口注释

在控制器方法的注释中明确说明返回数据包含申请信息：

```typescript
/**
 * 返回数据包含：
 * - version: 版本基本信息
 * - component: 关联的组件信息
 * - developmentApplication: 创建该版本的研发申请信息
 *   - applicationNo: 申请单号
 *   - applicant: 申请人信息
 *   - applicationType: 申请类型（new/version/replace）
 *   - developmentStatus: 申请状态
 */
```

## 返回数据结构

### 版本列表接口

**请求：** `GET /api/components/:componentId/versions`

**响应示例：**

```json
{
  "message": "获取版本列表成功",
  "data": [
    {
      "id": 1,
      "componentId": "BarChart",
      "version": "1.0.0",
      "status": "published",
      "isLatest": true,
      "publishedAt": "2026-01-10T10:00:00Z",
      "component": {
        "componentId": "BarChart",
        "name": "柱状图组件",
        "description": "一个功能强大的柱状图组件"
      },
      "developmentApplication": {
        "id": 1,
        "applicationNo": "APP-20260109-0001",
        "applicationType": "new",
        "developmentStatus": "completed",
        "targetVersion": "1.0.0",
        "applicant": {
          "id": 1,
          "username": "zhangsan",
          "realName": "张三",
          "email": "zhangsan@example.com"
        },
        "submittedAt": "2026-01-09T10:00:00Z",
        "reviewedAt": "2026-01-09T14:00:00Z",
        "completedAt": "2026-01-10T10:00:00Z"
      },
      "createdAt": "2026-01-10T10:00:00Z",
      "updatedAt": "2026-01-10T10:00:00Z"
    },
    {
      "id": 2,
      "componentId": "BarChart",
      "version": "1.1.0",
      "status": "draft",
      "isLatest": false,
      "publishedAt": null,
      "component": {
        "componentId": "BarChart",
        "name": "柱状图组件"
      },
      "developmentApplication": {
        "id": 5,
        "applicationNo": "APP-20260112-0007",
        "applicationType": "version",
        "developmentStatus": "completed",
        "targetVersion": "1.1.0",
        "applicant": {
          "id": 2,
          "username": "lisi",
          "realName": "李四",
          "email": "lisi@example.com"
        },
        "submittedAt": "2026-01-12T09:00:00Z",
        "reviewedAt": "2026-01-12T15:00:00Z",
        "completedAt": "2026-01-12T16:00:00Z"
      },
      "createdAt": "2026-01-12T16:00:00Z",
      "updatedAt": "2026-01-12T16:00:00Z"
    }
  ],
  "total": 2,
  "page": 1,
  "limit": 10
}
```

### 版本详情接口

**请求：** `GET /api/component-versions/:versionId`

**响应示例：**

```json
{
  "message": "获取版本详情成功",
  "data": {
    "id": 1,
    "componentId": "BarChart",
    "version": "1.0.0",
    "status": "published",
    "isLatest": true,
    "entryUrl": "https://cdn.example.com/components/BarChart/1.0.0/index.esm.js",
    "styleUrl": "https://cdn.example.com/components/BarChart/1.0.0/style.css",
    "previewUrl": "https://cdn.example.com/components/BarChart/1.0.0/preview.png",
    "type": "vue-echarts",
    "framework": "vue3",
    "buildTime": "2026-01-10T09:30:00Z",
    "publishedAt": "2026-01-10T10:00:00Z",
    "component": {
      "componentId": "BarChart",
      "name": "柱状图组件",
      "description": "一个功能强大的柱状图组件",
      "classificationLevel1": "chart",
      "classificationLevel2": "bar"
    },
    "developmentApplication": {
      "id": 1,
      "applicationNo": "APP-20260109-0001",
      "applicationType": "new",
      "developmentStatus": "completed",
      "targetVersion": "1.0.0",
      "changelog": "首个版本发布",
      "applicant": {
        "id": 1,
        "username": "zhangsan",
        "realName": "张三",
        "email": "zhangsan@example.com",
        "department": "产品研发部"
      },
      "reviewer": {
        "id": 10,
        "username": "admin",
        "realName": "管理员"
      },
      "submittedAt": "2026-01-09T10:00:00Z",
      "reviewedAt": "2026-01-09T14:00:00Z",
      "completedAt": "2026-01-10T10:00:00Z"
    },
    "createdAt": "2026-01-10T10:00:00Z",
    "updatedAt": "2026-01-10T10:00:00Z"
  }
}
```

## 业务场景

### 1. 版本追溯

前端可以显示每个版本的来源信息：

- 谁申请创建的这个版本
- 什么时候申请的
- 申请类型（新建/迭代/替换）
- 审批流程的时间节点

### 2. 申请历史查看

在申请历史页面可以关联展示：

- 该申请创建的版本详情
- 版本的当前状态（draft/published）
- 是否为推荐版本

### 3. 权限控制

可以基于申请人信息进行权限判断：

- 申请人可以编辑自己创建的 draft 版本
- 审核人可以查看申请详情
- 管理员可以操作所有版本

## 数据库关系

```
ComponentVersion (组件版本表)
  id (主键) ←──────────┐
  componentId          │
  version              │
  status               │
  ...                  │
                       │
DevelopmentApplication (研发申请表)
  id (主键)            │
  applicationNo        │
  componentVersionId ──┘ (外键，关联到 ComponentVersion.id)
  applicantId ──┐
  ...           │
                │
User (用户表)   │
  id (主键) ←───┘
  username
  realName
  ...
```

## 注意事项

### 1. 历史数据兼容

- 使用 `nullable: true` 确保旧版本（没有申请记录）不会报错
- 使用 `leftJoinAndSelect` 确保查询不会失败

### 2. 性能考虑

- 关联查询会增加数据库负担，但版本列表通常数据量不大
- 如果性能有问题，可以考虑：
  - 添加索引到 `componentVersionId` 字段
  - 使用分页限制每次查询的数据量
  - 前端按需加载申请详情

### 3. 循环引用问题

- TypeORM 会自动处理循环引用
- 如果序列化时遇到问题，可以使用 `@Exclude()` 装饰器排除某些字段

## 前端使用示例

### 显示版本列表

```typescript
// 获取版本列表
const response = await fetch('/api/components/BarChart/versions')
const { data } = await response.json()

// 渲染表格
data.forEach((version) => {
  console.log(`版本: ${version.version}`)
  console.log(`状态: ${version.status}`)

  if (version.developmentApplication) {
    console.log(`申请单号: ${version.developmentApplication.applicationNo}`)
    console.log(`申请人: ${version.developmentApplication.applicant.realName}`)
    console.log(`申请类型: ${version.developmentApplication.applicationType}`)
  } else {
    console.log('无关联申请（历史版本）')
  }
})
```

### 显示版本详情

```typescript
// 获取版本详情
const response = await fetch('/api/component-versions/1')
const { data: version } = await response.json()

// 显示申请信息
if (version.developmentApplication) {
  const app = version.developmentApplication

  // 显示申请流程
  console.log('申请流程：')
  console.log(`1. 提交申请: ${app.submittedAt}`)
  console.log(`2. 审核通过: ${app.reviewedAt}`)
  console.log(`3. 上传完成: ${app.completedAt}`)

  // 显示申请人信息
  console.log(`申请人: ${app.applicant.realName} (${app.applicant.username})`)
  console.log(`部门: ${app.applicant.department}`)
}
```

## 测试建议

### 1. 单元测试

- 测试有申请记录的版本查询
- 测试无申请记录的版本查询（历史数据）
- 测试关联数据的正确性

### 2. 集成测试

- 测试完整的上传流程（创建申请 → 上传 → 查询版本）
- 测试不同申请类型（NEW/VERSION/REPLACE）的版本关联

### 3. 性能测试

- 测试大量版本的查询性能
- 测试关联查询的响应时间

## 总结

此次修改为组件版本管理增加了研发申请信息的关联，实现了：

✅ 每个版本都能追溯到创建它的申请  
✅ 可以查看申请人、申请类型、审批时间等信息  
✅ 支持历史数据（无申请记录的版本）  
✅ 保持了数据结构的清晰和可维护性

**修改文件列表：**

1. `src/shared/entities/component-version.entity.ts` - 添加关联关系
2. `src/modules/components/services/component-versions.service.ts` - 更新查询逻辑
3. `src/modules/components/controllers/component-versions.controller.ts` - 更新接口注释

**数据库影响：**  
无需修改数据库结构，使用现有的 `componentVersionId` 外键字段即可。

**兼容性：**  
完全向后兼容，不影响现有功能。
