# ğŸš€ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æŒ‡å—

æœ¬æŒ‡å—ä»‹ç»å¦‚ä½•å°†é¡¹ç›®éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒã€‚

## ğŸ“‹ éƒ¨ç½²æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Nginx / è´Ÿè½½å‡è¡¡                â”‚
â”‚              (åå‘ä»£ç† + SSL ç»ˆæ­¢)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚                       â”‚
â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
â”‚  NestJS   â”‚         â”‚   NestJS    â”‚
â”‚  å®ä¾‹ 1   â”‚         â”‚   å®ä¾‹ 2    â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
      â”‚                      â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚                     â”‚
â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   MySQL   â”‚      â”‚     Redis      â”‚
â”‚  (ä¸»ä»)   â”‚      â”‚   (å“¨å…µæ¨¡å¼)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¯ éƒ¨ç½²å‰æ£€æŸ¥æ¸…å•

### ç¯å¢ƒå‡†å¤‡

- [ ] æœåŠ¡å™¨å‡†å¤‡ï¼ˆæ¨èé…ç½®ï¼š2C4G ä»¥ä¸Šï¼‰
- [ ] Docker å’Œ Docker Compose å·²å®‰è£…
- [ ] åŸŸåå’Œ SSL è¯ä¹¦å·²å‡†å¤‡
- [ ] é˜²ç«å¢™è§„åˆ™å·²é…ç½®ï¼ˆå¼€æ”¾å¿…è¦ç«¯å£ï¼‰
- [ ] æ•°æ®åº“å¤‡ä»½æ–¹æ¡ˆå·²ç¡®å®š

### å®‰å…¨æ£€æŸ¥

- [ ] å·²æ›´æ”¹æ‰€æœ‰é»˜è®¤å¯†ç 
- [ ] JWT_SECRET å·²è®¾ç½®ä¸ºå¼ºå¯†ç 
- [ ] æ•°æ®åº“è®¿é—®é™åˆ¶å·²é…ç½®
- [ ] Redis å¯†ç å·²è®¾ç½®
- [ ] æ•æ„Ÿä¿¡æ¯å·²ä»ä»£ç ä¸­ç§»é™¤

## ğŸ“¦ éƒ¨ç½²æ­¥éª¤

### 1. å‡†å¤‡æœåŠ¡å™¨ç¯å¢ƒ

```bash
# æ›´æ–°ç³»ç»Ÿ
sudo apt update && sudo apt upgrade -y

# å®‰è£… Docker
curl -fsSL https://get.docker.com | sh
sudo usermod -aG docker $USER

# å®‰è£… Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# éªŒè¯å®‰è£…
docker --version
docker-compose --version
```

### 2. å…‹éš†é¡¹ç›®å¹¶é…ç½®

```bash
# å…‹éš†é¡¹ç›®
git clone <repository-url> /opt/rbac-demo
cd /opt/rbac-demo

# åˆ›å»ºç”Ÿäº§ç¯å¢ƒé…ç½®
cp .env.example .env.production

# ç¼–è¾‘ç”Ÿäº§é…ç½®ï¼ˆé‡è¦ï¼ï¼‰
nano .env.production
```

ç”Ÿäº§ç¯å¢ƒé…ç½®ç¤ºä¾‹ï¼š

```env
# åº”ç”¨é…ç½®
NODE_ENV=production
PORT=3000
APP_NAME=RBAC-Demo

# JWT é…ç½®ï¼ˆå¿…é¡»æ›´æ”¹ï¼ï¼‰
JWT_SECRET=<ä½¿ç”¨å¼ºå¯†ç ï¼Œè‡³å°‘32ä½éšæœºå­—ç¬¦ä¸²>
JWT_EXPIRES_IN=2h

# æ•°æ®åº“é…ç½®
DATABASE_HOST=mysql
DATABASE_PORT=3306
DATABASE_USER=rbac_user
DATABASE_PASSWORD=<è®¾ç½®å¼ºå¯†ç >
DATABASE_NAME=rbac_demo

# Redis é…ç½®
REDIS_HOST=redis
REDIS_PORT=6379
REDIS_PASSWORD=<è®¾ç½®å¼ºå¯†ç >

# æ—¥å¿—é…ç½®
LOG_LEVEL=info
LOG_MAX_FILES=30
```

### 3. é…ç½® Docker Composeï¼ˆç”Ÿäº§ç‰ˆï¼‰

åˆ›å»º `docker-compose.prod.yml`ï¼š

```yaml
version: '3.8'

services:
  # MySQL æ•°æ®åº“
  mysql:
    image: mysql:8.0
    container_name: rbac-prod-mysql
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${DATABASE_ROOT_PASSWORD}
      MYSQL_DATABASE: ${DATABASE_NAME}
      MYSQL_USER: ${DATABASE_USER}
      MYSQL_PASSWORD: ${DATABASE_PASSWORD}
      TZ: Asia/Shanghai
    volumes:
      - /data/mysql:/var/lib/mysql
    ports:
      - '127.0.0.1:3306:3306' # åªå…è®¸æœ¬åœ°è®¿é—®
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --max_connections=1000
      - --innodb_buffer_pool_size=1G
    healthcheck:
      test: ['CMD', 'mysqladmin', 'ping', '-h', 'localhost']
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis ç¼“å­˜
  redis:
    image: redis:7-alpine
    container_name: rbac-prod-redis
    restart: always
    command: redis-server --requirepass ${REDIS_PASSWORD} --maxmemory 512mb --maxmemory-policy allkeys-lru
    volumes:
      - /data/redis:/data
    ports:
      - '127.0.0.1:6379:6379' # åªå…è®¸æœ¬åœ°è®¿é—®
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 10s
      timeout: 5s
      retries: 5

  # NestJS åº”ç”¨
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: rbac-prod-app
    restart: always
    env_file:
      - .env.production
    ports:
      - '3000:3000'
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - /data/logs:/app/logs
    healthcheck:
      test: ['CMD', 'wget', '--quiet', '--tries=1', '--spider', 'http://localhost:3000/api/health']
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  default:
    name: rbac-prod-network
```

### 4. åˆ›å»º Dockerfile

```dockerfile
# å¤šé˜¶æ®µæ„å»º
FROM node:18-alpine AS builder

WORKDIR /app

# å¤åˆ¶ package æ–‡ä»¶
COPY package*.json pnpm-lock.yaml ./

# å®‰è£… pnpm å¹¶å®‰è£…ä¾èµ–
RUN npm install -g pnpm && pnpm install --frozen-lockfile

# å¤åˆ¶æºä»£ç 
COPY . .

# æ„å»ºé¡¹ç›®
RUN pnpm run build

# ç”Ÿäº§é•œåƒ
FROM node:18-alpine

WORKDIR /app

# å®‰è£… pnpm
RUN npm install -g pnpm

# ä»æ„å»ºé˜¶æ®µå¤åˆ¶æ–‡ä»¶
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/package*.json ./

# åˆ›å»ºæ—¥å¿—ç›®å½•
RUN mkdir -p /app/logs && chown -R node:node /app

# ä½¿ç”¨é root ç”¨æˆ·
USER node

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
  CMD wget --quiet --tries=1 --spider http://localhost:3000/api/health || exit 1

EXPOSE 3000

CMD ["node", "dist/main"]
```

### 5. åˆå§‹åŒ–æ•°æ®åº“

**é‡è¦ï¼š** é€‰æ‹©ä»¥ä¸‹æ–¹å¼ä¹‹ä¸€åˆå§‹åŒ–æ•°æ®åº“ï¼š

#### æ–¹å¼ä¸€ï¼šä½¿ç”¨ Seed è„šæœ¬ï¼ˆæ¨èï¼‰â­

```bash
# 1. å…ˆå¯åŠ¨æ•°æ®åº“æœåŠ¡
docker-compose -f docker-compose.prod.yml up -d mysql redis

# 2. ç­‰å¾…æ•°æ®åº“å®Œå…¨å¯åŠ¨ï¼ˆçº¦15ç§’ï¼‰
sleep 15

# 3. ä¸´æ—¶å¯åŠ¨åº”ç”¨å®¹å™¨æ‰§è¡Œ seed
docker-compose -f docker-compose.prod.yml run --rm app npm run seed

# 4. æˆ–è€…å¦‚æœåº”ç”¨å·²å¯åŠ¨ï¼Œç›´æ¥è¿›å…¥å®¹å™¨æ‰§è¡Œ
docker exec rbac-prod-app npm run seed
```

**ä¼˜åŠ¿ï¼š**

- âœ… TypeORM è‡ªåŠ¨åˆ›å»ºè¡¨ç»“æ„ï¼ˆsynchronize: true in developmentï¼‰
- âœ… è‡ªåŠ¨æ’å…¥åˆå§‹æ•°æ®
- âœ… æ”¯æŒæ•°æ®æ›´æ–°
- âœ… **ç”Ÿäº§ç¯å¢ƒæ¨è**

#### æ–¹å¼äºŒï¼šæ‰‹åŠ¨æ‰§è¡Œ SQL è„šæœ¬

```bash
# 1. å¯åŠ¨æ•°æ®åº“
docker-compose -f docker-compose.prod.yml up -d mysql

# 2. ç­‰å¾…æ•°æ®åº“å¯åŠ¨
sleep 15

# 3. æ‰§è¡Œ SQL è„šæœ¬
docker exec -i rbac-prod-mysql mysql -uroot -p${DATABASE_ROOT_PASSWORD} < init.sql
```

**é€‚ç”¨åœºæ™¯ï¼š**

- âš ï¸ éœ€è¦å®Œå…¨æ§åˆ¶è¡¨ç»“æ„
- âš ï¸ ç”Ÿäº§ç¯å¢ƒä¸æƒ³ä½¿ç”¨ synchronize
- âš ï¸ é¦–æ¬¡éƒ¨ç½²æ—¶ä½¿ç”¨

**æ³¨æ„ï¼š** ç”Ÿäº§ç¯å¢ƒå»ºè®®åœ¨ database.config.ts ä¸­è®¾ç½® `synchronize: false`ï¼Œä½¿ç”¨ TypeORM migrations ç®¡ç†æ•°æ®åº“å˜æ›´ã€‚

### 6. å¯åŠ¨åº”ç”¨

```bash
# æ„å»ºå¹¶å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose -f docker-compose.prod.yml up -d --build

# æŸ¥çœ‹æ—¥å¿—
docker-compose -f docker-compose.prod.yml logs -f app

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
docker-compose -f docker-compose.prod.yml ps
```

### 7. é…ç½® Nginx åå‘ä»£ç†

åˆ›å»º `/etc/nginx/sites-available/rbac-demo`ï¼š

```nginx
upstream rbac_backend {
    server 127.0.0.1:3000;
    keepalive 64;
}

server {
    listen 80;
    server_name your-domain.com;

    # é‡å®šå‘åˆ° HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com;

    # SSL è¯ä¹¦é…ç½®
    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    # æ—¥å¿—
    access_log /var/log/nginx/rbac-demo-access.log;
    error_log /var/log/nginx/rbac-demo-error.log;

    # å®¢æˆ·ç«¯ä¸Šä¼ å¤§å°é™åˆ¶
    client_max_body_size 10M;

    # åå‘ä»£ç†é…ç½®
    location / {
        proxy_pass http://rbac_backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;

        # è¶…æ—¶è®¾ç½®
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # å¥åº·æ£€æŸ¥ç«¯ç‚¹ï¼ˆä¸è®°å½•æ—¥å¿—ï¼‰
    location /api/health {
        proxy_pass http://rbac_backend;
        access_log off;
    }
}
```

å¯ç”¨ç«™ç‚¹ï¼š

```bash
# åˆ›å»ºè½¯é“¾æ¥
sudo ln -s /etc/nginx/sites-available/rbac-demo /etc/nginx/sites-enabled/

# æµ‹è¯•é…ç½®
sudo nginx -t

# é‡è½½ Nginx
sudo systemctl reload nginx
```

## ğŸ”’ å®‰å…¨åŠ å›º

### 1. ä¿®æ”¹é»˜è®¤å¯†ç 

```bash
# ç”Ÿæˆå¼ºå¯†ç 
openssl rand -base64 32

# æ›´æ–° .env.production ä¸­çš„æ‰€æœ‰å¯†ç 
```

### 2. é…ç½®é˜²ç«å¢™

```bash
# å…è®¸å¿…è¦ç«¯å£
sudo ufw allow 22/tcp    # SSH
sudo ufw allow 80/tcp    # HTTP
sudo ufw allow 443/tcp   # HTTPS

# æ‹’ç»ç›´æ¥è®¿é—®æ•°æ®åº“å’Œ Redis
sudo ufw deny 3306/tcp
sudo ufw deny 6379/tcp

# å¯ç”¨é˜²ç«å¢™
sudo ufw enable
```

### 3. æ•°æ®åº“å®‰å…¨

```bash
# ç¦ç”¨ root è¿œç¨‹ç™»å½•
docker exec rbac-prod-mysql mysql -uroot -p${DATABASE_ROOT_PASSWORD} -e "
  DELETE FROM mysql.user WHERE User='root' AND Host NOT IN ('localhost', '127.0.0.1', '::1');
  FLUSH PRIVILEGES;
"
```

## ğŸ“Š ç›‘æ§å’Œç»´æŠ¤

### å¥åº·æ£€æŸ¥

```bash
# æ£€æŸ¥åº”ç”¨å¥åº·çŠ¶æ€
curl https://your-domain.com/api/health

# æ£€æŸ¥ Docker å®¹å™¨çŠ¶æ€
docker-compose -f docker-compose.prod.yml ps
```

### æ—¥å¿—ç®¡ç†

```bash
# æŸ¥çœ‹åº”ç”¨æ—¥å¿—
docker logs rbac-prod-app --tail=100 -f

# æŸ¥çœ‹ Nginx æ—¥å¿—
sudo tail -f /var/log/nginx/rbac-demo-access.log
sudo tail -f /var/log/nginx/rbac-demo-error.log

# æ—¥å¿—è½®è½¬é…ç½®ï¼ˆ/etc/logrotate.d/rbac-demoï¼‰
/data/logs/*.log {
    daily
    rotate 30
    compress
    delaycompress
    notifempty
    create 0640 node node
    sharedscripts
    postrotate
        docker exec rbac-prod-app kill -USR1 1
    endscript
}
```

### æ•°æ®åº“å¤‡ä»½

```bash
# åˆ›å»ºå¤‡ä»½è„šæœ¬ /opt/rbac-demo/backup.sh
#!/bin/bash
BACKUP_DIR="/data/backups/mysql"
DATE=$(date +%Y%m%d_%H%M%S)

mkdir -p $BACKUP_DIR

docker exec rbac-prod-mysql mysqldump -uroot -p${DATABASE_ROOT_PASSWORD} rbac_demo | gzip > $BACKUP_DIR/rbac_demo_$DATE.sql.gz

# åªä¿ç•™æœ€è¿‘ 30 å¤©çš„å¤‡ä»½
find $BACKUP_DIR -name "*.sql.gz" -mtime +30 -delete

echo "Backup completed: rbac_demo_$DATE.sql.gz"

# æ·»åŠ æ‰§è¡Œæƒé™
chmod +x /opt/rbac-demo/backup.sh

# æ·»åŠ åˆ° crontabï¼ˆæ¯å¤©å‡Œæ™¨2ç‚¹å¤‡ä»½ï¼‰
crontab -e
# æ·»åŠ ï¼š0 2 * * * /opt/rbac-demo/backup.sh >> /var/log/rbac-backup.log 2>&1
```

### æ€§èƒ½ç›‘æ§

ä½¿ç”¨ PM2 ç®¡ç†è¿›ç¨‹ï¼ˆå¯é€‰ï¼‰ï¼š

```bash
# å®‰è£… PM2
npm install -g pm2

# ä½¿ç”¨ PM2 å¯åŠ¨åº”ç”¨
pm2 start npm --name "rbac-demo" -- run start:prod

# æŸ¥çœ‹ç›‘æ§
pm2 monit

# å¼€æœºè‡ªå¯
pm2 startup
pm2 save
```

## ğŸ”„ æ›´æ–°éƒ¨ç½²

```bash
# 1. æ‹‰å–æœ€æ–°ä»£ç 
cd /opt/rbac-demo
git pull

# 2. å¤‡ä»½æ•°æ®åº“
docker exec rbac-prod-mysql mysqldump -uroot -p${DATABASE_ROOT_PASSWORD} rbac_demo > backup_before_update.sql

# 3. é‡æ–°æ„å»ºå¹¶å¯åŠ¨
docker-compose -f docker-compose.prod.yml up -d --build

# 4. æŸ¥çœ‹æ—¥å¿—ç¡®è®¤å¯åŠ¨æˆåŠŸ
docker-compose -f docker-compose.prod.yml logs -f app
```

## ğŸ†˜ æ•…éšœæ’æŸ¥

### åº”ç”¨æ— æ³•å¯åŠ¨

```bash
# æ£€æŸ¥ç¯å¢ƒå˜é‡
docker exec rbac-prod-app env | grep DATABASE

# æ£€æŸ¥æ•°æ®åº“è¿æ¥
docker exec rbac-prod-mysql mysql -uroot -p${DATABASE_ROOT_PASSWORD} -e "SELECT 1"

# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
docker logs rbac-prod-app --tail=200
```

### æ•°æ®åº“è¿æ¥é—®é¢˜

```bash
# æµ‹è¯•æ•°æ®åº“è¿æ¥
docker exec rbac-prod-app ping mysql

# æ£€æŸ¥æ•°æ®åº“ç”¨æˆ·æƒé™
docker exec rbac-prod-mysql mysql -uroot -p${DATABASE_ROOT_PASSWORD} -e "SHOW GRANTS FOR '${DATABASE_USER}'@'%'"
```

### æ€§èƒ½é—®é¢˜

```bash
# æŸ¥çœ‹èµ„æºä½¿ç”¨
docker stats rbac-prod-app rbac-prod-mysql rbac-prod-redis

# æŸ¥çœ‹æ…¢æŸ¥è¯¢
docker exec rbac-prod-mysql mysql -uroot -p${DATABASE_ROOT_PASSWORD} -e "SHOW VARIABLES LIKE 'slow_query%'"
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å¿«é€Ÿå¼€å§‹](./å¿«é€Ÿå¼€å§‹.md)
- [é¡¹ç›®ç»“æ„](./é¡¹ç›®ç»“æ„.md)
- [API æ–‡æ¡£](./APIæ¥å£.md)
- [å¼€å‘æŒ‡å—](./å¼€å‘æŒ‡å—.md)
