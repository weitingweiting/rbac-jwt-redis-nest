# 组件管理模块 - 下一步计划

> **文档版本**: v1.0
> **创建日期**: 2025-12-20
> **最后更新**: 2025-12-20

---

## 📊 当前进度总览

### ✅ 已完成（40%）

#### 核心基础设施

- ✅ 模块架构：ComponentsModule 完整搭建
- ✅ 数据模型：3 表设计（Component、ComponentVersion、ComponentCategory）
- ✅ 权限集成：RBAC 守卫（component.read/create/delete）
- ✅ 文件存储：OSS 集成（components/{id}/{version}/）

#### 组件上传功能

- ✅ **ZIP 处理工具**（ZipUtil）
  - 过滤 macOS 系统文件（\_\_MACOSX、.DS_Store）
  - 移除第一层目录前缀（dist/ → 空）
  - 灵活的文件查找逻辑
- ✅ **上传流程**（ComponentUploadService）
  - 文件验证（大小、类型、结构）
  - component.meta.json 解析
  - 版本状态检查（draft 可覆盖，published 不可覆盖）
  - OSS 上传（无 dist/ 前缀）
  - 数据库操作（创建/更新组件和版本）
- ✅ **版本管理服务**（ComponentVersionsService）
  - 创建、更新、发布、删除版本
  - 设置推荐版本（is_latest）
  - 版本计数维护

- ✅ **API 端点**（ComponentsController）
  - `GET /api/components` - 列表查询
  - `GET /api/components/:componentId` - 详情查询
  - `POST /api/components/upload` - 上传 ZIP
  - `DELETE /api/components/:componentId` - 删除组件

- ✅ **测试覆盖**
  - 16 个 Bruno API 测试文件
  - 完整流程测试（上传→查询→删除）

---

## ❌ 待实现功能（60%）

### 🔴 高优先级（必需）

#### 1️⃣ 组件版本 API（20%工作量）

**缺失原因**：Controller 未创建
**影响范围**：无法发布版本、设置推荐版本、查询版本列表

**需实现接口**：

| 接口                                            | 方法   | 说明     | Service 状态 |
| ----------------------------------------------- | ------ | -------- | ------------ |
| `/api/components/:componentId/versions`         | GET    | 版本列表 | ✅ 已实现    |
| `/api/component-versions/:versionId`            | GET    | 版本详情 | ✅ 已实现    |
| `/api/component-versions/:versionId/publish`    | POST   | 发布版本 | ✅ 已实现    |
| `/api/component-versions/:versionId/set-latest` | POST   | 设为推荐 | ✅ 已实现    |
| `/api/component-versions/:versionId`            | DELETE | 删除版本 | ✅ 已实现    |

**预估时间**：4-5 小时（Controller + 测试）

---

#### 2️⃣ 组件分类 API（15%工作量）

**缺失原因**：Controller 和部分 Service 方法未实现
**影响范围**：无法管理组件分类树（前端上传时需选择分类）

**需实现接口**：

| 接口                             | 方法   | 说明     | Service 状态 |
| -------------------------------- | ------ | -------- | ------------ |
| `/api/component-categories/tree` | GET    | 分类树   | ❌ 需实现    |
| `/api/component-categories`      | POST   | 创建分类 | ❌ 需实现    |
| `/api/component-categories/:id`  | PUT    | 更新分类 | ❌ 需实现    |
| `/api/component-categories/:id`  | DELETE | 删除分类 | ❌ 需实现    |

**技术要点**：

- 树形结构查询（递归或 CTE）
- 父子关系验证
- 级联删除检查

**预估时间**：6-7 小时（Service + Controller + 测试）

---

### 🟡 中优先级（增强）

#### 3️⃣ 组件使用统计（10%工作量）

**功能描述**：统计组件被项目使用的次数

**实现方案**：

```sql
SELECT component_id, version, COUNT(*) as usage_count
FROM project_assets
WHERE asset_type = 'component'
GROUP BY component_id, version
```

**API 设计**：

- `GET /api/components/:componentId/statistics`
- 返回：总使用次数、各版本使用分布、最近使用项目

**预估时间**：3 小时

---

#### 4️⃣ 版本对比（5%工作量）

**功能描述**：展示两个版本之间的差异

**实现方案**：

- 读取两个版本的 `asset_manifest`
- 对比文件列表、文件大小、依赖变化
- 返回新增、删除、修改的文件

**API 设计**：

- `GET /api/component-versions/compare?v1={versionId1}&v2={versionId2}`

**预估时间**：4 小时

---

#### 5️⃣ 批量操作（5%工作量）

**功能描述**：批量发布版本、批量删除组件

**API 设计**：

- `POST /api/component-versions/batch-publish` - 批量发布
- `DELETE /api/components/batch-delete` - 批量删除

**预估时间**：3 小时

---

### 🟢 低优先级（高级特性）

| 功能                 | 工作量 | 预估时间 | 优先级 |
| -------------------- | ------ | -------- | ------ |
| 组件依赖分析         | 5%     | 8h       | P2     |
| 安全扫描（代码审计） | 7%     | 10h      | P2     |
| 组件预览服务         | 8%     | 12h      | P2     |
| Redis 缓存优化       | 3%     | 4h       | P2     |

---

## 🚀 行动计划（推荐顺序）

### 第一阶段：核心功能补全（1-2 周）

**目标**：完成版本管理和分类管理的完整 CRUD

| 步骤 | 任务                                 | 预估时间 | 负责人 |
| ---- | ------------------------------------ | -------- | ------ |
| 1    | 创建 `ComponentVersionsController`   | 1h       | -      |
| 2    | 实现版本列表/详情接口                | 1h       | -      |
| 3    | 实现发布版本接口                     | 1h       | -      |
| 4    | 实现设置推荐/删除版本接口            | 1h       | -      |
| 5    | 编写 Bruno 测试文件（5个）           | 2h       | -      |
| 6    | 补充 `ComponentCategoriesService`    | 3h       | -      |
| 7    | 创建 `ComponentCategoriesController` | 2h       | -      |
| 8    | 编写 Bruno 测试文件（4个）           | 2h       | -      |

**里程碑**：✅ 组件模块核心 API 完整（11 个端点）

---

### 第二阶段：功能增强（1 周）

**目标**：提升用户体验和运营效率

| 步骤 | 任务             | 预估时间 |
| ---- | ---------------- | -------- |
| 1    | 实现组件使用统计 | 3h       |
| 2    | 实现版本对比功能 | 4h       |
| 3    | 实现批量操作接口 | 3h       |

**里程碑**：✅ 管理后台功能完善

---

### 第三阶段：高级特性（按需）

**目标**：提升安全性和开发体验

| 任务                 | 预估时间 | 依赖       |
| -------------------- | -------- | ---------- |
| 组件依赖分析         | 8h       | 无         |
| 安全扫描（代码审计） | 10h      | 无         |
| 组件预览服务         | 12h      | 独立服务   |
| Redis 缓存优化       | 4h       | Redis 集成 |

**里程碑**：✅ 企业级组件管理平台

---

## 🛠 技术债务

### 待优化项目

| 类别         | 问题               | 建议                                          | 优先级 |
| ------------ | ------------------ | --------------------------------------------- | ------ |
| **测试**     | 缺少单元测试       | 使用 Jest 补充 80% 覆盖率                     | P1     |
| **错误处理** | 缺少全局异常过滤器 | 创建 AllExceptionsFilter                      | P1     |
| **日志**     | 日志规范不完善     | 制定日志规范文档                              | P2     |
| **性能**     | 数据库索引缺失     | 对 component_id、version、status 添加复合索引 | P1     |
| **文档**     | 缺少 API 文档      | 使用 @nestjs/swagger 生成 OpenAPI 文档        | P2     |

---

## 📈 预期成果

### 完成后可用功能

- ✅ **完整组件生命周期管理**
  - 上传 → 审核 → 发布 → 推荐 → 归档
- ✅ **分类体系管理**
  - 多级分类树
  - 分类增删改查
- ✅ **版本控制**
  - 版本列表查询
  - 版本发布/回退
  - 推荐版本设置
- ✅ **运营数据**
  - 组件使用统计
  - 版本对比分析
- ✅ **批量操作**
  - 批量发布
  - 批量删除

---

## ⏱ 时间线

| 阶段        | 内容                | 预计时间 | 累计进度 |
| ----------- | ------------------- | -------- | -------- |
| ✅ 已完成   | 上传流程 + 基础 API | -        | 40%      |
| 🔄 第一阶段 | 版本管理 + 分类管理 | 1-2 周   | 75%      |
| 🔄 第二阶段 | 功能增强            | +1 周    | 90%      |
| 🔄 第三阶段 | 高级特性            | 按需迭代 | 100%     |

**预计总工期**：2-3 周完成核心功能（至 90%）

---

## 📝 下一步行动

### 立即开始（今日）

1. **创建 ComponentVersionsController**
   - 复制 ComponentsController 作为模板
   - 注入 ComponentVersionsService
   - 实现 5 个端点
   - 添加权限守卫（@RequirePermissions）

2. **编写测试文件**
   - 创建 `bruno-api-tests/ComponentVersions/` 目录
   - 编写 5 个测试文件（列表、详情、发布、推荐、删除）

### 本周完成

3. **实现 ComponentCategoriesService**
   - 树形结构查询方法
   - CRUD 基础方法

4. **创建 ComponentCategoriesController**
   - 实现 4 个端点
   - 树形结构响应处理

5. **编写测试文件**
   - 创建 `bruno-api-tests/ComponentCategories/` 目录
   - 编写 4 个测试文件

---

## 🤝 需要协作

### 前端对接

- **组件列表接口**：已完成，可对接
- **组件上传接口**：已完成，需前端实现文件上传 UI
- **版本管理接口**：待实现（第一阶段）
- **分类管理接口**：待实现（第一阶段）

### 产品需求确认

- [ ] 组件审核流程是否需要工作流引擎？（当前简化为 draft → published）
- [ ] 是否需要组件权限管理？（当前仅模块级权限）
- [ ] 是否需要组件使用统计报表？（当前仅基础统计）
- [ ] 版本回退策略？（当前仅支持删除）

---

**文档维护人**: GitHub Copilot
**下次更新**: 完成第一阶段后更新进度
