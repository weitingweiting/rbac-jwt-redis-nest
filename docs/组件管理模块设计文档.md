# ç»„ä»¶ç®¡ç†æ¨¡å—è®¾è®¡æ–‡æ¡£

## ä¸€ã€æ¨¡å—æ¦‚è¿°

### 1.1 ä¸šåŠ¡èƒŒæ™¯

ä½ä»£ç æ•æ·å¹³å°çš„æ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€æ˜¯ç»„ä»¶åŒ–å¼€å‘ã€‚å‰ç«¯é€šè¿‡ç”»å¸ƒæ‹–æ‹½æ–¹å¼ä½¿ç”¨è¿œç¨‹ç»„ä»¶ï¼Œè¿™äº›ç»„ä»¶ä»¥åº“æ¨¡å¼æ‰“åŒ…å¹¶å­˜å‚¨åœ¨ OSS æœåŠ¡ä¸Šã€‚åç«¯éœ€è¦æä¾›å®Œæ•´çš„ç»„ä»¶ç”Ÿå‘½å‘¨æœŸç®¡ç†èƒ½åŠ›ã€‚

### 1.2 æ ¸å¿ƒä»·å€¼

- **ç»„ä»¶èµ„äº§ç®¡ç†**ï¼šç»Ÿä¸€ç®¡ç†å¹³å°æ‰€æœ‰è¿œç¨‹ç»„ä»¶èµ„æº
- **ç‰ˆæœ¬æ§åˆ¶**ï¼šæ”¯æŒç»„ä»¶çš„å¤šç‰ˆæœ¬ç®¡ç†å’Œç°åº¦å‘å¸ƒ
- **åˆ†ç±»ä½“ç³»**ï¼šæä¾›æ¸…æ™°çš„ä¸¤çº§åˆ†ç±»ï¼Œä¾¿äºå‰ç«¯æ£€ç´¢å’Œå±•ç¤º
- **ç”Ÿå‘½å‘¨æœŸç®¡ç†**ï¼šæ”¯æŒç»„ä»¶çš„ä¸Šä¼ ã€å‘å¸ƒã€ä¸‹æ¶ã€åˆ é™¤ç­‰å…¨ç”Ÿå‘½å‘¨æœŸæ“ä½œ

### 1.3 æŠ€æœ¯æ¶æ„

- **åç«¯æ¡†æ¶**ï¼šNestJS + TypeORM + MySQL 8.0+
- **å­˜å‚¨æœåŠ¡**ï¼šé˜¿é‡Œäº‘ OSSï¼ˆå·²é›†æˆ `OSSService`ï¼‰
- **æƒé™æ§åˆ¶**ï¼šåŸºäºç°æœ‰ RBAC + JWT æƒé™ä½“ç³»
- **ç¼“å­˜ç­–ç•¥**ï¼šRedis ç¼“å­˜çƒ­é—¨ç»„ä»¶åˆ—è¡¨
- **ä»»åŠ¡é˜Ÿåˆ—**ï¼šBullMQï¼ˆç”¨äºå¼‚æ­¥å¤„ç†ç»„ä»¶ä¸Šä¼ ä»»åŠ¡ï¼‰
- **æ—¥å¿—ç³»ç»Ÿ**ï¼šWinstonï¼ˆç»Ÿä¸€æ—¥å¿—ç®¡ç†ï¼‰
- **å“åº”æ ¼å¼**ï¼šç»Ÿä¸€ä½¿ç”¨ `BaseResponseDto` å°è£…

---

## äºŒã€æ•°æ®æ¨¡å‹è®¾è®¡

### 2.1 ç»„ä»¶åˆ†ç±»è¡¨ (component_categories)

**è®¾è®¡è¯´æ˜**ï¼šæ­¤è¡¨ä½œä¸º**æšä¸¾é…ç½®è¡¨**å­˜åœ¨ï¼Œç”¨äºï¼š

1. **åå°åˆ†ç±»ç®¡ç†**ï¼šç®¡ç†å‘˜å¯åœ¨åå°é…ç½®å’Œç»´æŠ¤åˆ†ç±»ä½“ç³»
2. **æ ¡éªŒåˆ†ç±»æœ‰æ•ˆæ€§**ï¼šä¸Šä¼ ç»„ä»¶æ—¶æ ¡éªŒ `classification.level1` å’Œ `classification.level2` æ˜¯å¦ä¸ºæœ‰æ•ˆå€¼
3. **å‰ç«¯å±•ç¤º**ï¼šæä¾›åˆ†ç±»æ ‘ä¾›å‰ç«¯æ£€ç´¢å’Œå±•ç¤º

ç»„ä»¶é‡‡ç”¨ä¸¤çº§åˆ†ç±»ä½“ç³»ï¼š

```sql
-- ä¸€çº§åˆ†ç±»å’ŒäºŒçº§åˆ†ç±»ç»Ÿä¸€è¡¨ï¼ˆæšä¸¾é…ç½®è¡¨ï¼‰
CREATE TABLE `component_categories` (
  `id` INT PRIMARY KEY AUTO_INCREMENT,
  `code` VARCHAR(50) NOT NULL UNIQUE COMMENT 'åˆ†ç±»ç¼–ç ï¼Œå¦‚ï¼šchart, form, chart.bar, form.input',
  `name` VARCHAR(100) NOT NULL COMMENT 'åˆ†ç±»åç§°ï¼Œå¦‚ï¼šå›¾è¡¨ã€è¡¨å•ã€æŸ±çŠ¶å›¾ã€è¾“å…¥æ¡†',
  `level` TINYINT NOT NULL COMMENT 'åˆ†ç±»å±‚çº§ï¼š1=ä¸€çº§åˆ†ç±», 2=äºŒçº§åˆ†ç±»',
  `parent_id` INT DEFAULT NULL COMMENT 'çˆ¶åˆ†ç±»ID',
  `description` TEXT COMMENT 'åˆ†ç±»æè¿°',
  `icon` VARCHAR(255) DEFAULT NULL COMMENT 'åˆ†ç±»å›¾æ ‡URL',
  `sort_order` INT DEFAULT 0 COMMENT 'æ’åºåºå·',
  `is_active` TINYINT(1) DEFAULT 1 COMMENT 'æ˜¯å¦å¯ç”¨',
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  `updated_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `created_by` INT DEFAULT NULL COMMENT 'åˆ›å»ºäººID',
  `updated_by` INT DEFAULT NULL COMMENT 'æ›´æ–°äººID',
  FOREIGN KEY (`parent_id`) REFERENCES `component_categories`(`id`) ON DELETE CASCADE,
  FOREIGN KEY (`created_by`) REFERENCES `users`(`id`),
  FOREIGN KEY (`updated_by`) REFERENCES `users`(`id`),
  INDEX `idx_category_parent` (`parent_id`),
  INDEX `idx_category_level` (`level`),
  INDEX `idx_category_code` (`code`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='ç»„ä»¶åˆ†ç±»æšä¸¾é…ç½®è¡¨';
```

**åˆ†ç±»ç¤ºä¾‹**ï¼š

```
ä¸€çº§åˆ†ç±»ï¼š
- å›¾è¡¨ç±» (chart)
- è¡¨å•ç±» (form)
- å¸ƒå±€ç±» (layout)
- æ•°æ®å±•ç¤ºç±» (display)

äºŒçº§åˆ†ç±»ï¼š
- å›¾è¡¨ç±» > æŸ±çŠ¶å›¾ (chart.bar)
- å›¾è¡¨ç±» > æŠ˜çº¿å›¾ (chart.line)
- è¡¨å•ç±» > è¾“å…¥æ¡† (form.input)
- è¡¨å•ç±» > é€‰æ‹©å™¨ (form.select)
```

### 2.2 ç»„ä»¶ä¸»è¡¨ (components) - åŸºäº component.meta.json

```sql
CREATE TABLE components (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

  -- åŸºæœ¬ä¿¡æ¯ï¼ˆæ˜ å°„ component.meta.jsonï¼‰
  component_id VARCHAR(100) NOT NULL UNIQUE,  -- å¯¹åº” meta.json çš„ id å­—æ®µï¼ˆå¦‚ï¼šBarChartï¼‰
  name VARCHAR(100) NOT NULL,                 -- å¯¹åº” meta.json çš„ name å­—æ®µï¼ˆä¸­æ–‡åï¼šæŸ±çŠ¶å›¾ï¼‰
  description TEXT,                           -- æè¿°

  -- åˆ†ç±»ä¿¡æ¯ï¼ˆæ˜ å°„ classification å¯¹è±¡ï¼‰
  classification_level1 VARCHAR(50) NOT NULL, -- ä¸€çº§åˆ†ç±»æ ‡è¯†ï¼šchart/table/form
  classification_level2 VARCHAR(50) NOT NULL, -- äºŒçº§åˆ†ç±»æ ‡è¯†ï¼šbar/line/pie
  classification_level1_name VARCHAR(100) NOT NULL,    -- ä¸€çº§åˆ†ç±»æ˜¾ç¤ºåï¼šå›¾è¡¨
  classification_level2_name VARCHAR(100) NOT NULL,    -- äºŒçº§åˆ†ç±»æ˜¾ç¤ºåï¼šæŸ±çŠ¶å›¾

  -- æŠ€æœ¯ä¿¡æ¯
  type VARCHAR(50) NOT NULL,                  -- ç»„ä»¶æ¨¡æ¿ç±»å‹ï¼švue-echarts/vue-component/js
  framework VARCHAR(50) NOT NULL,             -- å¼€å‘æ¡†æ¶ï¼švue3/js

  -- ä½œè€…ä¿¡æ¯ï¼ˆæ˜ å°„ author å¯¹è±¡ï¼‰
  author_organization VARCHAR(200),           -- ç»„ç»‡åç§°ï¼šæ±Ÿè‹ç”µåŠ›å…¬å¸
  author_username VARCHAR(100),               -- ä½œè€…ç”¨æˆ·åï¼šweiting

  -- è®¸å¯è¯
  license VARCHAR(50),                        -- è®¸å¯è¯ï¼šMIT

  -- ç¼©ç•¥å›¾ï¼ˆç”¨äºåˆ—è¡¨å±•ç¤ºï¼Œä»æœ€æ–°ç‰ˆæœ¬çš„ preview æå–ï¼‰
  thumbnail_url VARCHAR(500),                 -- ç»„ä»¶ç¼©ç•¥å›¾URL

  -- çŠ¶æ€ç®¡ç†
  status VARCHAR(20) DEFAULT 'draft',         -- çŠ¶æ€ï¼šdraft(è‰ç¨¿), published(å·²å‘å¸ƒ), archived(å·²ä¸‹æ¶)
  is_official BOOLEAN DEFAULT false,          -- æ˜¯å¦å®˜æ–¹ç»„ä»¶

  -- ç»Ÿè®¡ä¿¡æ¯
  used_count INT DEFAULT 0,                   -- æ€»ä½¿ç”¨æ¬¡æ•°
  version_count INT DEFAULT 0,                -- ç‰ˆæœ¬æ•°é‡

  -- å®¡è®¡å­—æ®µ
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  created_by UUID REFERENCES users(id),
  updated_by UUID REFERENCES users(id)
);

-- ç´¢å¼•
CREATE INDEX idx_component_id ON components(component_id);
CREATE INDEX idx_component_classification ON components(classification_level1, classification_level2);
CREATE INDEX idx_component_status ON components(status);
CREATE INDEX idx_component_type ON components(type);
```

### 2.3 ç»„ä»¶ç‰ˆæœ¬è¡¨ (component_versions) - åŸºäº component.meta.json

æ¯ä¸ªç»„ä»¶æ”¯æŒå¤šç‰ˆæœ¬ç®¡ç†ï¼š

```sql
CREATE TABLE component_versions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  component_id UUID NOT NULL REFERENCES components(id) ON DELETE CASCADE,

  -- ç‰ˆæœ¬ä¿¡æ¯
  version VARCHAR(50) NOT NULL,               -- è¯­ä¹‰åŒ–ç‰ˆæœ¬å·ï¼š1.0.0

  -- æ–‡ä»¶ä¿¡æ¯ï¼ˆæ˜ å°„ files å¯¹è±¡ï¼‰
  entry_file VARCHAR(255) NOT NULL,           -- ä¸»å…¥å£æ–‡ä»¶ï¼šindex.esm.js
  style_file VARCHAR(255),                    -- æ ·å¼æ–‡ä»¶ï¼šstyle.css
  preview_file VARCHAR(255),                  -- é¢„è§ˆå›¾ï¼šassets/preview.png

  -- OSS è·¯å¾„
  oss_base_path VARCHAR(500) NOT NULL,        -- OSSåŸºç¡€è·¯å¾„ï¼šcomponents/BarChart/1.0.0/
  entry_url VARCHAR(500) NOT NULL,            -- ä¸»æ–‡ä»¶å®Œæ•´URL
  style_url VARCHAR(500),                     -- æ ·å¼æ–‡ä»¶å®Œæ•´URL
  preview_url VARCHAR(500),                   -- é¢„è§ˆå›¾å®Œæ•´URL

  -- æ„å»ºä¿¡æ¯ï¼ˆæ˜ å°„ buildInfo å¯¹è±¡ï¼‰
  build_time TIMESTAMP NOT NULL,              -- æ„å»ºæ—¶é—´
  build_hash VARCHAR(64) NOT NULL,            -- æ–‡ä»¶å“ˆå¸Œå€¼
  cli_version VARCHAR(50) NOT NULL,           -- CLIç‰ˆæœ¬å·

  -- æ–‡ä»¶å…ƒä¿¡æ¯
  file_size BIGINT,                           -- æ€»æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰
  assets_manifest JSONB,                      -- èµ„æºæ¸…å•ï¼ˆæ‰€æœ‰æ–‡ä»¶åˆ—è¡¨ï¼‰

  -- å®Œæ•´çš„ meta.json å†…å®¹ï¼ˆå¤‡ä»½ï¼‰
  meta_json JSONB NOT NULL,                   -- å®Œæ•´å­˜å‚¨åŸå§‹ component.meta.json

  -- çŠ¶æ€ç®¡ç†
  status VARCHAR(20) DEFAULT 'draft',         -- çŠ¶æ€ï¼šdraft/published/deprecated
  is_latest BOOLEAN DEFAULT false,            -- æ˜¯å¦æœ€æ–°ç‰ˆæœ¬
  is_stable BOOLEAN DEFAULT false,            -- æ˜¯å¦ç¨³å®šç‰ˆæœ¬

  -- å‘å¸ƒä¿¡æ¯
  published_at TIMESTAMP,                     -- å‘å¸ƒæ—¶é—´
  changelog TEXT,                             -- æ›´æ–°æ—¥å¿—

  -- å®¡è®¡å­—æ®µ
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  created_by UUID REFERENCES users(id),
  updated_by UUID REFERENCES users(id),

  UNIQUE(component_id, version)
);

-- ç´¢å¼•
CREATE INDEX idx_version_component ON component_versions(component_id);
CREATE INDEX idx_version_status ON component_versions(status);
CREATE INDEX idx_version_latest ON component_versions(is_latest) WHERE is_latest = true;
CREATE INDEX idx_version_build_time ON component_versions(build_time);
```

---

## ä¸‰ã€API æ¥å£è®¾è®¡

### 3.1 ç»„ä»¶åˆ†ç±»æ¥å£

#### 3.1.1 è·å–åˆ†ç±»æ ‘

```
GET /api/component-categories/tree
```

**å“åº”ç¤ºä¾‹**ï¼š

```json
{
  "code": 200,
  "data": [
    {
      "id": "uuid-1",
      "code": "chart",
      "name": "å›¾è¡¨",
      "level": 1,
      "icon": "https://oss.example.com/icons/chart.svg",
      "sortOrder": 1,
      "children": [
        {
          "id": "uuid-2",
          "code": "chart.bar",
          "name": "æŸ±çŠ¶å›¾",
          "level": 2,
          "icon": "https://oss.example.com/icons/bar-chart.svg",
          "sortOrder": 1,
          "componentCount": 5
        },
        {
          "id": "uuid-3",
          "code": "chart.line",
          "name": "æŠ˜çº¿å›¾",
          "level": 2,
          "sortOrder": 2,
          "componentCount": 3
        }
      ]
    }
  ]
}
```

#### 3.1.2 åˆ›å»º/æ›´æ–°/åˆ é™¤åˆ†ç±»

```
POST   /api/component-categories
PUT    /api/component-categories/:id
DELETE /api/component-categories/:id
```

### 3.2 ç»„ä»¶ç®¡ç†æ¥å£

#### 3.2.1 è·å–ç»„ä»¶åˆ—è¡¨ï¼ˆæ ¸å¿ƒæ¥å£ - ä¾›å‰ç«¯ç”»å¸ƒä½¿ç”¨ï¼‰

```
GET /api/components
```

**æŸ¥è¯¢å‚æ•°**ï¼š

- `categoryId`: åˆ†ç±»IDè¿‡æ»¤
- `status`: çŠ¶æ€è¿‡æ»¤ï¼ˆpublished, draft, archivedï¼‰
- `keyword`: å…³é”®è¯æœç´¢
- `tags`: æ ‡ç­¾è¿‡æ»¤ï¼ˆå¤šä¸ªç”¨é€—å·åˆ†éš”ï¼‰
- `isOfficial`: æ˜¯å¦å®˜æ–¹ç»„ä»¶
- `page`: é¡µç 
- `pageSize`: æ¯é¡µæ•°é‡
- `sortBy`: æ’åºå­—æ®µï¼ˆdownloadCount, usedCount, createdAtï¼‰
- `sortOrder`: æ’åºæ–¹å‘ï¼ˆASC, DESCï¼‰

**å“åº”ç¤ºä¾‹**ï¼š

```json
{
  "code": 200,
  "data": {
    "items": [
      {
        "id": "uuid-1",
        "name": "BarChart",
        "displayName": "æŸ±çŠ¶å›¾",
        "description": "æ”¯æŒå¤šç»´åº¦æ•°æ®å±•ç¤ºçš„æŸ±çŠ¶å›¾ç»„ä»¶",
        "category": {
          "id": "uuid-2",
          "name": "æŸ±çŠ¶å›¾",
          "code": "chart.bar",
          "parent": {
            "name": "å›¾è¡¨",
            "code": "chart"
          }
        },
        "packageName": "@platform/bar-chart",
        "thumbnail": "https://oss.example.com/components/bar-chart/thumb.png",
        "previewImage": "https://oss.example.com/components/bar-chart/preview.png",
        "tags": ["å›¾è¡¨", "æ•°æ®å¯è§†åŒ–", "ç»Ÿè®¡"],
        "isOfficial": true,
        "status": "published",
        "usedCount": 89,
        "latestVersion": {
          "id": "version-uuid-1",
          "version": "2.1.0",
          "mainJsUrl": "https://oss.example.com/components/bar-chart/2.1.0/index.js",
          "mainCssUrl": "https://oss.example.com/components/bar-chart/2.1.0/index.css",
          "fileSize": 45678,
          "publishedAt": "2025-12-15T10:00:00Z"
        },
        "createdAt": "2025-10-01T08:00:00Z",
        "updatedAt": "2025-12-15T10:00:00Z"
      }
    ],
    "total": 45,
    "page": 1,
    "pageSize": 20
  }
}
```

#### 3.2.2 è·å–ç»„ä»¶è¯¦æƒ…

```
GET /api/components/:id
```

**å“åº”åŒ…å«**ï¼š

- ç»„ä»¶å®Œæ•´ä¿¡æ¯
- æ‰€æœ‰ç‰ˆæœ¬åˆ—è¡¨
- å±æ€§Schema
- ä½¿ç”¨ç»Ÿè®¡

#### 3.2.3 åˆ›å»ºç»„ä»¶ï¼ˆå¯é€‰ï¼Œä¹Ÿå¯ç›´æ¥ä¸Šä¼ ï¼‰

å¦‚æœéœ€è¦é¢„å…ˆåˆ›å»ºç»„ä»¶ï¼ˆä¸åŒ…å«ç‰ˆæœ¬ï¼‰ï¼Œå¯ä»¥ä½¿ç”¨æ­¤æ¥å£ï¼š

```
POST /api/components
```

**è¯·æ±‚ä½“**ï¼š

```json
{
  "name": "BarChart",
  "displayName": "æŸ±çŠ¶å›¾",
  "description": "æ”¯æŒå¤šç»´åº¦æ•°æ®å±•ç¤ºçš„æŸ±çŠ¶å›¾ç»„ä»¶",
  "categoryId": "uuid-2",
  "packageName": "@platform/bar-chart",
  "tags": ["å›¾è¡¨", "æ•°æ®å¯è§†åŒ–"],
  "author": "å¼ ä¸‰"
}
```

**æ³¨æ„**ï¼šå¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ä¸Šä¼ æ¥å£ï¼ˆ3.2.4ï¼‰ï¼Œç»„ä»¶ä¼šæ ¹æ® `component.json` è‡ªåŠ¨åˆ›å»ºã€‚

#### 3.2.4 ä¸Šä¼ ç»„ä»¶åŒ…ï¼ˆStep 2: ä¸Šä¼ å¹¶æ ¡éªŒï¼‰

**æ¨èæ–¹æ¡ˆï¼šå…ˆä¸Šä¼ åˆ° Nest æœåŠ¡å™¨ï¼Œæ ¡éªŒé€šè¿‡åè½¬å­˜ OSS**

```
POST /api/components/upload
Content-Type: multipart/form-data
```

**è¯·æ±‚å‚æ•°**ï¼š

- `file`: ç»„ä»¶å‹ç¼©åŒ…ï¼ˆ.zip æ ¼å¼ï¼Œå¿…éœ€ï¼‰
- `isUpdate`: æ˜¯å¦æ›´æ–°ç°æœ‰ç»„ä»¶ï¼ˆå¯é€‰ï¼Œé»˜è®¤ falseï¼‰
- `componentId`: ç»„ä»¶ IDï¼ˆæ›´æ–°æ—¶å¿…éœ€ï¼‰

**å¤„ç†æµç¨‹**ï¼š

1. **æ¥æ”¶æ–‡ä»¶**ï¼šåç«¯æ¥æ”¶ä¸Šä¼ çš„ç»„ä»¶åŒ…
2. **è§£å‹æ ¡éªŒ**ï¼šè§£å‹åˆ°ä¸´æ—¶ç›®å½•
3. **è¯»å–æè¿°æ–‡ä»¶**ï¼šè§£æ `component.json`
4. **æ ¼å¼æ ¡éªŒ**ï¼š
   - æ£€æŸ¥å¿…éœ€å­—æ®µæ˜¯å¦å®Œæ•´
   - éªŒè¯ç‰ˆæœ¬å·æ ¼å¼ï¼ˆsemverï¼‰
   - éªŒè¯åˆ†ç±»ç¼–ç æ˜¯å¦å­˜åœ¨
   - éªŒè¯æ–‡ä»¶è·¯å¾„æ˜¯å¦æ­£ç¡®
5. **æ–‡ä»¶æ ¡éªŒ**ï¼š
   - æ£€æŸ¥æ–‡ä»¶ç±»å‹ç™½åå•
   - æ£€æŸ¥æ–‡ä»¶å¤§å°é™åˆ¶
   - æ‰«ææ¶æ„ä»£ç 
   - éªŒè¯å›¾ç‰‡æ ¼å¼
6. **ç»„ä»¶åå†²çªæ£€æŸ¥**ï¼š
   - æ–°å»ºï¼šæ£€æŸ¥ name æ˜¯å¦å·²å­˜åœ¨
   - æ›´æ–°ï¼šæ£€æŸ¥ version æ˜¯å¦å·²å­˜åœ¨
7. **è®¡ç®—æ–‡ä»¶å“ˆå¸Œ**ï¼šä¸ºæ¯ä¸ªæ–‡ä»¶ç”Ÿæˆ SHA-256 å“ˆå¸Œ
8. **ä¸Šä¼ åˆ° OSS**ï¼šå°†æ‰€æœ‰æ–‡ä»¶ä¸Šä¼ åˆ°å¯¹åº”ç›®å½•
9. **ç”Ÿæˆ manifest.json**ï¼šåˆ›å»ºèµ„æºæ¸…å•æ–‡ä»¶
10. **åˆ›å»ºæ•°æ®åº“è®°å½•**ï¼šåˆ›å»º/æ›´æ–°ç»„ä»¶å’Œç‰ˆæœ¬è®°å½•
11. **è¿”å›ç»“æœ**

**å“åº”ç¤ºä¾‹**ï¼ˆä½¿ç”¨ `BaseResponseDto` å°è£…ï¼‰ï¼š

```json
{
  "success": true,
  "message": "ç»„ä»¶ä¸Šä¼ æˆåŠŸ",
  "timestamp": "2025-12-20T10:00:00.000Z",
  "data": {
    "component": {
      "id": "component-uuid-1",
      "name": "BarChart",
      "displayName": "æŸ±çŠ¶å›¾",
      "status": "draft"
    },
    "version": {
      "id": "version-uuid-1",
      "version": "1.0.0",
      "status": "draft",
      "ossPath": "components/bar-chart/1.0.0/",
      "mainJsUrl": "https://oss.example.com/components/bar-chart/1.0.0/index.js",
      "mainCssUrl": "https://oss.example.com/components/bar-chart/1.0.0/index.css",
      "fileSize": 58023,
      "createdAt": "2025-12-20T10:00:00Z"
    },
    "validation": {
      "passed": true,
      "warnings": ["æœªæä¾› README.md æ–‡æ¡£", "å»ºè®®æ·»åŠ  propsSchema ä»¥æ”¯æŒå±æ€§æç¤º"]
    }
  }
}
```

**é”™è¯¯å“åº”ç¤ºä¾‹**ï¼š

```json
{
  "code": 400,
  "message": "ç»„ä»¶åŒ…æ ¡éªŒå¤±è´¥",
  "errors": [
    {
      "field": "component.json",
      "message": "ç¼ºå°‘å¿…éœ€å­—æ®µ: displayName"
    },
    {
      "field": "index.js",
      "message": "æ£€æµ‹åˆ°å±é™©å‡½æ•°è°ƒç”¨: eval()"
    },
    {
      "field": "version",
      "message": "ç‰ˆæœ¬ 1.0.0 å·²å­˜åœ¨"
    },
    {
      "field": "thumbnail.png",
      "message": "æ–‡ä»¶å¤§å°è¶…è¿‡é™åˆ¶ï¼ˆæœ€å¤§ 2MBï¼‰"
    }
  ]
}
```

#### 3.2.5 ä¸‹æ¶ç»„ä»¶

```
POST /api/components/:id/archive
```

**è¯´æ˜**ï¼šç»„ä»¶ä¿¡æ¯ï¼ˆåç§°ã€åˆ†ç±»ã€æè¿°ç­‰ï¼‰å®Œå…¨ç”± `component.meta.json` å†³å®šï¼Œä¸æä¾›ç‹¬ç«‹çš„æ›´æ–°æ¥å£ã€‚è¦ä¿®æ”¹ç»„ä»¶ä¿¡æ¯ï¼Œè¯·ä¿®æ”¹æœ¬åœ°ä»£ç å’Œ meta.jsonï¼Œé‡æ–°æ‰“åŒ…ä¸Šä¼ æ–°ç‰ˆæœ¬ã€‚

#### 3.2.6 åˆ é™¤ç»„ä»¶

```
DELETE /api/components/:id
```

**åˆ é™¤ç­–ç•¥**ï¼š

- è½¯åˆ é™¤ï¼šä»…æ ‡è®°ä¸ºå·²åˆ é™¤ï¼Œä¿ç•™æ•°æ®ï¼ˆæ¨èï¼‰
- ç¡¬åˆ é™¤ï¼šéœ€è¦å…ˆæ£€æŸ¥æ˜¯å¦æœ‰é¡¹ç›®åœ¨ä½¿ç”¨ï¼Œå¦‚æœ‰åˆ™ä¸å…è®¸åˆ é™¤

### 3.3 ç»„ä»¶ç‰ˆæœ¬æ¥å£

#### 3.3.1 è·å–ç»„ä»¶ç‰ˆæœ¬åˆ—è¡¨

```
GET /api/components/:componentId/versions
```

#### 3.3.2 è·å–ç‰ˆæœ¬è¯¦æƒ…

```
GET /api/component-versions/:versionId
```

#### 3.3.3 è®¾ç½®æœ€æ–°ç‰ˆæœ¬

```
POST /api/component-versions/:versionId/set-latest
```

#### 3.3.4 å¼ƒç”¨ç‰ˆæœ¬

```
POST /api/component-versions/:versionId/deprecate
```

#### 3.3.5 åˆ é™¤ç‰ˆæœ¬

```
DELETE /api/component-versions/:versionId
```

### 3.4 ç»Ÿè®¡æ¥å£

#### 3.4.1 è·å–ç»„ä»¶ç»Ÿè®¡

```
GET /api/components/:id/statistics
```

**è¯´æ˜**ï¼šç”±äºç»„ä»¶èµ„æºç›´æ¥ä»OSSåŠ è½½ï¼Œæ— æ³•ç»Ÿè®¡ä¸‹è½½æ¬¡æ•°ã€‚æ­¤æ¥å£ä»…æä¾›åŸºç¡€ç»Ÿè®¡ä¿¡æ¯ã€‚

å“åº”ï¼š

```json
{
  "code": 200,
  "data": {
    "totalUsage": 89,
    "versionCount": 5,
    "versionStats": [
      {
        "version": "2.1.0",
        "publishedAt": "2025-12-15T10:00:00Z",
        "status": "published",
        "usage": 50
      },
      {
        "version": "2.0.0",
        "publishedAt": "2025-11-20T10:00:00Z",
        "status": "published",
        "usage": 39
      }
    ]
  }
}
```

---

## å››ã€ä¸šåŠ¡æµç¨‹è®¾è®¡

### 4.1 ç»„ä»¶ä¸Šä¼ æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. å‰ç«¯é€‰æ‹©ç»„ä»¶  â”‚
â”‚  å‹ç¼©åŒ…ï¼ˆ.zipï¼‰ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. ä¸Šä¼ åˆ° Nest  â”‚
â”‚    æœåŠ¡å™¨       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. è§£å‹åˆ°ä¸´æ—¶   â”‚
â”‚     ç›®å½•        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. è¯»å–å¹¶è§£æ   â”‚
â”‚ component.meta.json  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. æ ¡éªŒç»„ä»¶åŒ…   â”‚
â”‚  - æ ¼å¼æ ¡éªŒ     â”‚
â”‚  - æ–‡ä»¶æ ¡éªŒ     â”‚
â”‚  - å®‰å…¨æ£€æŸ¥     â”‚
â”‚  - å†²çªæ£€æŸ¥     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
    æ ¡éªŒé€šè¿‡ï¼Ÿ
     â”Œâ”€â”€â”´â”€â”€â”
   æ˜¯â”‚     â”‚å¦
     â–¼     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚6.ä¸Šä¼ åˆ°  â”‚ â”‚ è¿”å›é”™è¯¯ â”‚
â”‚  OSS    â”‚ â”‚  ä¿¡æ¯   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. ç”Ÿæˆæ–‡ä»¶å“ˆå¸Œ â”‚
â”‚    å’Œæ¸…å•       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8. åˆ›å»º/æ›´æ–°ç»„ä»¶â”‚
â”‚    å’Œç‰ˆæœ¬è®°å½•   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 9. çŠ¶æ€è®¾ä¸º     â”‚
â”‚    draft        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 10. è¿”å›ä¸Šä¼     â”‚
â”‚     ç»“æœ        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 11. ç®¡ç†å‘˜å®¡æ ¸  â”‚
â”‚     å¹¶å‘å¸ƒ      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 12. å‘å¸ƒæˆåŠŸ    â”‚
â”‚   å‰ç«¯å¯ç”¨      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 ç»„ä»¶ä½¿ç”¨æµç¨‹ï¼ˆå‰ç«¯è§†è§’ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. å‰ç«¯è°ƒç”¨ â”‚
â”‚   listæ¥å£  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. æ¸²æŸ“ç»„ä»¶ â”‚
â”‚   åˆ—è¡¨é¢æ¿   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. ç”¨æˆ·æ‹–æ‹½ â”‚
â”‚   ç»„ä»¶åˆ°ç”»å¸ƒ â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. åˆ›å»º<script>â”‚
â”‚   æ ‡ç­¾åŠ è½½JS â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. ä»OSSæ‹‰å–â”‚
â”‚   ç»„ä»¶èµ„æº   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. æ³¨å†Œç»„ä»¶ â”‚
â”‚   åˆ°ç”»å¸ƒ     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. æ¸²æŸ“ç»„ä»¶ â”‚
â”‚   å®ä¾‹       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.3 ç»„ä»¶ç‰ˆæœ¬ç®¡ç†æµç¨‹

#### 4.3.1 ç‰ˆæœ¬çŠ¶æ€ç®¡ç†ï¼ˆcomponent_versions è¡¨ï¼‰

ç»„ä»¶ç‰ˆæœ¬ä¸Šä¼ åçš„ç”Ÿå‘½å‘¨æœŸçŠ¶æ€æµè½¬ï¼š

```
1. ä¸Šä¼  zip åŒ…
   â†“
   status = 'draft'ï¼ˆè‰ç¨¿çŠ¶æ€ï¼Œå¾…å®¡æ ¸ï¼Œå‰ç«¯ä¸å¯è§ï¼‰

2. ç®¡ç†å‘˜å®¡æ ¸é€šè¿‡
   â†“
   status = 'published'ï¼ˆå·²å‘å¸ƒï¼Œå‰ç«¯å¯æŸ¥è¯¢å’Œä½¿ç”¨ï¼‰

3. è®¾ä¸ºæœ€æ–°ç‰ˆæœ¬
   â†“
   is_latest = trueï¼ˆç»„ä»¶åˆ—è¡¨æ¥å£é»˜è®¤è¿”å›æ­¤ç‰ˆæœ¬ï¼‰

4. æ ‡è®°ä¸ºç¨³å®šç‰ˆæœ¬ï¼ˆå¯é€‰ï¼‰
   â†“
   is_stable = trueï¼ˆå‰ç«¯æ˜¾ç¤º"ç¨³å®šç‰ˆ"æ ‡ç­¾ï¼‰

5. æ ‡è®°ä¸ºä¸æ¨èï¼ˆå¯é€‰ï¼‰
   â†“
   status = 'deprecated'ï¼ˆä»å¯ç”¨ï¼Œä½†æ˜¾ç¤ºå¼ƒç”¨è­¦å‘Šï¼‰

6. å®Œå…¨ä¸‹æ¶
   â†“
   status = 'archived'ï¼ˆå‰ç«¯ä¸å¯è®¿é—®ï¼Œä½† OSS æ–‡ä»¶ä¿ç•™ï¼‰
```

**å…³é”®å­—æ®µè¯´æ˜**ï¼ˆ`component_versions` è¡¨ï¼‰ï¼š

| å­—æ®µ        | ç±»å‹    | è¯´æ˜                                | å½±å“                   |
| ----------- | ------- | ----------------------------------- | ---------------------- |
| `status`    | VARCHAR | draft/published/deprecated/archived | æ§åˆ¶å‰ç«¯æ˜¯å¦å¯è§       |
| `is_latest` | BOOLEAN | æ˜¯å¦æœ€æ–°ç‰ˆæœ¬ï¼ˆæ¨èç‰ˆæœ¬ï¼‰            | ç»„ä»¶åˆ—è¡¨æ¥å£è¿”å›æ­¤ç‰ˆæœ¬ |
| `is_stable` | BOOLEAN | æ˜¯å¦ç¨³å®šç‰ˆæœ¬                        | å‰ç«¯æ˜¾ç¤ºæ ‡ç­¾ï¼Œæ¨èä½¿ç”¨ |

**é‡è¦è¯´æ˜**ï¼š

- è¿™äº›å­—æ®µ**ä»…å­˜åœ¨äºæ•°æ®åº“**ï¼Œä¸å½±å“ OSS å­˜å‚¨
- OSS ä¸Šåªæœ‰ä¸€å¥—å®é™…æ–‡ä»¶ï¼ˆå¦‚ `components/BarChart/1.0.0/`ï¼‰
- é€šè¿‡ä¿®æ”¹æ•°æ®åº“å­—æ®µæ¥æ§åˆ¶ç‰ˆæœ¬çš„å¯è§æ€§å’ŒçŠ¶æ€

#### 4.3.3 is_latestï¼ˆæ¨èç‰ˆæœ¬ï¼‰ç®¡ç†è§„åˆ™

**ç‰ˆæœ¬å·ä¸ is_latest çš„å…³ç³»ç¤ºä¾‹**ï¼š

```
ç»„ä»¶ BarChart çš„ç‰ˆæœ¬å†å²ï¼š
â”œâ”€â”€ v1.0.0  (status=published, is_latest=false) â† å†å²ç‰ˆæœ¬
â”œâ”€â”€ v1.5.0  (status=published, is_latest=true)  â† å½“å‰æ¨èç‰ˆæœ¬ï¼ˆç”»å¸ƒé»˜è®¤ä½¿ç”¨ï¼‰
â”œâ”€â”€ v2.0.0  (status=published, is_latest=false) â† æ–°ç‰ˆæœ¬å·²å‘å¸ƒï¼Œä½†æœªè®¾ä¸ºæ¨è
â””â”€â”€ v2.1.0  (status=draft, is_latest=false)     â† åˆšä¸Šä¼ ï¼Œå¾…å®¡æ ¸
```

**æ ¸å¿ƒè§„åˆ™**ï¼š

1. **ä¸ä¼šè‡ªåŠ¨è®¾ç½®**ï¼š
   - æ¯æ¬¡ä¸Šä¼ æ–°ç‰ˆæœ¬ï¼Œ`is_latest` é»˜è®¤ä¸º `false`
   - å³ä½¿ v2.0.0 ç‰ˆæœ¬å·æ›´é«˜ï¼Œä¹Ÿä¸ä¼šè‡ªåŠ¨æˆä¸ºæ¨èç‰ˆæœ¬

2. **æ‰‹åŠ¨è®¾ç½®**ï¼š
   - ç®¡ç†å‘˜è°ƒç”¨æ¥å£ï¼š`POST /api/component-versions/:versionId/set-latest`
   - ç³»ç»Ÿè‡ªåŠ¨ç¡®ä¿åŒä¸€ç»„ä»¶åªæœ‰ä¸€ä¸ª `is_latest=true` çš„ç‰ˆæœ¬

3. **å”¯ä¸€æ€§ä¿è¯**ï¼ˆæ•°æ®åº“è§¦å‘å™¨æˆ–æœåŠ¡å±‚å®ç°ï¼‰ï¼š

   ```sql
   -- è®¾ç½®æ–°ç‰ˆæœ¬ä¸º latest æ—¶ï¼Œæ—§ç‰ˆæœ¬è‡ªåŠ¨æ›´æ–°
   UPDATE component_versions
   SET is_latest = false
   WHERE component_id = ? AND is_latest = true;

   UPDATE component_versions
   SET is_latest = true
   WHERE id = ?;
   ```

**ä¸ºä»€ä¹ˆä¸è‡ªåŠ¨è®¾ä¸º latestï¼Ÿ**

- âœ… **å‘åå…¼å®¹**ï¼šv2.0.0 å¯èƒ½æœ‰ç ´åæ€§å˜æ›´ï¼Œéœ€å……åˆ†æµ‹è¯•åæ‰æ¨è
- âœ… **ç°åº¦å‘å¸ƒ**ï¼šå…ˆå‘å¸ƒ v2.0.0 ä¾›é€‰æ‹©ï¼Œæµ‹è¯•ç¨³å®šåå†è®¾ä¸ºæ¨è
- âœ… **ç‰ˆæœ¬å…±å­˜**ï¼šå…è®¸ v1.5.0 ä½œä¸ºç¨³å®šç‰ˆï¼Œv2.0.0 ä½œä¸ºå¯é€‰ç‰ˆæœ¬
- âœ… **Beta æµ‹è¯•**ï¼šå¯ä»¥ä¸Šä¼  v2.0.0-betaï¼Œæ­£å¼ç‰ˆé€šè¿‡åå†è®¾ä¸º latest

**ä¸å‰ç«¯ç”»å¸ƒçš„å…³ç³»**ï¼š

```typescript
// ã€ç”»å¸ƒä¾§ã€‘å‰ç«¯è°ƒç”¨ç»„ä»¶åˆ—è¡¨æ¥å£ï¼ˆç”¨æˆ·å¯æ‹–æ‹½çš„ç»„ä»¶ï¼‰
GET /api/components?status=published

// åç«¯æŸ¥è¯¢é€»è¾‘
SELECT c.*, cv.*
FROM components c
JOIN component_versions cv ON c.id = cv.component_id
WHERE c.status = 'published'
  AND cv.status = 'published'
  AND cv.is_latest = true;  -- åªè¿”å›æ¨èç‰ˆæœ¬

// è¿”å›ç¤ºä¾‹
{
  "id": "uuid-1",
  "name": "BarChart",
  "latestVersion": {
    "version": "1.5.0",  // æ¨èç‰ˆæœ¬ï¼ˆä¸ä¸€å®šæ˜¯ç‰ˆæœ¬å·æœ€å¤§çš„ï¼‰
    "mainJsUrl": "https://oss.../components/BarChart/1.5.0/index.esm.js",
    "isStable": true
  }
}

// å‰ç«¯ç›´æ¥ä½¿ç”¨ mainJsUrl åŠ è½½ç»„ä»¶
```

**å‰ç«¯ä½¿ç”¨åœºæ™¯åŒºåˆ†**ï¼š

| åœºæ™¯                  | æ¥å£                                        | æŸ¥è¯¢æ¡ä»¶                              | è¯´æ˜                              |
| --------------------- | ------------------------------------------- | ------------------------------------- | --------------------------------- |
| **ç”»å¸ƒæ‹–æ‹½åˆ—è¡¨**      | `GET /api/components`                       | `status=published AND is_latest=true` | æ™®é€šç”¨æˆ·çœ‹åˆ°çš„ç»„ä»¶                |
| **ç‰ˆæœ¬é€‰æ‹©å™¨**        | `GET /api/components/:id/versions`          | `status=published`                    | ç”¨æˆ·å¯é€‰æ‹©å…¶ä»–å·²å‘å¸ƒç‰ˆæœ¬          |
| **ç®¡ç†åå°-è‰ç¨¿**     | `GET /api/components?status=draft`          | `status=draft`                        | å¾…å®¡æ ¸ç»„ä»¶åˆ—è¡¨                    |
| **ç®¡ç†åå°-æ‰€æœ‰ç‰ˆæœ¬** | `GET /api/components/:id/versions?all=true` | æ— é™åˆ¶                                | åŒ…æ‹¬ draftã€deprecated ç­‰æ‰€æœ‰ç‰ˆæœ¬ |

**ç®¡ç†åå°æ“ä½œ**ï¼š

- æŸ¥çœ‹æ‰€æœ‰çŠ¶æ€çš„ç»„ä»¶å’Œç‰ˆæœ¬
- æ‰‹åŠ¨ä¿®æ”¹ `status`ï¼ˆå‘å¸ƒã€å¼ƒç”¨ã€ä¸‹æ¶ï¼‰
- æ‰‹åŠ¨è®¾ç½® `is_latest`ï¼ˆåˆ‡æ¢æ¨èç‰ˆæœ¬ï¼‰
- æ‰‹åŠ¨è®¾ç½® `is_stable`ï¼ˆæ ‡è®°ç¨³å®šç‰ˆï¼‰

#### 4.3.2 ç‰ˆæœ¬å·è§„èŒƒè¯´æ˜ï¼ˆSemverï¼‰

ç»„ä»¶é‡‡ç”¨**è¯­ä¹‰åŒ–ç‰ˆæœ¬å·**ï¼ˆSemantic Versioningï¼‰ï¼š

| ç‰ˆæœ¬ç±»å‹  | æ ¼å¼  | ç¤ºä¾‹          | è¯´æ˜       | å…¼å®¹æ€§     |
| --------- | ----- | ------------- | ---------- | ---------- |
| **Major** | X.0.0 | 1.0.0 â†’ 2.0.0 | ç ´åæ€§å˜æ›´ | å¯èƒ½ä¸å…¼å®¹ |
| **Minor** | x.X.0 | 1.0.0 â†’ 1.1.0 | æ–°åŠŸèƒ½     | å‘åå…¼å®¹   |
| **Patch** | x.x.X | 1.0.0 â†’ 1.0.1 | Bug ä¿®å¤   | å‘åå…¼å®¹   |

**å®é™…æµç¨‹**ï¼š

1. å¼€å‘è€…åœ¨æœ¬åœ°ä¿®æ”¹ç»„ä»¶ä»£ç 
2. abd-cli æ‰“åŒ…æ—¶æ‰‹åŠ¨æŒ‡å®šç‰ˆæœ¬å·ï¼ˆå¦‚ `abd build --version 1.0.1`ï¼‰
3. ç”Ÿæˆ dist.zipï¼Œmeta.json ä¸­åŒ…å«æ–°ç‰ˆæœ¬å·
4. ä¸Šä¼  zip åŒ…åˆ°åç«¯
5. åç«¯è§£æ meta.jsonï¼Œåˆ›å»ºæ–°çš„ `component_versions` è®°å½•
6. æ–°ç‰ˆæœ¬åˆå§‹çŠ¶æ€ä¸º `draft`ï¼Œéœ€è¦ç®¡ç†å‘˜å®¡æ ¸åæ‰èƒ½å‘å¸ƒ

---

## äº”ã€æƒé™æ§åˆ¶è®¾è®¡

### 5.1 è§’è‰²å®šä¹‰

åŸºäºç°æœ‰RBACç³»ç»Ÿï¼Œæ‰©å±•ä»¥ä¸‹è§’è‰²ï¼š

1. **ç»„ä»¶ç®¡ç†å‘˜ï¼ˆComponent Adminï¼‰**
   - æŸ¥çœ‹æ‰€æœ‰çŠ¶æ€çš„ç»„ä»¶ï¼ˆåŒ…æ‹¬è‰ç¨¿ã€å·²å¼ƒç”¨ï¼‰
   - å®¡æ ¸å¹¶å‘å¸ƒç»„ä»¶ï¼ˆdraft â†’ publishedï¼‰
   - è®¾ç½®æ¨èç‰ˆæœ¬ï¼ˆis_latestï¼‰
   - å¼ƒç”¨/ä¸‹æ¶ç»„ä»¶
   - åˆ é™¤ä»»ä½•ç»„ä»¶
   - ç®¡ç†åˆ†ç±»é…ç½®

2. **ç»„ä»¶å¼€å‘è€…ï¼ˆComponent Developerï¼‰**
   - ä¸Šä¼ ç»„ä»¶ zip åŒ…ï¼ˆè‡ªåŠ¨åˆ›å»º/æ›´æ–°ç»„ä»¶å’Œç‰ˆæœ¬è®°å½•ï¼‰
   - åˆ é™¤è‡ªå·±ä¸Šä¼ çš„ç»„ä»¶ï¼ˆå¯é€‰ï¼‰

3. **æ™®é€šç”¨æˆ·ï¼ˆNormal Userï¼‰**
   - æŸ¥çœ‹å·²å‘å¸ƒç»„ä»¶ï¼ˆstatus=publishedï¼‰
   - åœ¨ç”»å¸ƒä¸­ä½¿ç”¨ç»„ä»¶ï¼ˆæ‹–æ‹½ã€é…ç½®ï¼‰

### 5.2 æƒé™ç‚¹è®¾è®¡

```typescript
// ç»„ä»¶åˆ†ç±»æƒé™ï¼ˆç®¡ç†åå°ï¼‰
COMPONENT_CATEGORY_VIEW = 'component:category:view'
COMPONENT_CATEGORY_CREATE = 'component:category:create'
COMPONENT_CATEGORY_UPDATE = 'component:category:update'
COMPONENT_CATEGORY_DELETE = 'component:category:delete'

// ç»„ä»¶ç®¡ç†æƒé™
COMPONENT_VIEW = 'component:view' // æŸ¥çœ‹å·²å‘å¸ƒç»„ä»¶
COMPONENT_VIEW_ALL = 'component:view:all' // æŸ¥çœ‹æ‰€æœ‰çŠ¶æ€çš„ç»„ä»¶ï¼ˆåŒ…æ‹¬è‰ç¨¿ï¼‰
COMPONENT_UPLOAD = 'component:upload' // ä¸Šä¼ ç»„ä»¶åŒ…ï¼ˆä¼šè‡ªåŠ¨åˆ›å»º/æ›´æ–°ç»„ä»¶å’Œç‰ˆæœ¬è®°å½•ï¼‰
COMPONENT_DELETE = 'component:delete' // åˆ é™¤è‡ªå·±çš„ç»„ä»¶
COMPONENT_DELETE_ANY = 'component:delete:any' // åˆ é™¤ä»»ä½•äººçš„ç»„ä»¶

// ç»„ä»¶ç‰ˆæœ¬æƒé™
COMPONENT_VERSION_VIEW = 'component:version:view' // æŸ¥çœ‹ç‰ˆæœ¬åˆ—è¡¨
COMPONENT_VERSION_PUBLISH = 'component:version:publish' // å‘å¸ƒç‰ˆæœ¬ï¼ˆdraft â†’ publishedï¼‰
COMPONENT_VERSION_SET_LATEST = 'component:version:set-latest' // è®¾ç½®æ¨èç‰ˆæœ¬
COMPONENT_VERSION_DEPRECATE = 'component:version:deprecate' // å¼ƒç”¨ç‰ˆæœ¬
COMPONENT_VERSION_DELETE = 'component:version:delete' // åˆ é™¤ç‰ˆæœ¬
```

**è§’è‰²ä¸æƒé™å¯¹åº”å…³ç³»**ï¼š

| æƒé™                           | ç»„ä»¶ç®¡ç†å‘˜ | ç»„ä»¶å¼€å‘è€…     | æ™®é€šç”¨æˆ· |
| ------------------------------ | ---------- | -------------- | -------- |
| `component:view`               | âœ…         | âœ…             | âœ…       |
| `component:view:all`           | âœ…         | âŒ             | âŒ       |
| `component:upload`             | âœ…         | âœ…             | âŒ       |
| `component:delete`             | âœ…         | âœ…ï¼ˆä»…è‡ªå·±çš„ï¼‰ | âŒ       |
| `component:delete:any`         | âœ…         | âŒ             | âŒ       |
| `component:category:*`         | âœ…         | âŒ             | âŒ       |
| `component:version:publish`    | âœ…         | âŒ             | âŒ       |
| `component:version:set-latest` | âœ…         | âŒ             | âŒ       |
| `component:version:deprecate`  | âœ…         | âŒ             | âŒ       |

**æƒé™è¯´æ˜**ï¼š

1. **`component:upload`**ï¼š
   - ä¸Šä¼ ç»„ä»¶ zip åŒ…åï¼Œç³»ç»Ÿè‡ªåŠ¨è§£æ `component.meta.json`
   - å¦‚æœç»„ä»¶ä¸å­˜åœ¨ï¼Œè‡ªåŠ¨åˆ›å»º `components` è¡¨è®°å½•
   - å¦‚æœç»„ä»¶å­˜åœ¨ï¼Œæ ¹æ® `meta.json` æ›´æ–°ç»„ä»¶ä¿¡æ¯ï¼ˆå¦‚åˆ†ç±»ã€æè¿°ç­‰ï¼‰
   - è‡ªåŠ¨åˆ›å»º `component_versions` è¡¨è®°å½•
   - åˆå§‹çŠ¶æ€ä¸º `draft`ï¼Œéœ€è¦å®¡æ ¸

2. **ä¸éœ€è¦ `component:update` æƒé™**ï¼š
   - ç»„ä»¶ä¿¡æ¯å®Œå…¨ç”± `component.meta.json` å†³å®š
   - è¦ä¿®æ”¹ç»„ä»¶ä¿¡æ¯ï¼Œåº”ä¿®æ”¹æœ¬åœ°ä»£ç å’Œ meta.jsonï¼Œé‡æ–°æ‰“åŒ…ä¸Šä¼ 
   - ä¸æä¾›ç‹¬ç«‹çš„"æ›´æ–°ç»„ä»¶ä¿¡æ¯"æ¥å£

3. **ä¸éœ€è¦ `component:create` æƒé™**ï¼š
   - å› ä¸ºä¸Šä¼  zip åŒ…æ—¶ä¼šè‡ªåŠ¨åˆ›å»ºç»„ä»¶
   - æ¥å£ `POST /api/components` å¯ä»¥åˆ é™¤ï¼Œä¸éœ€è¦

### 5.3 æƒé™æ ¡éªŒæµç¨‹

**ç¤ºä¾‹1ï¼šä¸Šä¼ ç»„ä»¶åŒ…**

```typescript
@Post('upload')
@RequirePermissions('component:upload')
async uploadComponent(@UploadedFile() file: Express.Multer.File, @CurrentUser() user: User) {
  // 1. è§£å‹å¹¶è§£æ component.meta.json
  const meta = await this.parseMetaJson(file);

  // 2. æ£€æŸ¥ç»„ä»¶æ˜¯å¦å­˜åœ¨
  const existingComponent = await this.componentsService.findByComponentId(meta.id);

  if (existingComponent) {
    // æ›´æ–°ç°æœ‰ç»„ä»¶ï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯åˆ›å»ºè€…æˆ–æœ‰ç®¡ç†æƒé™
    if (existingComponent.createdBy !== user.id) {
      await this.checkPermission(user.id, 'component:update:any');
    }
  }
  // å¦‚æœç»„ä»¶ä¸å­˜åœ¨ï¼Œä¼šè‡ªåŠ¨åˆ›å»ºï¼ˆå·²æœ‰ component:upload æƒé™ï¼‰

  // 3. ä¸Šä¼ åˆ° OSS å¹¶åˆ›å»ºç‰ˆæœ¬è®°å½•
  return await this.componentUploadService.process(file, meta, user);
}
```

**ç¤ºä¾‹2ï¼šå‘å¸ƒç‰ˆæœ¬ï¼ˆç®¡ç†å‘˜ï¼‰**

```typescript
@Post('versions/:versionId/publish')
@RequirePermissions('component:version:publish')
async publishVersion(@Param('versionId') versionId: string) {
  // æ›´æ–°ç‰ˆæœ¬çŠ¶æ€ï¼šdraft â†’ published
  await this.componentVersionsService.updateStatus(versionId, 'published');
}
```

---

## å…­ã€OSSå­˜å‚¨è®¾è®¡

### 6.1 OSS ç›®å½•ç»“æ„è®¾è®¡

**é‡è¦è¯´æ˜**ï¼šabd-cli æ‰“åŒ…äº§ç‰©æ˜¯æ‰å¹³çš„ï¼ˆæ¯ä¸ªç‰ˆæœ¬ç‹¬ç«‹çš„ dist.zipï¼‰ï¼Œä½†è¿™**ä¸å½±å“** OSS çš„å­˜å‚¨ç»“æ„è®¾è®¡ã€‚

OSS é‡‡ç”¨**åµŒå¥—ç»“æ„**ç»„ç»‡ç»„ä»¶èµ„æºï¼Œé€šè¿‡æ•°æ®åº“æ¨¡å‹ç»´æŠ¤ç»„ä»¶ã€ç‰ˆæœ¬ã€OSSè·¯å¾„çš„å…³ç³»ï¼š

```
oss-bucket/
â””â”€â”€ components/
    â”œâ”€â”€ BarChart/                     # ç»„ä»¶ç›®å½•ï¼ˆä½¿ç”¨ component_idï¼‰
    â”‚   â”œâ”€â”€ 1.0.0/                    # ç‰ˆæœ¬ç›®å½•ï¼ˆç”± meta.json version å†³å®šï¼‰
    â”‚   â”‚   â”œâ”€â”€ component.meta.json   # ç»„ä»¶æè¿°æ–‡ä»¶
    â”‚   â”‚   â”œâ”€â”€ index.esm.js          # ä¸»å…¥å£æ–‡ä»¶
    â”‚   â”‚   â”œâ”€â”€ index.esm.js.map      # Source Map
    â”‚   â”‚   â”œâ”€â”€ style.css             # æ ·å¼æ–‡ä»¶
    â”‚   â”‚   â”œâ”€â”€ assets/               # é™æ€èµ„æº
    â”‚   â”‚   â”‚   â””â”€â”€ preview.png       # é¢„è§ˆå›¾
    â”‚   â”‚   â””â”€â”€ manifest.json         # èµ„æºæ¸…å•ï¼ˆåç«¯ç”Ÿæˆï¼‰
    â”‚   â”‚
    â”‚   â”œâ”€â”€ 1.1.0/                    # åŒä¸€ç»„ä»¶çš„æ–°ç‰ˆæœ¬
    â”‚   â”‚   â”œâ”€â”€ component.meta.json
    â”‚   â”‚   â”œâ”€â”€ index.esm.js
    â”‚   â”‚   â””â”€â”€ ...
    â”‚   â”‚
    â”‚   â””â”€â”€ 2.0.0/                    # ä¸»ç‰ˆæœ¬æ›´æ–°
    â”‚       â””â”€â”€ ...
    â”‚
    â””â”€â”€ LineChart/                    # ä¸åŒç»„ä»¶
        â”œâ”€â”€ 1.0.0/
        â””â”€â”€ 1.0.1/
```

**è®¾è®¡è¯´æ˜**ï¼š

1. **abd-cli æ‰å¹³åŒ–æ‰“åŒ…** vs **OSS åµŒå¥—å­˜å‚¨**
   - abd-cliï¼šç”Ÿæˆç‹¬ç«‹çš„ dist.zipï¼Œä¸å…³å¿ƒå…¶ä»–ç‰ˆæœ¬
   - åç«¯ï¼šè§£æ meta.json ä¸­çš„ `id` å’Œ `version`ï¼Œä¸Šä¼ åˆ° `components/{id}/{version}/`

2. **æ•°æ®åº“æ¨¡å‹ç»´æŠ¤å…³ç³»**

   ```typescript
   // component_versions è¡¨
   {
     component_id: 1,              // å…³è”åˆ° components è¡¨
     version: "1.0.0",             // æ¥è‡ª meta.json
     oss_base_path: "components/BarChart/1.0.0/",
     entry_url: "https://oss.../components/BarChart/1.0.0/index.esm.js",
     style_url: "https://oss.../components/BarChart/1.0.0/style.css",
     preview_url: "https://oss.../components/BarChart/1.0.0/assets/preview.png"
   }
   ```

3. **åµŒå¥—ç»“æ„ä¼˜åŠ¿**
   - âœ… åŒä¸€ç»„ä»¶çš„ç‰ˆæœ¬èšåˆåœ¨ä¸€èµ·ï¼Œä¾¿äºç®¡ç†
   - âœ… æ¸…æ™°çš„ç»„ç»‡ç»“æ„ï¼Œæ˜“äºè¿ç»´å’Œæ•…éšœæ’æŸ¥
   - âœ… æ”¯æŒæ‰¹é‡æ“ä½œï¼ˆå¦‚åˆ é™¤æŸç»„ä»¶çš„æ‰€æœ‰ç‰ˆæœ¬ï¼‰
   - âœ… ä¾¿äºç‰ˆæœ¬é—´æ–‡ä»¶å¯¹æ¯”å’Œå®¡è®¡
   - âœ… ç¬¦åˆå¸¸è§çš„é™æ€èµ„æºç»„ç»‡ä¹ æƒ¯

### 6.2 ç»„ä»¶åŒ…ç»“æ„è§„èŒƒï¼ˆdist.zipï¼‰

é€šè¿‡ abd-cli æ‰“åŒ…åçš„ç»„ä»¶åŒ…ï¼ˆdist.zipï¼‰åŒ…å«ä»¥ä¸‹ç»“æ„ï¼š

```
dist.zip
â”œâ”€â”€ component.meta.json    # ç»„ä»¶æè¿°æ–‡ä»¶ï¼ˆå¿…éœ€ï¼Œæ ¹ç›®å½•ï¼‰
â”œâ”€â”€ index.esm.js          # ä¸»å…¥å£æ–‡ä»¶ï¼ˆå¿…éœ€ï¼‰
â”œâ”€â”€ index.esm.js.map      # Source Mapï¼ˆå¯é€‰ï¼‰
â”œâ”€â”€ style.css             # æ ·å¼æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
â””â”€â”€ assets/               # é™æ€èµ„æºç›®å½•ï¼ˆå¯é€‰ï¼‰
    â””â”€â”€ preview.png       # é¢„è§ˆå›¾ï¼ˆå¿…éœ€ï¼‰
```

**è¯´æ˜**ï¼š

- `component.meta.json` å¿…é¡»ä½äº zip åŒ…æ ¹ç›®å½•
- æ–‡ä»¶åå’Œè·¯å¾„åœ¨ `component.meta.json` çš„ `files` å­—æ®µä¸­å£°æ˜
- abd-cli è‡ªåŠ¨ç”Ÿæˆæ­¤ç»“æ„ï¼Œå¼€å‘è€…æ— éœ€æ‰‹åŠ¨è°ƒæ•´

### 6.3 component.meta.json è§„èŒƒï¼ˆabd-cli ç”Ÿæˆï¼‰

ç»„ä»¶åŒ…æ ¹ç›®å½•å¿…é¡»åŒ…å« `component.meta.json` æ–‡ä»¶ï¼Œç”± abd-cli è‡ªåŠ¨ç”Ÿæˆï¼š

```json
{
  "id": "BarChart",
  "name": "æŸ±çŠ¶å›¾",
  "version": "1.0.0",
  "description": "åŸºäº ECharts çš„é€šç”¨æŸ±çŠ¶å›¾ç»„ä»¶ï¼Œæ”¯æŒå¤šç§æ•°æ®å±•ç¤ºæ–¹å¼",
  "classification": {
    "level1": "chart",
    "level2": "bar",
    "displayName": {
      "level1": "å›¾è¡¨",
      "level2": "æŸ±çŠ¶å›¾"
    }
  },
  "type": "vue-echarts",
  "framework": "vue3",
  "author": {
    "organization": "æ±Ÿè‹ç”µåŠ›å…¬å¸",
    "userName": "weiting"
  },
  "files": {
    "entry": "index.esm.js",
    "style": "style.css",
    "preview": "assets/preview.png"
  },
  "buildInfo": {
    "buildTime": "2025-12-20T14:30:00.000Z",
    "hash": "abc123def456",
    "cliVersion": "1.0.0"
  },
  "license": "MIT"
}
```

**å­—æ®µè¯´æ˜**ï¼š

| å­—æ®µ                         | ç±»å‹   | å¿…éœ€ | è¯´æ˜                                           |
| ---------------------------- | ------ | ---- | ---------------------------------------------- |
| `id`                         | string | âœ…   | ç»„ä»¶å”¯ä¸€æ ‡è¯†ï¼ˆè‹±æ–‡ï¼ŒPascalCaseï¼Œå¦‚ï¼šBarChartï¼‰ |
| `name`                       | string | âœ…   | ç»„ä»¶ä¸­æ–‡åç§°ï¼ˆå¦‚ï¼šæŸ±çŠ¶å›¾ï¼‰                     |
| `version`                    | string | âœ…   | è¯­ä¹‰åŒ–ç‰ˆæœ¬å·ï¼ˆå¦‚ï¼š1.0.0ï¼‰                      |
| `description`                | string | âŒ   | ç»„ä»¶åŠŸèƒ½æè¿°                                   |
| `classification`             | object | âœ…   | **ç»„ä»¶åˆ†ç±»ä¿¡æ¯**ï¼ˆç”¨äºç®¡ç†åå°åˆ†ç±»å±•ç¤ºï¼‰       |
| `classification.level1`      | string | âœ…   | ä¸€çº§åˆ†ç±»æ ‡è¯†ï¼ˆè‹±æ–‡ï¼šchart/table/formï¼‰         |
| `classification.level2`      | string | âœ…   | äºŒçº§åˆ†ç±»æ ‡è¯†ï¼ˆè‹±æ–‡ï¼šbar/line/pieï¼‰             |
| `classification.displayName` | object | âœ…   | åˆ†ç±»å±•ç¤ºåç§°ï¼ˆä¸­æ–‡ï¼‰                           |
| `type`                       | string | âœ…   | ç»„ä»¶æ¨¡æ¿ç±»å‹ï¼ˆvue-echarts/vue-component/jsï¼‰   |
| `framework`                  | string | âœ…   | å¼€å‘æ¡†æ¶ï¼ˆvue3/jsï¼‰                            |
| `author`                     | object | âŒ   | ä½œè€…ä¿¡æ¯                                       |
| `author.organization`        | string | âŒ   | ç»„ç»‡åç§°                                       |
| `author.userName`            | string | âŒ   | ç”¨æˆ·å                                         |
| `files`                      | object | âœ…   | **æ‰“åŒ…äº§ç‰©æ–‡ä»¶æ¸…å•**ï¼ˆè®°å½•æ‰“åŒ…åç”Ÿæˆçš„æ–‡ä»¶åï¼‰ |
| `files.entry`                | string | âœ…   | ä¸»å…¥å£æ–‡ä»¶ï¼ˆindex.esm.jsï¼‰                     |
| `files.style`                | string | âŒ   | æ ·å¼æ–‡ä»¶ï¼ˆstyle.cssï¼‰                          |
| `files.preview`              | string | âœ…   | é¢„è§ˆå›¾ï¼ˆassets/preview.pngï¼‰                   |
| `buildInfo`                  | object | âœ…   | æ„å»ºä¿¡æ¯ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰                           |
| `buildInfo.buildTime`        | string | âœ…   | æ„å»ºæ—¶é—´ï¼ˆISO æ ¼å¼ï¼‰                           |
| `buildInfo.hash`             | string | âœ…   | æ–‡ä»¶å“ˆå¸Œå€¼ï¼ˆç”¨äºç¼“å­˜æ§åˆ¶ï¼‰                     |
| `buildInfo.cliVersion`       | string | âœ…   | CLI ç‰ˆæœ¬å·                                     |
| `license`                    | string | âŒ   | è®¸å¯è¯ï¼ˆå¦‚ï¼šMITï¼‰                              |

### 6.4 manifest.json ç¤ºä¾‹ï¼ˆåç«¯è‡ªåŠ¨ç”Ÿæˆï¼‰

åç«¯åœ¨å¤„ç†ç»„ä»¶åŒ…åï¼Œä¼šè‡ªåŠ¨ç”Ÿæˆ `manifest.json` æ–‡ä»¶ï¼ŒåŒ…å«æ‰€æœ‰æ–‡ä»¶çš„å…ƒä¿¡æ¯ï¼š

```json
{
  "componentId": "BarChart",
  "version": "1.0.0",
  "files": [
    {
      "path": "index.esm.js",
      "size": 45678,
      "hash": "sha256-abc123",
      "type": "application/javascript",
      "url": "https://oss.example.com/components/BarChart/1.0.0/index.esm.js"
    },
    {
      "path": "index.esm.js.map",
      "size": 123456,
      "hash": "sha256-def456",
      "type": "application/json",
      "url": "https://oss.example.com/components/BarChart/1.0.0/index.esm.js.map"
    },
    {
      "path": "style.css",
      "size": 12345,
      "hash": "sha256-ghi789",
      "type": "text/css",
      "url": "https://oss.example.com/components/BarChart/1.0.0/style.css"
    },
    {
      "path": "assets/preview.png",
      "size": 5678,
      "hash": "sha256-jkl012",
      "type": "image/png",
      "url": "https://oss.example.com/components/BarChart/1.0.0/assets/preview.png"
    }
  ],
  "meta": {
    "buildTime": "2025-12-20T14:30:00.000Z",
    "cliVersion": "1.0.0"
  },
  "uploadedAt": "2025-12-20T10:00:00Z",
  "uploadedBy": "user-uuid-1",
  "validatedAt": "2025-12-20T10:00:00Z"
}
```

### 6.5 OSSç­–ç•¥

1. **CDNåŠ é€Ÿ**ï¼šç»„ä»¶èµ„æºé…ç½®CDNï¼ŒåŠ å¿«åŠ è½½é€Ÿåº¦
2. **è·¨åŸŸé…ç½®**ï¼šå…è®¸å‰ç«¯è·¨åŸŸè®¿é—®
3. **ç¼“å­˜ç­–ç•¥**ï¼š
   - ç‰ˆæœ¬èµ„æºï¼šé•¿æœŸç¼“å­˜ï¼ˆ1å¹´ï¼‰
   - ç¼©ç•¥å›¾ï¼šä¸­æœŸç¼“å­˜ï¼ˆ30å¤©ï¼‰
4. **è®¿é—®æ§åˆ¶**ï¼š
   - å…¬å¼€è¯»ï¼šå·²å‘å¸ƒç»„ä»¶
   - ç§æœ‰ï¼šè‰ç¨¿ç»„ä»¶
5. **å¤‡ä»½ç­–ç•¥**ï¼šå®šæœŸå¤‡ä»½åˆ°å…¶ä»–åŒºåŸŸ

---

## ä¸ƒã€ç¼“å­˜ç­–ç•¥

> **ğŸ“‹ æš‚ä¸å®ç°**ï¼šRedis ç¼“å­˜åŠŸèƒ½æš‚ä¸è€ƒè™‘ï¼Œåç»­ç‰ˆæœ¬æ ¹æ®æ€§èƒ½éœ€æ±‚å†³å®šæ˜¯å¦æ·»åŠ ã€‚
>
> åˆæœŸç›´æ¥æŸ¥è¯¢æ•°æ®åº“å³å¯æ»¡è¶³éœ€æ±‚ï¼Œå¾…ç»„ä»¶æ•°é‡å¢é•¿åå†è€ƒè™‘å¼•å…¥ç¼“å­˜å±‚ã€‚

### 7.1 Redisç¼“å­˜è®¾è®¡ï¼ˆé¢„ç•™ï¼‰

```typescript
// ç¼“å­˜Keyè®¾è®¡
const CacheKeys = {
  // ç»„ä»¶åˆ—è¡¨ï¼ˆæŒ‰çŠ¶æ€å’Œåˆ†ç±»ï¼‰
  COMPONENT_LIST: (status: string, categoryId: string) => `components:list:${status}:${categoryId}`,

  // ç»„ä»¶è¯¦æƒ…
  COMPONENT_DETAIL: (id: string) => `component:detail:${id}`,

  // ç»„ä»¶æœ€æ–°ç‰ˆæœ¬
  COMPONENT_LATEST_VERSION: (componentId: string) => `component:${componentId}:version:latest`,

  // åˆ†ç±»æ ‘
  CATEGORY_TREE: 'components:categories:tree',

  // çƒ­é—¨ç»„ä»¶ï¼ˆæŒ‰ä¸‹è½½é‡ï¼‰
  HOT_COMPONENTS: 'components:hot',

  // ç»„ä»¶ç»Ÿè®¡
  COMPONENT_STATS: (id: string) => `component:${id}:stats`
}

// TTLè®¾ç½®
const CacheTTL = {
  COMPONENT_LIST: 5 * 60, // 5åˆ†é’Ÿ
  COMPONENT_DETAIL: 10 * 60, // 10åˆ†é’Ÿ
  CATEGORY_TREE: 30 * 60, // 30åˆ†é’Ÿ
  HOT_COMPONENTS: 60 * 60, // 1å°æ—¶
  COMPONENT_STATS: 5 * 60 // 5åˆ†é’Ÿ
}
```

### 7.2 ç¼“å­˜æ›´æ–°ç­–ç•¥

1. **ä¸»åŠ¨æ›´æ–°**ï¼š
   - ç»„ä»¶å‘å¸ƒ/æ›´æ–°/åˆ é™¤æ—¶ï¼Œæ¸…é™¤ç›¸å…³ç¼“å­˜
   - ç‰ˆæœ¬å‘å¸ƒæ—¶ï¼Œæ›´æ–°æœ€æ–°ç‰ˆæœ¬ç¼“å­˜

2. **è¢«åŠ¨æ›´æ–°**ï¼š
   - ç¼“å­˜è¿‡æœŸåï¼Œä¸‹æ¬¡è¯·æ±‚æ—¶é‡æ–°åŠ è½½

3. **é¢„çƒ­ç­–ç•¥**ï¼š
   - ç³»ç»Ÿå¯åŠ¨æ—¶ï¼Œé¢„åŠ è½½çƒ­é—¨ç»„ä»¶
   - å®šæ—¶ä»»åŠ¡æ›´æ–°ç»Ÿè®¡æ•°æ®ç¼“å­˜

---

## å…«ã€å®‰å…¨æ€§è€ƒè™‘

### 8.1 ä¸Šä¼ å®‰å…¨

#### 8.1.1 ç»„ä»¶åŒ…æ ¡éªŒè§„åˆ™

**1. component.meta.json æ ¡éªŒ**ï¼š

```typescript
// å¿…éœ€å­—æ®µæ ¡éªŒ
requiredFields = [
  'id',           // ç»„ä»¶å”¯ä¸€æ ‡è¯†
  'name',         // ç»„ä»¶ä¸­æ–‡åç§°
  'version',      // ç‰ˆæœ¬å·
  'classification', // åˆ†ç±»ä¿¡æ¯
  'type',         // ç»„ä»¶ç±»å‹
  'framework',    // å¼€å‘æ¡†æ¶
  'files',        // æ–‡ä»¶æ¸…å•
  'buildInfo'     // æ„å»ºä¿¡æ¯
]

// æ ¼å¼æ ¡éªŒ
- id: /^[A-Z][a-zA-Z0-9]*$/  // PascalCaseï¼ˆå¦‚ï¼šBarChartï¼‰
- version: semver æ ¼å¼ï¼ˆå¦‚ï¼š1.0.0ï¼‰
- classification.level1: å¿…é¡»æ˜¯æœ‰æ•ˆå€¼ï¼ˆchart/table/form/layout/displayï¼‰
- classification.level2: å¿…é¡»æ˜¯æœ‰æ•ˆå€¼ï¼ˆbar/line/pieç­‰ï¼‰
- type: å¿…é¡»æ˜¯æœ‰æ•ˆå€¼ï¼ˆvue-echarts/vue-component/jsï¼‰
- framework: å¿…é¡»æ˜¯æœ‰æ•ˆå€¼ï¼ˆvue3/jsï¼‰
- files.entry: å¿…é¡»æ˜¯ .js/.esm.js/.mjs æ–‡ä»¶
- files.style: å¦‚æœå­˜åœ¨ï¼Œå¿…é¡»æ˜¯ .css æ–‡ä»¶
- files.preview: å¿…é¡»æ˜¯ .png/.jpg/.jpeg æ–‡ä»¶
```

**2. æ–‡ä»¶ç±»å‹ç™½åå•**ï¼š

```typescript
const ALLOWED_EXTENSIONS = {
  code: ['.js', '.esm.js', '.mjs'],
  style: ['.css'],
  image: ['.png', '.jpg', '.jpeg', '.svg', '.webp'],
  data: ['.json'],
  map: ['.map'] // Source Map æ–‡ä»¶
}

// MIME ç±»å‹æ£€æŸ¥
const ALLOWED_MIME_TYPES = [
  'application/javascript',
  'text/javascript',
  'text/css',
  'image/png',
  'image/jpeg',
  'image/svg+xml',
  'application/json'
]
```

**3. æ–‡ä»¶å¤§å°é™åˆ¶**ï¼š

```typescript
const SIZE_LIMITS = {
  singleFile: 10 * 1024 * 1024, // 10MB
  totalPackage: 50 * 1024 * 1024, // 50MB
  thumbnail: 2 * 1024 * 1024, // 2MB
  preview: 5 * 1024 * 1024, // 5MB
  image: 5 * 1024 * 1024, // 5MB
  code: 5 * 1024 * 1024 // 5MB
}
```

**4. æ¶æ„ä»£ç æ£€æµ‹**ï¼ˆæš‚ä¸å®ç°ï¼‰ï¼š

> **ğŸ“‹ æš‚ä¸å®ç°**ï¼šæ¶æ„ä»£ç æ£€æµ‹åœ¨åˆæœŸç‰ˆæœ¬ä¸­æš‚ä¸è€ƒè™‘ã€‚
>
> å»ºè®®é‡‡ç”¨ä»¥ä¸‹å®‰å…¨æªæ–½ä»£æ›¿ï¼š
>
> - é™åˆ¶ç»„ä»¶ä¸Šä¼ æƒé™ï¼ˆä»…ä¿¡ä»»çš„å¼€å‘è€…ï¼‰
> - ç»„ä»¶å®¡æ ¸æµç¨‹ï¼ˆç®¡ç†å‘˜äººå·¥å®¡æŸ¥ï¼‰
> - æ²™ç®±ç¯å¢ƒæµ‹è¯•ï¼ˆå¯é€‰ï¼‰

```typescript
// é¢„ç•™æ¥å£è®¾è®¡ï¼ˆæš‚ä¸å®ç°ï¼‰
// å±é™©å‡½æ•°æ£€æµ‹
const DANGEROUS_FUNCTIONS = [
  'eval(',
  'Function(',
  'setTimeout(',
  'setInterval(',
  'document.write(',
  'innerHTML =',
  'dangerouslySetInnerHTML',
  '__proto__',
  'constructor.constructor'
]

// å¯ç–‘ URL æ¨¡å¼
const SUSPICIOUS_URL_PATTERNS = [/javascript:/, /data:text\/html/, /vbscript:/]

// ç¦æ­¢çš„ Node.js æ¨¡å—
const FORBIDDEN_MODULES = ['child_process', 'fs', 'net', 'dgram', 'dns', 'http', 'https']
```

**5. æ–‡ä»¶ç»“æ„æ ¡éªŒ**ï¼š

```typescript
// å¿…éœ€æ–‡ä»¶ï¼ˆæ ¹æ® component.meta.json åŠ¨æ€æ£€æŸ¥ï¼‰
const REQUIRED_FILES = [
  'component.meta.json',  // æè¿°æ–‡ä»¶å¿…é¡»åœ¨æ ¹ç›®å½•
  // ä»¥ä¸‹æ–‡ä»¶ä» meta.json çš„ files å­—æ®µè¯»å–
  // - files.entry  (å¦‚: index.esm.js)
  // - files.preview (å¦‚: assets/preview.png)
];

// ç¦æ­¢çš„æ–‡ä»¶/ç›®å½•
const FORBIDDEN_PATHS = [
  '.git',
  '.env',
  'node_modules',
  '.DS_Store',
  'Thumbs.db',
  '*.exe',
  '*.dll',
  '*.so',
  '*.dylib'
];

// æ–‡ä»¶åæ ¡éªŒ
- ç¦æ­¢ç‰¹æ®Šå­—ç¬¦: <, >, :, ", /, \, |, ?, *
- ç¦æ­¢è·¯å¾„éå†: ../, ..\
- æœ€å¤§é•¿åº¦: 255 å­—ç¬¦
```

**6. ä¾èµ–å®‰å…¨æ£€æŸ¥**ï¼ˆæš‚ä¸å®ç°ï¼‰ï¼š

> **ğŸ“‹ æš‚ä¸å®ç°**ï¼šä¾èµ–å®‰å…¨æ£€æŸ¥åœ¨åˆæœŸç‰ˆæœ¬ä¸­æš‚ä¸è€ƒè™‘ã€‚
>
> åç»­å¯è€ƒè™‘é›†æˆ npm audit æˆ–ç¬¬ä¸‰æ–¹å®‰å…¨æ‰«ææœåŠ¡ã€‚

```typescript
// é¢„ç•™æ¥å£è®¾è®¡ï¼ˆæš‚ä¸å®ç°ï¼‰
// æ£€æŸ¥ä¾èµ–ç‰ˆæœ¬
- ä¸å…è®¸ä½¿ç”¨ * æˆ– latest
- æ¨èä½¿ç”¨é”å®šç‰ˆæœ¬æˆ– ^ ç¬¦å·
- æ£€æŸ¥æ˜¯å¦æœ‰å·²çŸ¥æ¼æ´ï¼ˆå¯é€‰é›†æˆ npm auditï¼‰
```

#### 8.1.2 æ ¡éªŒæµç¨‹å®ç°

```typescript
class ComponentValidator {
  async validatePackage(zipFile: Buffer): Promise<ValidationResult> {
    // 1. è§£å‹åˆ°ä¸´æ—¶ç›®å½•
    const tempDir = await this.extractZip(zipFile)

    try {
      // 2. æ£€æŸ¥æ–‡ä»¶æ•°é‡ï¼ˆé˜²æ­¢å‹ç¼©ç‚¸å¼¹ï¼‰
      const fileCount = await this.countFiles(tempDir)
      if (fileCount > 1000) {
        throw new Error('æ–‡ä»¶æ•°é‡è¶…è¿‡é™åˆ¶ï¼ˆæœ€å¤š1000ä¸ªæ–‡ä»¶ï¼‰')
      }

      // 3. è¯»å– component.json
      const componentJson = await this.readComponentJson(tempDir)

      // 4. æ ¡éªŒ component.json
      await this.validateComponentJson(componentJson)

      // 5. æ ¡éªŒæ–‡ä»¶ç»“æ„
      await this.validateFileStructure(tempDir, componentJson)

      // 6. æ ¡éªŒæ–‡ä»¶ç±»å‹å’Œå¤§å°
      await this.validateFiles(tempDir)

      // 7. æ‰«ææ¶æ„ä»£ç ï¼ˆæš‚ä¸å®ç°ï¼Œé¢„ç•™ï¼‰
      // await this.scanMaliciousCode(tempDir)

      // 8. æ£€æŸ¥ä¾èµ–å®‰å…¨ï¼ˆæš‚ä¸å®ç°ï¼Œé¢„ç•™ï¼‰
      // await this.checkDependencySecurity(componentJson.dependencies)

      return {
        passed: true,
        warnings: this.warnings
      }
    } finally {
      // 9. æ¸…ç†ä¸´æ—¶ç›®å½•
      await this.cleanupTempDir(tempDir)
    }
  }
}
```

### 8.2 è®¿é—®æ§åˆ¶

1. **APIé™æµ**ï¼š
   - ä¸Šä¼ æ¥å£ï¼šæ¯ç”¨æˆ· 10æ¬¡/å°æ—¶
   - åˆ—è¡¨æ¥å£ï¼š100æ¬¡/åˆ†é’Ÿ

2. **å®¡è®¡æ—¥å¿—**ï¼š
   - è®°å½•æ‰€æœ‰æ•æ„Ÿæ“ä½œ
   - ç»„ä»¶ä¸Šä¼ ã€åˆ é™¤ã€å‘å¸ƒ

---

## ä¹ã€æ€§èƒ½ä¼˜åŒ–

### 9.1 æ•°æ®åº“ä¼˜åŒ–

1. **ç´¢å¼•ä¼˜åŒ–**ï¼š
   - ç»„ä»¶åˆ—è¡¨æŸ¥è¯¢ï¼šcategory_id, status, created_at
   - å…¨æ–‡æœç´¢ï¼šä½¿ç”¨PostgreSQLçš„tsvector

2. **æŸ¥è¯¢ä¼˜åŒ–**ï¼š
   - åˆ—è¡¨æŸ¥è¯¢ä½¿ç”¨åˆ†é¡µ
   - é¿å…N+1æŸ¥è¯¢ï¼Œä½¿ç”¨JOINæˆ–DataLoader
   - ç»Ÿè®¡æ•°æ®ä½¿ç”¨èšåˆè¡¨

### 9.2 å‰ç«¯åŠ è½½ä¼˜åŒ–

1. **æ‡’åŠ è½½**ï¼š
   - ç»„ä»¶åˆ—è¡¨è™šæ‹Ÿæ»šåŠ¨
   - ç»„ä»¶èµ„æºæŒ‰éœ€åŠ è½½

2. **èµ„æºé¢„åŠ è½½**ï¼š
   - å¸¸ç”¨ç»„ä»¶é¢„åŠ è½½
   - DNSé¢„è§£æ

3. **Bundleä¼˜åŒ–**ï¼š
   - ç»„ä»¶ä»£ç åˆ†å‰²
   - Tree Shaking

---

## åä¸€ã€é¡¹ç›®ç°æœ‰åŸºç¡€è®¾æ–½

åœ¨å®ç°ç»„ä»¶ç®¡ç†æ¨¡å—ä¹‹å‰ï¼Œéœ€è¦äº†è§£é¡¹ç›®å·²æœ‰çš„å…¬å…±åŸºç¡€è®¾æ–½ï¼Œä»¥ä¾¿å¤ç”¨å’Œä¿æŒä¸€è‡´æ€§ã€‚

### 11.1 å…±äº«æ¨¡å—ï¼ˆsrc/shared/ï¼‰

#### 11.1.1 é…ç½®ç®¡ç†ï¼ˆconfig/ï¼‰

é¡¹ç›®ä½¿ç”¨ `@nestjs/config` è¿›è¡Œé…ç½®ç®¡ç†ï¼Œå·²æœ‰ä»¥ä¸‹é…ç½®æ¨¡å—ï¼š

```typescript
// å·²æœ‰é…ç½®
;-database.config.ts - // MySQL æ•°æ®åº“é…ç½®
  redis.config.ts - // Redis é…ç½®
  jwt.config.ts - // JWT è®¤è¯é…ç½®
  oss.config.ts - // é˜¿é‡Œäº‘ OSS é…ç½®ï¼ˆå·²é›†æˆï¼‰
  bullmq.config.ts - // BullMQ ä»»åŠ¡é˜Ÿåˆ—é…ç½®
  winston.config.ts // Winston æ—¥å¿—é…ç½®
```

#### 11.1.2 å…±äº«æœåŠ¡ï¼ˆservices/ï¼‰

```typescript
// OSSService - å·²å®ç°çš„é˜¿é‡Œäº‘ OSS æœåŠ¡
@Injectable()
export class OSSService {
  // ç”Ÿæˆä¸Šä¼ ç­¾å
  generateSignature(fileType: OSSFileType): IOSSSignatureParams

  // ä¸Šä¼ æ–‡ä»¶
  async uploadFile(file: Buffer, fileName: string, dir: string): Promise<string>

  // åˆ é™¤æ–‡ä»¶
  async deleteFile(objectName: string): Promise<void>

  // ç”Ÿæˆä¸´æ—¶è®¿é—®URL
  generateTempUrl(objectName: string, expiresIn: number): string
}

// UserPermissionsService - ç”¨æˆ·æƒé™æœåŠ¡
// TokenBlacklistService - Token é»‘åå•æœåŠ¡
// DatabaseHealthService - æ•°æ®åº“å¥åº·æ£€æŸ¥
```

#### 11.1.3 åŸºç¡€å®ä½“ï¼ˆentities/ï¼‰

æ‰€æœ‰å®ä½“ç»§æ‰¿è‡ª `BaseEntity`ï¼Œè‡ªåŠ¨åŒ…å«ä»¥ä¸‹å­—æ®µï¼š

```typescript
export abstract class BaseEntity extends TypeOrmBase {
  @PrimaryGeneratedColumn()
  id: number // æ³¨æ„ï¼šä½¿ç”¨ INT è‡ªå¢ IDï¼Œè€Œé UUID

  @CreateDateColumn({ name: 'created_at' })
  createdAt: Date

  @UpdateDateColumn({ name: 'updated_at' })
  updatedAt: Date

  @DeleteDateColumn({ name: 'deleted_at', nullable: true })
  deletedAt?: Date // æ”¯æŒè½¯åˆ é™¤
}
```

#### 11.1.4 ç»Ÿä¸€å“åº”æ ¼å¼ï¼ˆdto/base-response.dto.tsï¼‰

æ‰€æœ‰ API å“åº”å¿…é¡»ä½¿ç”¨ `BaseResponseDto` å°è£…ï¼š

```typescript
export class BaseResponseDto<T = any> {
  success: boolean
  message?: string
  data?: T
  timestamp: string

  static success<T>(data?: T, message?: string): BaseResponseDto<T>
  static error(message: string): BaseResponseDto
}
```

#### 11.1.5 åˆ†é¡µå“åº”ï¼ˆdto/paginated-response.dto.tsï¼‰

åˆ—è¡¨æ¥å£ä½¿ç”¨ç»Ÿä¸€åˆ†é¡µæ ¼å¼ï¼š

```typescript
export class PaginatedResponseDto<T> {
  items: T[]
  total: number
  page: number
  pageSize: number
  totalPages: number
}
```

#### 11.1.6 æƒé™è£…é¥°å™¨ï¼ˆdecorators/ï¼‰

```typescript
// è§’è‰²æ£€æŸ¥
@Roles('admin', 'developer')

// æƒé™æ£€æŸ¥
@RequirePermissions('component:create')
```

#### 11.1.7 å¼‚å¸¸å¤„ç†ï¼ˆexceptions/ï¼‰

```typescript
// ä¸šåŠ¡å¼‚å¸¸
throw new BusinessException('ç»„ä»¶å·²å­˜åœ¨', ErrorCode.COMPONENT_EXISTS)
```

### 11.2 ä¸­é—´ä»¶å’Œå®ˆå«

```typescript
// å·²æœ‰ä¸­é—´ä»¶
;-RateLimitMiddleware - // é™æµä¸­é—´ä»¶
  RequestIdMiddleware - // è¯·æ±‚IDè¿½è¸ª
  // å·²æœ‰å®ˆå«
  JwtAuthGuard - // JWT è®¤è¯å®ˆå«ï¼ˆå…¨å±€ï¼‰
  PermissionsGuard - // æƒé™å®ˆå«
  RolesGuard // è§’è‰²å®ˆå«
```

### 11.3 æ—¥å¿—ç³»ç»Ÿ

é¡¹ç›®ä½¿ç”¨ Winston è¿›è¡Œæ—¥å¿—ç®¡ç†ï¼Œæ‰€æœ‰ Service æ³¨å…¥ Loggerï¼š

```typescript
constructor(
  @Inject(WINSTON_MODULE_PROVIDER)
  private readonly logger: Logger
) {}

this.logger.info('ç»„ä»¶ä¸Šä¼ æˆåŠŸ', { componentId, version })
this.logger.error('ç»„ä»¶ä¸Šä¼ å¤±è´¥', { error, componentId })
```

### 11.4 ä»»åŠ¡é˜Ÿåˆ—ï¼ˆBullMQï¼‰

é¡¹ç›®å·²é›†æˆ BullMQï¼Œå¯ç”¨äºå¤„ç†å¼‚æ­¥ä»»åŠ¡ï¼š

```typescript
// å®šä¹‰é˜Ÿåˆ—
export const COMPONENT_QUEUE = 'component:processing'

// æ·»åŠ ä»»åŠ¡
await this.queue.add('upload', {
  componentId,
  tempPath,
  userId
})
```

---

## åäºŒã€æŠ€æœ¯å®ç°è¦ç‚¹

### 12.1 NestJSæ¨¡å—ç»“æ„

```
src/modules/components/
â”œâ”€â”€ components.module.ts                     # ä¸»æ¨¡å—
â”œâ”€â”€ controllers/
â”‚   â”œâ”€â”€ component-categories.controller.ts   # åˆ†ç±»ç®¡ç†æ¥å£
â”‚   â”œâ”€â”€ components.controller.ts             # ç»„ä»¶ç®¡ç†æ¥å£
â”‚   â””â”€â”€ component-versions.controller.ts     # ç‰ˆæœ¬ç®¡ç†æ¥å£
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ component-categories.service.ts      # åˆ†ç±»æœåŠ¡
â”‚   â”œâ”€â”€ components.service.ts                # ç»„ä»¶æœåŠ¡
â”‚   â”œâ”€â”€ component-versions.service.ts        # ç‰ˆæœ¬æœåŠ¡
â”‚   â”œâ”€â”€ component-upload.service.ts          # ä¸Šä¼ å¤„ç†æœåŠ¡
â”‚   â””â”€â”€ component-validator.service.ts       # æ ¡éªŒæœåŠ¡
â”œâ”€â”€ entities/
â”‚   â”œâ”€â”€ component-category.entity.ts         # åˆ†ç±»å®ä½“ï¼ˆç»§æ‰¿ BaseEntityï¼‰
â”‚   â”œâ”€â”€ component.entity.ts                  # ç»„ä»¶å®ä½“ï¼ˆç»§æ‰¿ BaseEntityï¼‰
â”‚   â””â”€â”€ component-version.entity.ts          # ç‰ˆæœ¬å®ä½“ï¼ˆç»§æ‰¿ BaseEntityï¼‰
â”œâ”€â”€ dto/
â”‚   â”œâ”€â”€ request/                             # è¯·æ±‚ DTO
â”‚   â”‚   â”œâ”€â”€ upload-component.dto.ts          # ä¸Šä¼ ç»„ä»¶ DTO
â”‚   â”‚   â”œâ”€â”€ query-components.dto.ts          # æŸ¥è¯¢ç»„ä»¶åˆ—è¡¨ DTO
â”‚   â”‚   â”œâ”€â”€ create-category.dto.ts           # åˆ›å»ºåˆ†ç±» DTO
â”‚   â”‚   â””â”€â”€ update-category.dto.ts           # æ›´æ–°åˆ†ç±» DTO
â”‚   â”œâ”€â”€ response/                            # å“åº” DTO
â”‚   â”‚   â”œâ”€â”€ component-list.dto.ts            # ç»„ä»¶åˆ—è¡¨å“åº”
â”‚   â”‚   â”œâ”€â”€ component-detail.dto.ts          # ç»„ä»¶è¯¦æƒ…å“åº”
â”‚   â”‚   â”œâ”€â”€ version-list.dto.ts              # ç‰ˆæœ¬åˆ—è¡¨å“åº”
â”‚   â”‚   â””â”€â”€ category-tree.dto.ts             # åˆ†ç±»æ ‘å“åº”
â”‚   â””â”€â”€ internal/                            # å†…éƒ¨ DTO
â”‚       â”œâ”€â”€ component-meta.dto.ts            # component.meta.json æ˜ å°„
â”‚       â”œâ”€â”€ validation-result.dto.ts         # æ ¡éªŒç»“æœ
â”‚       â””â”€â”€ upload-result.dto.ts             # ä¸Šä¼ ç»“æœ
â”œâ”€â”€ guards/
â”‚   â””â”€â”€ component-permission.guard.ts        # æƒé™å®ˆå«
â””â”€â”€ constants/
    â”œâ”€â”€ validation-rules.ts                  # æ ¡éªŒè§„åˆ™å¸¸é‡
    â”œâ”€â”€ file-types.ts                        # æ–‡ä»¶ç±»å‹å¸¸é‡
    â””â”€â”€ component-status.enum.ts             # ç»„ä»¶çŠ¶æ€æšä¸¾
```

**è¯´æ˜**ï¼š

1. **åˆ é™¤çš„å†…å®¹**ï¼š
   - `component-meta-parser.service.ts`ï¼šåˆå¹¶åˆ° `component-validator.service.ts`
   - `component-scanner.service.ts`ï¼šå®‰å…¨æ‰«ææš‚ä¸å®ç°
   - `oss.service.ts`ï¼šä½¿ç”¨å…±äº«æ¨¡å—çš„ `OSSService`ï¼ˆ`src/shared/services/oss.service.ts`ï¼‰
   - `component-statistics.service.ts`ï¼šç»Ÿè®¡åŠŸèƒ½è¾ƒç®€å•ï¼Œåˆå¹¶åˆ° `components.service.ts`
   - `component-usage-log.entity.ts`ï¼šå·²åˆ é™¤ usage logs è¡¨

2. **DTO ç»„ç»‡**ï¼š
   - æŒ‰ç”¨é€”åˆ†ä¸º `request/`ã€`response/`ã€`internal/` ä¸‰ä¸ªç›®å½•
   - æ›´æ¸…æ™°çš„èŒè´£åˆ’åˆ†

### 11.2 å…³é”®æŠ€æœ¯ç‚¹

1. **æ–‡ä»¶ä¸Šä¼ å¤„ç†**ï¼š

   ```typescript
   // ä½¿ç”¨ multer æ¥æ”¶æ–‡ä»¶
   import { FileInterceptor } from '@nestjs/platform-express'
   import { diskStorage } from 'multer'

   // é…ç½®ä¸´æ—¶å­˜å‚¨
   const uploadOptions = {
     storage: diskStorage({
       destination: './temp/uploads',
       filename: (req, file, cb) => {
         const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1e9)
         cb(null, `component-${uniqueSuffix}.zip`)
       }
     }),
     limits: {
       fileSize: 50 * 1024 * 1024 // 50MB
     },
     fileFilter: (req, file, cb) => {
       if (file.mimetype === 'application/zip') {
         cb(null, true)
       } else {
         cb(new Error('åªæ”¯æŒ .zip æ ¼å¼'), false)
       }
     }
   }
   ```

2. **ç»„ä»¶åŒ…è§£å‹**ï¼š

   ```typescript
   import * as AdmZip from 'adm-zip';

   async extractPackage(zipPath: string): Promise<string> {
     const zip = new AdmZip(zipPath);
     const tempDir = path.join('./temp/extracted', uuidv4());

     // è§£å‹å‰æ£€æŸ¥æ¡ç›®æ•°é‡ï¼ˆé˜²æ­¢å‹ç¼©ç‚¸å¼¹ï¼‰
     const entries = zip.getEntries();
     if (entries.length > 1000) {
       throw new Error('æ–‡ä»¶æ•°é‡è¶…è¿‡é™åˆ¶');
     }

     zip.extractAllTo(tempDir, true);
     return tempDir;
   }
   ```

3. **component.meta.json è§£æå’Œæ ¡éªŒ**ï¼š

   ```typescript
   import { plainToClass } from 'class-transformer';
   import { validate } from 'class-validator';

   async parseAndValidateMetaJson(jsonPath: string): Promise<ComponentMetaDto> {
     const content = await fs.readFile(jsonPath, 'utf-8');
     const data = JSON.parse(content);

     // è½¬æ¢ä¸º DTO
     const dto = plainToClass(ComponentMetaDto, data);

     // ä½¿ç”¨ class-validator æ ¡éªŒ
     const errors = await validate(dto);
     if (errors.length > 0) {
       throw new ValidationException(errors);
     }

     // æ ¡éªŒåˆ†ç±»æ˜¯å¦æœ‰æ•ˆ
     await this.validateClassification(dto.classification);

     // æ ¡éªŒæ–‡ä»¶å¼•ç”¨æ˜¯å¦å­˜åœ¨
     await this.validateFileReferences(dto.files);

     return dto;
   }
   ```

4. **OSS ä¸Šä¼ ï¼ˆä½¿ç”¨é¡¹ç›®ç°æœ‰çš„ OSSServiceï¼‰**ï¼š

   ```typescript
   import { OSSService } from '@/shared/services/oss.service';

   constructor(
     private readonly ossService: OSSService
   ) {}

   async uploadToOSS(
     localPath: string,
     componentId: string,
     version: string
   ): Promise<string> {
     // è¯»å–æ–‡ä»¶
     const fileBuffer = await fs.readFile(localPath);

     // ç”Ÿæˆ OSS ç›®å½•ï¼ˆåµŒå¥—ç»“æ„ï¼šBarChart/1.0.0/ï¼‰
     // abd-cli æ‰“åŒ…æ˜¯æ‰å¹³çš„ï¼Œä½† OSS å­˜å‚¨é‡‡ç”¨åµŒå¥—ç»“æ„
     const dir = `components/${componentId}/${version}`;
     const fileName = path.basename(localPath);

     // ä½¿ç”¨é¡¹ç›®å·²æœ‰çš„ OSSService ä¸Šä¼ 
     const url = await this.ossService.uploadFile(
       fileBuffer,
       fileName,
       dir
     );

     return url;
   }

   // å®Œæ•´ä¸Šä¼ æµç¨‹
   async uploadComponentPackage(
     tempDir: string,
     meta: ComponentMetaDto
   ): Promise<OssUploadResult> {
     const { id: componentId, version, files } = meta;
     const baseDir = `components/${componentId}/${version}`;

     const uploadedFiles = {
       entryUrl: '',
       styleUrl: '',
       previewUrl: '',
       otherFiles: []
     };

     // ä¸Šä¼ æ‰€æœ‰æ–‡ä»¶
     const allFiles = await this.getAllFiles(tempDir);
     for (const file of allFiles) {
       const relativePath = path.relative(tempDir, file);
       const fileBuffer = await fs.readFile(file);

       const url = await this.ossService.uploadFile(
         fileBuffer,
         relativePath,
         baseDir
       );

       // è®°å½•ä¸»è¦æ–‡ä»¶çš„ URL
       if (relativePath === files.entry) {
         uploadedFiles.entryUrl = url;
       } else if (relativePath === files.style) {
         uploadedFiles.styleUrl = url;
       } else if (relativePath === files.preview) {
         uploadedFiles.previewUrl = url;
       } else {
         uploadedFiles.otherFiles.push({ path: relativePath, url });
       }
     }

     return {
       ossBasePath: `${baseDir}/`,
       ...uploadedFiles
     };
   }
   ```

5. **ç‰ˆæœ¬ç®¡ç†**ï¼š

   ```typescript
   import * as semver from 'semver';

   // è¯­ä¹‰åŒ–ç‰ˆæœ¬å·æ ¡éªŒ
   validateVersion(version: string): boolean {
     return semver.valid(version) !== null;
   }

   // ç‰ˆæœ¬æ¯”è¾ƒ
   compareVersions(v1: string, v2: string): number {
     return semver.compare(v1, v2);
   }
   ```

6. **å…¨æ–‡æœç´¢**ï¼š
   - PostgreSQLçš„å…¨æ–‡æœç´¢ï¼ˆtsvectorï¼‰
   - æˆ–é›†æˆElasticsearch

7. **å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—**ï¼š

   ```typescript
   // ä½¿ç”¨BullMQå¤„ç†è€—æ—¶ä»»åŠ¡
   import { Queue } from 'bullmq'

   // æ·»åŠ ä»»åŠ¡åˆ°é˜Ÿåˆ—
   await this.uploadQueue.add('process-component', {
     componentId,
     versionId,
     tempDir
   })
   ```

8. **ä¸´æ—¶æ–‡ä»¶æ¸…ç†**ï¼š

   ```typescript
   // å®šæ—¶æ¸…ç†ä¸´æ—¶æ–‡ä»¶
   @Cron('0 */6 * * *')  // æ¯6å°æ—¶æ‰§è¡Œä¸€æ¬¡
   async cleanupTempFiles() {
     const tempDir = './temp';
     const maxAge = 6 * 60 * 60 * 1000;  // 6å°æ—¶

     const files = await fs.readdir(tempDir);
     for (const file of files) {
       const filePath = path.join(tempDir, file);
       const stats = await fs.stat(filePath);

       if (Date.now() - stats.mtimeMs > maxAge) {
         await fs.rm(filePath, { recursive: true });
       }
     }
   }
   ```

---

## åäºŒã€å‰ç«¯é›†æˆæ–¹æ¡ˆ

### 12.1 ç»„ä»¶åŠ è½½å™¨ï¼ˆComponent Loaderï¼‰

å‰ç«¯éœ€è¦å®ç°ä¸€ä¸ªç»„ä»¶åŠ è½½å™¨ï¼ŒåŠ¨æ€åŠ è½½è¿œç¨‹ç»„ä»¶ï¼š

```typescript
class ComponentLoader {
  private loadedComponents = new Map()

  async loadComponent(component: ComponentInfo) {
    const { name, latestVersion } = component

    // æ£€æŸ¥æ˜¯å¦å·²åŠ è½½
    if (this.loadedComponents.has(name)) {
      return this.loadedComponents.get(name)
    }

    // åŠ è½½CSS
    if (latestVersion.mainCssUrl) {
      await this.loadCSS(latestVersion.mainCssUrl)
    }

    // åŠ è½½JS
    const module = await this.loadJS(latestVersion.mainJsUrl)

    // æ³¨å†Œç»„ä»¶
    this.loadedComponents.set(name, module)

    return module
  }

  private async loadCSS(url: string) {
    return new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      link.onload = resolve
      link.onerror = reject
      document.head.appendChild(link)
    })
  }

  private async loadJS(url: string) {
    return new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.onload = () => {
        // å‡è®¾ç»„ä»¶å¯¼å‡ºåˆ°å…¨å±€å˜é‡
        resolve(window[component.name])
      }
      script.onerror = reject
      document.body.appendChild(script)
    })
  }
}
```

### 12.2 ç»„ä»¶ç®¡ç†é¡µé¢åŠŸèƒ½

1. **ç»„ä»¶åˆ—è¡¨é¡µ**ï¼š
   - åˆ†ç±»ç­›é€‰
   - æœç´¢åŠŸèƒ½
   - çŠ¶æ€ç­›é€‰
   - æ‰¹é‡æ“ä½œ

2. **ç»„ä»¶ä¸Šä¼ é¡µ**ï¼š
   - æ‹–æ‹½ä¸Šä¼ 
   - è¿›åº¦æ˜¾ç¤º
   - è¡¨å•å¡«å†™ï¼ˆå…ƒæ•°æ®ï¼‰
   - é¢„è§ˆåŠŸèƒ½

3. **ç»„ä»¶è¯¦æƒ…é¡µ**ï¼š
   - ç‰ˆæœ¬åˆ—è¡¨
   - ä½¿ç”¨ç»Ÿè®¡
   - æ›´æ–°æ—¥å¿—
   - åœ¨çº¿é¢„è§ˆ

---

## åä¸‰ã€æµ‹è¯•ç­–ç•¥

### 13.1 å•å…ƒæµ‹è¯•

- Serviceå±‚é€»è¾‘æµ‹è¯•
- æƒé™æ ¡éªŒæµ‹è¯•
- æ•°æ®éªŒè¯æµ‹è¯•

### 13.2 é›†æˆæµ‹è¯•

- APIæ¥å£æµ‹è¯•ï¼ˆä½¿ç”¨Brunoï¼‰
- OSSä¸Šä¼ æµç¨‹æµ‹è¯•
- ç¼“å­˜åŠŸèƒ½æµ‹è¯•

---

## åå››ã€éƒ¨ç½²ä¸è¿ç»´

### 14.1 éƒ¨ç½²æ¸…å•

1. **æ•°æ®åº“**ï¼š
   - æ‰§è¡Œæ•°æ®åº“è¿ç§»è„šæœ¬
   - åˆ›å»ºåˆå§‹åˆ†ç±»æ•°æ®

2. **OSSé…ç½®**ï¼š
   - åˆ›å»ºBucket
   - é…ç½®è·¨åŸŸ
   - é…ç½®CDN

3. **ç¯å¢ƒå˜é‡**ï¼š
   ```
   OSS_ACCESS_KEY_ID=xxx
   OSS_ACCESS_KEY_SECRET=xxx
   OSS_BUCKET=platform-components
   OSS_REGION=oss-cn-hangzhou
   OSS_CDN_DOMAIN=https://cdn.example.com
   ```

### 14.2 è¿ç»´æŒ‡å—

1. **æ—¥å¸¸ç»´æŠ¤**ï¼š
   - æ¸…ç†è¿‡æœŸç¼“å­˜
   - å½’æ¡£æ—§ç‰ˆæœ¬ç»„ä»¶
   - ç›‘æ§å­˜å‚¨ä½¿ç”¨é‡

2. **æ•…éšœå¤„ç†**ï¼š
   - OSSä¸å¯ç”¨ï¼šé™çº§ä½¿ç”¨ç¼“å­˜
   - æ•°æ®åº“æ…¢æŸ¥è¯¢ï¼šæ£€æŸ¥ç´¢å¼•
   - ä¸Šä¼ å¤±è´¥ï¼šæ£€æŸ¥OSSé…ç½®

---

## åäº”ã€åç»­æ‰©å±•

### 15.1 Phase 2åŠŸèƒ½

1. **ç»„ä»¶å¸‚åœº**ï¼š
   - ç¬¬ä¸‰æ–¹å¼€å‘è€…å…¥é©»
   - ç»„ä»¶è¯„åˆ†å’Œè¯„è®º
   - ç»„ä»¶è´­ä¹°ï¼ˆä»˜è´¹ç»„ä»¶ï¼‰

2. **ç»„ä»¶åä½œ**ï¼š
   - ç»„ä»¶ForkåŠŸèƒ½
   - ç»„ä»¶æ¨¡æ¿
   - ç»„ä»¶åº“ï¼ˆComponent Libraryï¼‰

3. **æ™ºèƒ½æ¨è**ï¼š
   - åŸºäºä½¿ç”¨å†å²æ¨è
   - ç›¸ä¼¼ç»„ä»¶æ¨è

### 15.2 Phase 3åŠŸèƒ½

1. **å¯è§†åŒ–ç¼–è¾‘å™¨**ï¼š
   - ç»„ä»¶å±æ€§å¯è§†åŒ–é…ç½®
   - å®æ—¶é¢„è§ˆ
   - æ ·å¼ç¼–è¾‘å™¨

2. **ç»„ä»¶åˆ†æ**ï¼š
   - ç»„ä»¶ä½¿ç”¨çƒ­åŠ›å›¾
   - æ€§èƒ½åˆ†ææŠ¥å‘Š
   - ä¾èµ–å…³ç³»åˆ†æ

---

## åå…­ã€FAQ

### Q1: å¦‚ä½•ç¡®ä¿ç»„ä»¶çš„å®‰å…¨æ€§ï¼Ÿ

A: é€šè¿‡å¤šå±‚é˜²æŠ¤ï¼šæ–‡ä»¶ç±»å‹ç™½åå•ã€é™æ€ä»£ç åˆ†æã€æ²™ç®±è¿è¡Œã€æƒé™éš”ç¦»ã€‚

### Q2: å¦‚ä½•å¤„ç†ç»„ä»¶ç‰ˆæœ¬å…¼å®¹æ€§ï¼Ÿ

A: éµå¾ªè¯­ä¹‰åŒ–ç‰ˆæœ¬è§„èŒƒï¼Œmajorç‰ˆæœ¬ç ´åæ€§å˜æ›´éœ€æ‰‹åŠ¨å‡çº§ï¼Œminorå’Œpatchè‡ªåŠ¨å…¼å®¹ã€‚

### Q3: OSSæˆæœ¬å¦‚ä½•æ§åˆ¶ï¼Ÿ

A: ä½¿ç”¨ç”Ÿå‘½å‘¨æœŸç­–ç•¥ï¼Œè‡ªåŠ¨å½’æ¡£ä½é¢‘è®¿é—®ç»„ä»¶ï¼›æ¸…ç†æœªå‘å¸ƒçš„è‰ç¨¿èµ„æºã€‚

### Q4: å¦‚ä½•æ”¯æŒç§æœ‰ç»„ä»¶ï¼Ÿ

A: é€šè¿‡æƒé™æ§åˆ¶ï¼Œç»„ä»¶å…³è”åˆ°ç‰¹å®šå›¢é˜Ÿæˆ–é¡¹ç›®ï¼Œä»…æˆæƒç”¨æˆ·å¯è§ã€‚

### Q5: ç»„ä»¶æ›´æ–°åï¼Œå·²ä½¿ç”¨çš„é¡¹ç›®æ˜¯å¦è‡ªåŠ¨æ›´æ–°ï¼Ÿ

A: é»˜è®¤ä¸è‡ªåŠ¨æ›´æ–°ï¼ˆç‰ˆæœ¬é”å®šï¼‰ï¼Œç”¨æˆ·å¯é€‰æ‹©æ‰‹åŠ¨å‡çº§æˆ–å¼€å¯è‡ªåŠ¨å‡çº§ï¼ˆä»…patchç‰ˆæœ¬ï¼‰ã€‚

---

## é™„å½•

### A. æ•°æ®åº“å®Œæ•´SQLï¼ˆMySQL 8.0+ï¼‰

è§ `scripts/migrations/component-management-schema.sql`

**æ³¨æ„äº‹é¡¹**ï¼š

- æ‰€æœ‰è¡¨ä½¿ç”¨ `InnoDB` å¼•æ“
- å­—ç¬¦é›†ï¼š`utf8mb4`ï¼Œæ’åºè§„åˆ™ï¼š`utf8mb4_unicode_ci`
- ä¸»é”®ä½¿ç”¨ `INT AUTO_INCREMENT`ï¼ˆä¸é¡¹ç›®ç°æœ‰è¡¨ä¿æŒä¸€è‡´ï¼‰
- å¸ƒå°”ç±»å‹ä½¿ç”¨ `TINYINT(1)`
- JSON å­—æ®µä½¿ç”¨ `JSON` ç±»å‹ï¼ˆMySQL 5.7.8+ï¼‰
- ç»§æ‰¿ `BaseEntity` çš„å®ä½“åŒ…å« `deleted_at` å­—æ®µæ”¯æŒè½¯åˆ é™¤

### B. APIæ¥å£å®Œæ•´æ–‡æ¡£

è§ `docs/api/component-management-api.md`

### C. ç»„ä»¶è§„èŒƒæ–‡æ¡£

è§ `docs/component-specification.md`

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**åˆ›å»ºæ—¥æœŸ**: 2025-12-20
**ä½œè€…**: GitHub Copilot
**æ›´æ–°æ—¥æœŸ**: 2025-12-20
