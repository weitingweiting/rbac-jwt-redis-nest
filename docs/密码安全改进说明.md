# ç”¨æˆ·å¯†ç å®‰å…¨æ”¹è¿›

## ğŸ”’ å®‰å…¨æ”¹è¿›æ¦‚è¿°

æœ¬æ¬¡æ›´æ–°å½»åº•è§£å†³äº†ç”¨æˆ·å¯†ç å®‰å…¨é—®é¢˜ï¼Œç¡®ä¿å¯†ç å­—æ®µåœ¨ä»»ä½•æƒ…å†µä¸‹éƒ½ä¸ä¼šé€šè¿‡ API è¿”å›ã€‚

## âœ… å·²å®æ–½çš„æ”¹è¿›

### 1. å…¨å±€å¯ç”¨ ClassSerializerInterceptor

**æ–‡ä»¶**: `src/main.ts`

```typescript
import { ClassSerializerInterceptor } from '@nestjs/common'
import { Reflector } from '@nestjs/core'

// å…¨å±€å¯ç”¨ ClassSerializerInterceptorï¼Œè‡ªåŠ¨åº”ç”¨ @Exclude è£…é¥°å™¨
app.useGlobalInterceptors(new ClassSerializerInterceptor(app.get(Reflector)))
```

**ä½œç”¨**: è‡ªåŠ¨å¤„ç† User entity ä¸­çš„ `@Exclude()` è£…é¥°å™¨ï¼Œåœ¨åºåˆ—åŒ–æ—¶æ’é™¤å¯†ç å­—æ®µã€‚

### 2. User Entity å·²æœ‰ä¿æŠ¤

**æ–‡ä»¶**: `src/shared/entities/user.entity.ts`

```typescript
@Column()
@Exclude() // åºåˆ—åŒ–æ—¶è‡ªåŠ¨æ’é™¤å¯†ç å­—æ®µ
password!: string
```

### 3. ç‹¬ç«‹çš„å¯†ç ç®¡ç†åŠŸèƒ½

**æ–‡ä»¶**: `src/modules/users/users.service.ts`

æ–°å¢ä¸‰ä¸ªæ–¹æ³•ï¼š

#### a) ç”¨æˆ·ä¿®æ”¹å¯†ç 

```typescript
async changePassword(userId: number, oldPassword: string, newPassword: string): Promise<void>
```

- âœ… éªŒè¯åŸå¯†ç 
- âœ… æ–°æ—§å¯†ç ä¸èƒ½ç›¸åŒ
- âœ… å¯†ç ä½¿ç”¨ SHA-256 åŠ å¯†
- âœ… ä¿®æ”¹åæ¸…ç©ºç”¨æˆ·ç¼“å­˜

#### b) ç®¡ç†å‘˜é‡ç½®å¯†ç 

```typescript
async resetPassword(userId: number, newPassword: string): Promise<void>
```

- âœ… ä»…ç®¡ç†å‘˜å¯ç”¨
- âœ… ç›´æ¥é‡ç½®æ— éœ€éªŒè¯æ—§å¯†ç 
- âœ… é‡ç½®åæ¸…ç©ºç”¨æˆ·ç¼“å­˜

#### c) å†…éƒ¨å¯†ç éªŒè¯æ–¹æ³•

```typescript
private hashPassword(password: string): string
private verifyPassword(password: string, hashedPassword: string): boolean
```

### 4. æ–°çš„ DTO

**æ–‡ä»¶**: `src/modules/users/dto/change-password.dto.ts`

```typescript
// ç”¨æˆ·ä¿®æ”¹å¯†ç 
export class ChangePasswordDto {
  oldPassword: string // åŸå¯†ç 
  newPassword: string // æ–°å¯†ç ï¼ˆå¿…é¡»åŒ…å«å­—æ¯å’Œæ•°å­—ï¼Œæœ€å°‘6ä½ï¼‰
}

// ç®¡ç†å‘˜é‡ç½®å¯†ç 
export class ResetPasswordDto {
  newPassword: string // æ–°å¯†ç ï¼ˆå¿…é¡»åŒ…å«å­—æ¯å’Œæ•°å­—ï¼Œæœ€å°‘6ä½ï¼‰
}
```

### 5. æ–°çš„ API æ¥å£

**æ–‡ä»¶**: `src/modules/users/users.controller.ts`

#### a) ç”¨æˆ·ä¿®æ”¹è‡ªå·±çš„å¯†ç 

```http
PUT /api/v1/users/change-password
Authorization: Bearer {access_token}
Content-Type: application/json

{
  "oldPassword": "oldPassword123",
  "newPassword": "newPassword123"
}
```

**å“åº”**:

```json
{
  "success": true,
  "message": "å¯†ç ä¿®æ”¹æˆåŠŸï¼Œè¯·é‡æ–°ç™»å½•"
}
```

#### b) ç®¡ç†å‘˜é‡ç½®ç”¨æˆ·å¯†ç 

```http
PUT /api/v1/users/:id/reset-password
Authorization: Bearer {admin_token}
Content-Type: application/json

{
  "newPassword": "resetPassword123"
}
```

**æƒé™è¦æ±‚**:

- éœ€è¦ `users:update` æƒé™
- éœ€è¦ `admin` è§’è‰²

**å“åº”**:

```json
{
  "success": true,
  "message": "ç”¨æˆ· 2 çš„å¯†ç å·²é‡ç½®"
}
```

## ğŸ›¡ï¸ å¯†ç éªŒè¯è§„åˆ™

- âœ… æœ€å°‘ 6 ä¸ªå­—ç¬¦
- âœ… å¿…é¡»åŒ…å«å­—æ¯å’Œæ•°å­—
- âœ… æ”¯æŒç‰¹æ®Šå­—ç¬¦ï¼š`@$!%*#?&`
- âœ… æ­£åˆ™è¡¨è¾¾å¼ï¼š`/^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d@$!%*#?&]+$/`

## ğŸ“ UpdateUserDto å®‰å…¨ä¿æŠ¤

**æ–‡ä»¶**: `src/modules/users/dto/user.dto.ts`

```typescript
export class UpdateUserDto extends PartialType(OmitType(BaseUserDto, ['password'] as const))
```

- âœ… æ˜ç¡®æ’é™¤ password å­—æ®µ
- âœ… å¯†ç ä¿®æ”¹å¿…é¡»é€šè¿‡ä¸“ç”¨æ¥å£

## ğŸ” å·²æ’æŸ¥çš„æ–‡ä»¶

### ä¸ä¼šè¿”å›å¯†ç çš„åœ°æ–¹ï¼š

1. âœ… `UsersService.findAllWithPagination()` - ä½¿ç”¨ ClassSerializer
2. âœ… `UsersService.findOneUser()` - ä½¿ç”¨ ClassSerializer
3. âœ… `UsersService.create()` - ä½¿ç”¨ ClassSerializer
4. âœ… `UsersService.update()` - ä½¿ç”¨ ClassSerializer
5. âœ… `UsersService.assignRoles()` - ä½¿ç”¨ ClassSerializer
6. âœ… `AuthService.login()` - æ‰‹åŠ¨æ’é™¤ï¼š`const { password: _, ...userWithoutPassword } = user`

### éœ€è¦å¯†ç å­—æ®µçš„åœ°æ–¹ï¼ˆå®‰å…¨ï¼‰ï¼š

1. âœ… `AuthService.register()` - ä»…ç”¨äºåˆ›å»ºï¼Œä¸è¿”å›
2. âœ… `AuthService.login()` - ä»…ç”¨äºéªŒè¯ï¼Œè¿”å›æ—¶å·²æ’é™¤
3. âœ… `UsersService.changePassword()` - ä½¿ç”¨ `select: ['id', 'password']` ä»…æŸ¥è¯¢éœ€è¦çš„å­—æ®µ

## ğŸ§ª æµ‹è¯•ç”¨ä¾‹

åˆ›å»ºäº† 3 ä¸ª Bruno API æµ‹è¯•ï¼š

1. `50-change-password-success.bru` - æˆåŠŸä¿®æ”¹å¯†ç 
2. `51-change-password-wrong-old-password.bru` - åŸå¯†ç é”™è¯¯
3. `60-reset-password-by-admin.bru` - ç®¡ç†å‘˜é‡ç½®å¯†ç 

## âš ï¸ æ³¨æ„äº‹é¡¹

### ç”¨æˆ·ä½¿ç”¨å¯†ç ä¿®æ”¹å

- ç”¨æˆ·éœ€è¦é‡æ–°ç™»å½•
- æƒé™ç¼“å­˜ä¼šè¢«æ¸…ç©º
- æ—§çš„ token ä»ç„¶æœ‰æ•ˆï¼ˆç›´åˆ°è¿‡æœŸï¼‰

### ç®¡ç†å‘˜é‡ç½®å¯†ç å

- è¢«é‡ç½®çš„ç”¨æˆ·éœ€è¦é‡æ–°ç™»å½•
- è¢«é‡ç½®çš„ç”¨æˆ·çš„æƒé™ç¼“å­˜ä¼šè¢«æ¸…ç©º

### å»ºè®®

å¦‚éœ€å¼ºåˆ¶ç”¨æˆ·ç«‹å³é€€å‡ºï¼Œå¯ä»¥ä½¿ç”¨ï¼š

```http
POST /api/v1/users/force-logout/:userId
```

## ğŸ“Š API å“åº”ç¤ºä¾‹

### è·å–ç”¨æˆ·åˆ—è¡¨ï¼ˆå¯†ç å·²æ’é™¤ï¼‰

```json
{
  "success": true,
  "data": {
    "message": "è·å–ç”¨æˆ·åˆ—è¡¨æˆåŠŸ",
    "data": [
      {
        "id": 14,
        "username": "weiting1",
        "avatarUrl": null,
        "createdAt": "2025-12-03T02:00:22.795Z",
        "roles": [...]
        // âŒ password å­—æ®µä¸ä¼šå‡ºç°
      }
    ]
  }
}
```

### è·å–å•ä¸ªç”¨æˆ·ï¼ˆå¯†ç å·²æ’é™¤ï¼‰

```json
{
  "success": true,
  "data": {
    "message": "è·å–ç”¨æˆ·è¯¦æƒ…æˆåŠŸ",
    "data": {
      "id": 14,
      "username": "weiting1",
      "avatarUrl": null,
      "roles": [...]
      // âŒ password å­—æ®µä¸ä¼šå‡ºç°
    }
  }
}
```

## ğŸš€ å¦‚ä½•æµ‹è¯•

1. å¯åŠ¨åº”ç”¨ï¼š

```bash
pnpm run start:dev
```

2. ä½¿ç”¨ Bruno è¿è¡Œæµ‹è¯•ç”¨ä¾‹ï¼š
   - `bruno-api-tests/Users/50-change-password-success.bru`
   - `bruno-api-tests/Users/51-change-password-wrong-old-password.bru`
   - `bruno-api-tests/Users/60-reset-password-by-admin.bru`

3. éªŒè¯ä»»ä½•ç”¨æˆ·ç›¸å…³çš„ API éƒ½ä¸ä¼šè¿”å›å¯†ç å­—æ®µ

## âœ¨ æ€»ç»“

é€šè¿‡ä»¥ä¸Šæ”¹è¿›ï¼Œé¡¹ç›®ç°åœ¨å…·å¤‡äº†å®Œå–„çš„å¯†ç å®‰å…¨æœºåˆ¶ï¼š

- âœ… å¯†ç æ°¸è¿œä¸ä¼šé€šè¿‡ API è¿”å›
- âœ… å¯†ç ä½¿ç”¨ SHA-256 åŠ å¯†å­˜å‚¨
- âœ… ç‹¬ç«‹çš„å¯†ç ä¿®æ”¹å’Œé‡ç½®æ¥å£
- âœ… ä¸¥æ ¼çš„å¯†ç éªŒè¯è§„åˆ™
- âœ… å¯†ç ä¿®æ”¹åè‡ªåŠ¨æ¸…ç©ºç¼“å­˜
- âœ… ç®¡ç†å‘˜é‡ç½®å¯†ç åŠŸèƒ½
- âœ… å®Œæ•´çš„æƒé™æ§åˆ¶
