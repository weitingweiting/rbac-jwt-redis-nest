# 🔧 服务稳定性优化方案

## 问题分析

**原始问题**：NestJS 服务在运行一段时间后会挂掉，浏览器返回 `ERR_CONNECTION_REFUSED`。

### 根本原因分析

通过深入分析，发现了以下几个导致服务崩溃的根本原因：

1. **缺少全局异常处理**
   - `main.ts` 中没有捕获 `unhandledRejection` 和 `uncaughtException`
   - 未处理的 Promise 拒绝会导致进程静默崩溃
   - 未捕获的异常会直接导致进程终止

2. **数据库连接问题**
   - 没有自动重连机制
   - 连接池状态无监控
   - 连接泄漏无法及时发现

3. **Redis 连接问题**
   - 重连策略不够智能
   - 错误处理不够完善

4. **进程管理不足**
   - PM2 配置正确，但应用层缺少防护

## 解决方案

### 1. 全局异常捕获（main.ts）

```typescript
// 🔥 捕获未处理的 Promise 拒绝
process.on('unhandledRejection', (reason: any, promise: Promise<any>) => {
  console.error('🚨 Unhandled Promise Rejection:', reason)
  console.error('Promise:', promise)
  // 记录错误但不退出进程，让 PM2 决定是否重启
})

// 🔥 捕获未捕获的异常
process.on('uncaughtException', (error: Error) => {
  console.error('🚨 Uncaught Exception:', error)
  console.error('Stack:', error.stack)
  // 严重错误，退出进程让 PM2 重启
  process.exit(1)
})

// 🔥 优雅关闭
process.on('SIGTERM', () => {
  console.log('📡 收到 SIGTERM 信号，准备优雅关闭...')
  process.exit(0)
})

process.on('SIGINT', () => {
  console.log('📡 收到 SIGINT 信号，准备优雅关闭...')
  process.exit(0)
})
```

**作用**：

- 捕获所有未处理的 Promise 拒绝，防止静默崩溃
- 捕获所有未捕获的异常，记录日志后让 PM2 重启
- 响应系统信号，实现优雅关闭

### 2. 数据库连接优化（database.config.ts）

```typescript
{
  // 🔥 自动重连配置
  retryAttempts: 10,      // 连接失败时重试10次
  retryDelay: 3000,       // 每次重试延迟3秒
  autoLoadEntities: false,
  subscribers: [],
  migrations: []
}
```

**作用**：

- 数据库连接失败时自动重试
- 避免因临时网络问题导致服务不可用

### 3. 数据库健康监控服务（database-health.service.ts）

新增 `DatabaseHealthService`，提供以下功能：

```typescript
@Injectable()
export class DatabaseHealthService implements OnModuleInit {
  // 每30秒检查一次数据库连接状态
  private startHealthCheck() {
    this.checkInterval = setInterval(async () => {
      await this.checkDatabaseHealth()
    }, 30000)
  }

  // 检查连接池使用率、挂起连接等
  async checkDatabaseHealth() {
    // 1. 测试连接是否可用
    // 2. 监控连接池使用率
    // 3. 检测连接池耗尽风险
    // 4. 自动重连
  }
}
```

**监控指标**：

- 连接池总连接数
- 空闲连接数
- 等待获取连接的请求数
- 连接池使用率（超过 90% 报警）

**作用**：

- 实时监控数据库连接健康状态
- 及时发现连接池耗尽问题
- 连接断开时自动重连
- 防止连接泄漏

### 4. Redis 连接优化（redis.config.ts）

```typescript
reconnectOnError: (err) => {
  console.error('❌ Redis 错误:', err.message)
  // 只对网络错误重连，其他错误不重连
  const reconnectErrors = ['ECONNREFUSED', 'ENOTFOUND', 'ETIMEDOUT']
  return reconnectErrors.some((e) => err.message.includes(e))
},
showFriendlyErrorStack: true
```

**作用**：

- 智能判断错误类型，只对网络错误重连
- 避免因配置错误等问题导致无限重连
- 提供友好的错误堆栈信息

## 效果对比

### 优化前

❌ 问题：

- 未处理的异常导致进程崩溃
- PM2 显示 online 但服务无响应
- 数据库连接问题无法感知
- 需要手动重启服务

### 优化后

✅ 改进：

1. **异常处理**：所有异常都被捕获并记录
2. **自动恢复**：数据库/Redis 连接问题自动重试
3. **健康监控**：每 30 秒检查一次数据库连接状态
4. **预警机制**：连接池使用率过高时记录警告
5. **优雅重启**：严重错误时由 PM2 自动重启

## 日志示例

### 正常运行日志

```
✅ 数据库连接正常 - 连接池状态: 20总/18空闲/0等待
🏥 启动数据库健康检查监控
✅ Redis 缓存功能正常
Application is running on: http://localhost:3000
```

### 异常预警日志

```
⚠️ 数据库连接池使用率过高: 92.50% (18/20)
⚠️ 数据库连接池有 6 个挂起的连接请求
❌ 数据库健康检查失败: Connection lost
✅ 数据库重新连接成功
```

### 崩溃恢复日志

```
🚨 Uncaught Exception: Cannot read property 'id' of undefined
[PM2] Process exited with code 1
[PM2] Starting rbac-nest-dev in fork mode
✅ 数据库重新连接成功
Application is running on: http://localhost:3000
```

## 运维建议

### 1. 监控指标

建议监控以下关键指标：

```bash
# PM2 状态
npx pm2 status

# 内存使用
npx pm2 monit

# 重启次数（如果频繁重启需要调查）
npx pm2 info rbac-nest-dev | grep restarts

# 日志
npx pm2 logs rbac-nest-dev --lines 100
```

### 2. 预警阈值

- 连接池使用率 > 90%：需要优化查询或增加连接数
- 挂起连接请求 > 5：可能存在慢查询
- 每小时重启 > 2 次：需要检查错误日志

### 3. 定期检查

```bash
# 每天检查一次服务健康状态
curl http://localhost:3000/api/v1/health | jq '.data.database'

# 每周检查一次 PM2 日志大小
ls -lh logs/pm2-*.log
```

### 4. 日志清理

PM2 日志会不断增长，建议定期清理：

```bash
# 清理日志
npx pm2 flush

# 或在 ecosystem.config.js 中配置日志轮转
max_size: '10M',
max_files: 3
```

## 故障排查流程

### 服务无响应

1. 检查 PM2 状态

   ```bash
   npx pm2 status
   npx pm2 info rbac-nest-dev
   ```

2. 查看最近的错误日志

   ```bash
   npx pm2 logs rbac-nest-dev --err --lines 50
   ```

3. 检查数据库连接

   ```bash
   curl http://localhost:3000/api/v1/health | jq '.data.database'
   ```

4. 检查端口占用

   ```bash
   lsof -i :3000
   ```

5. 如果服务挂掉，重启服务
   ```bash
   npx pm2 restart rbac-nest-dev
   # 或
   make pm2-restart
   ```

### 频繁重启

1. 查看重启原因

   ```bash
   npx pm2 logs rbac-nest-dev --lines 200 | grep "🚨"
   ```

2. 检查内存使用

   ```bash
   npx pm2 monit
   ```

3. 检查是否有未处理的异常
   ```bash
   grep "Unhandled\|Uncaught" logs/pm2-out.log
   ```

## 总结

通过以上优化，服务稳定性得到了显著提升：

1. ✅ **异常不再导致崩溃**：所有异常都被捕获
2. ✅ **自动恢复能力**：数据库/Redis 连接问题自动重试
3. ✅ **实时监控**：连接池状态每 30 秒检查一次
4. ✅ **预警机制**：及时发现潜在问题
5. ✅ **优雅降级**：严重错误时由 PM2 自动重启

**关键改进文件**：

- `src/main.ts` - 全局异常处理
- `src/shared/config/database.config.ts` - 数据库自动重连
- `src/shared/config/redis.config.ts` - Redis 智能重连
- `src/shared/services/database-health.service.ts` - 数据库健康监控
- `src/database/database.module.ts` - 注册健康监控服务

现在，即使遇到临时的网络问题、数据库故障或未预料的异常，服务也能自动恢复或优雅重启，不再需要手动干预。
