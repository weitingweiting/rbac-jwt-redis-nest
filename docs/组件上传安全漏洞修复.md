# 组件上传安全漏洞修复

## 问题描述

### 发现的安全漏洞

在组件上传流程中存在一个安全漏洞：

- 用户在前端可能有多条申请历史记录（如：APP-20260112-0007、APP-20260112-0008）
- 用户操作某条申请记录进行上传（如：APP-20260112-0007）
- 但是上传的组件包中的 `supplement.json` 可能对应另一条申请（如：APP-20260112-0008）
- **系统没有验证这两个申请单号是否一致，导致可以上传成功**

### 潜在风险

1. **数据混乱**：组件包与申请记录不对应，导致追溯困难
2. **误操作**：用户可能无意中使用了错误的组件包
3. **恶意利用**：用户可能故意使用其他申请的组件包绕过某些限制

## 解决方案

### 修复策略

在上传接口中增加 **申请单号一致性验证**：

1. 前端在调用上传接口时，必须传递当前操作的申请单号 `applicationNo`
2. 后端解析 `supplement.json` 后，立即验证前端传递的申请单号与组件包中的申请单号是否一致
3. 如果不一致，立即拒绝上传并给出明确的错误提示

### 验证流程

```
用户上传 → 接收 applicationNo 参数
         ↓
      验证参数存在
         ↓
      解析 supplement.json
         ↓
      验证 applicationNo 一致性 ← 新增验证点
         ↓
      验证与数据库申请记录一致
         ↓
      继续后续处理...
```

## 代码修改

### 1. 控制器层修改 (`components.controller.ts`)

#### 修改内容

- 添加 `@Query('applicationNo')` 参数接收前端传递的申请单号
- 验证 `applicationNo` 参数是否存在（必传）
- 将 `applicationNo` 传递给 `uploadService.processUpload()`

#### 关键代码

```typescript
@Post('upload')
@RequirePermissions('component.create')
@UseInterceptors(FileInterceptor('file'))
async upload(
  @UploadedFile(...) file: Express.Multer.File,
  @Query('applicationNo') applicationNo: string,  // 新增参数
  @CurrentUser() currentUser: CurrentUserDto
) {
  // 验证必传参数
  if (!applicationNo) {
    throw new BusinessException(
      '缺少申请单号参数 applicationNo',
      HttpStatus.BAD_REQUEST,
      ERROR_CODES.MISSING_REQUIRED_PARAMS
    )
  }

  // 传递给 service 层
  const result = await this.uploadService.processUpload(
    file,
    applicationNo,  // 新增参数
    currentUser.id
  )
  // ...
}
```

### 2. 服务层修改 (`component-upload.service.ts`)

#### 修改内容

- `processUpload()` 方法新增 `applicationNo` 参数
- 在解析 `supplement.json` 后，立即调用验证方法
- 更新日志记录

#### 关键代码

```typescript
async processUpload(
  file: Express.Multer.File,
  applicationNo: string,  // 新增参数
  userId: number
): Promise<...> {
  // ...

  // 2. 解析 supplement.json
  const supplement = await this.validationService.parseAndValidateSupplementJson(file.buffer)

  // 3. 验证申请单号一致性（新增）
  this.validationService.validateApplicationNoConsistency(
    applicationNo,  // 前端传递的申请单号
    supplement._metadata.applicationNo  // 组件包中的申请单号
  )

  // 4. 继续验证申请记录...
}
```

### 3. 验证服务层修改 (`component-validation.service.ts`)

#### 新增方法

```typescript
/**
 * 验证前端传递的申请单号与 supplement.json 中的一致性
 * 防止用户混用不同申请的组件包
 */
validateApplicationNoConsistency(
  requestedApplicationNo: string,
  supplementApplicationNo: string
): void {
  if (requestedApplicationNo !== supplementApplicationNo) {
    throw new BusinessException(
      `申请单号不一致：您正在操作的申请单号是 "${requestedApplicationNo}"，但上传的组件包对应的申请单号是 "${supplementApplicationNo}"。请确保上传正确的组件包，或检查是否选择了错误的申请记录。`,
      HttpStatus.BAD_REQUEST,
      ERROR_CODES.APPLICATION_NO_MISMATCH
    )
  }
}
```

### 4. 错误码常量修改 (`error-codes.constant.ts`)

#### 新增错误码

```typescript
export const ERROR_CODES = {
  // ...
  APPLICATION_NO_MISMATCH: 'APPLICATION_NO_MISMATCH', // 申请单号不匹配
  MISSING_REQUIRED_PARAMS: 'MISSING_REQUIRED_PARAMS' // 缺少必需参数
  // ...
}
```

## API 调用变化

### 修改前

```http
POST /api/components/upload
Content-Type: multipart/form-data

file: [组件包.zip]
```

### 修改后

```http
POST /api/components/upload?applicationNo=APP-20260112-0007
Content-Type: multipart/form-data

file: [组件包.zip]
```

**注意：**`applicationNo` 是必传查询参数

## 错误响应

### 1. 缺少申请单号

```json
{
  "message": "缺少申请单号参数 applicationNo",
  "code": "MISSING_REQUIRED_PARAMS",
  "statusCode": 400
}
```

### 2. 申请单号不匹配

```json
{
  "message": "申请单号不一致：您正在操作的申请单号是 \"APP-20260112-0007\"，但上传的组件包对应的申请单号是 \"APP-20260112-0008\"。请确保上传正确的组件包，或检查是否选择了错误的申请记录。",
  "code": "APPLICATION_NO_MISMATCH",
  "statusCode": 400
}
```

## 测试用例

已创建以下测试用例：

1. `25-upload-component-wrong-applicationNo.bru` - 测试申请单号不匹配的情况
2. `26-upload-component-missing-applicationNo.bru` - 测试缺少申请单号的情况

## 影响范围

### 前端需要适配

前端在调用上传接口时，需要：

1. 传递用户当前操作的申请记录的 `applicationNo`
2. 处理新增的两个错误码
3. 向用户展示明确的错误提示

### 示例代码（前端）

```typescript
// 上传组件
async uploadComponent(applicationNo: string, file: File) {
  const formData = new FormData()
  formData.append('file', file)

  const response = await fetch(
    `/api/components/upload?applicationNo=${applicationNo}`,
    {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`
      },
      body: formData
    }
  )

  if (!response.ok) {
    const error = await response.json()
    if (error.code === 'APPLICATION_NO_MISMATCH') {
      // 显示申请单号不匹配的错误提示
      showError('您上传的组件包与当前申请不匹配，请检查！')
    } else if (error.code === 'MISSING_REQUIRED_PARAMS') {
      // 显示缺少参数的错误提示
      showError('系统错误：缺少必需参数')
    }
  }
}
```

## 验证效果

### 场景 1：正常上传

- 用户操作申请：APP-20260112-0007
- 组件包申请号：APP-20260112-0007
- **结果：✅ 上传成功**

### 场景 2：申请单号不匹配

- 用户操作申请：APP-20260112-0007
- 组件包申请号：APP-20260112-0008
- **结果：❌ 拒绝上传，返回 APPLICATION_NO_MISMATCH 错误**

### 场景 3：缺少申请单号

- 用户未传递 applicationNo 参数
- **结果：❌ 拒绝上传，返回 MISSING_REQUIRED_PARAMS 错误**

## 安全性提升

1. **防止误操作**：用户无法误用其他申请的组件包
2. **数据一致性**：确保上传的组件包与申请记录严格对应
3. **审计追溯**：记录详细的验证日志，便于问题排查
4. **早期拦截**：在处理文件之前就发现问题，节省资源

## 总结

此次修复通过在上传流程中增加申请单号一致性验证，有效堵住了组件包混用的安全漏洞。修改简洁明了，错误提示友好，对用户体验影响最小，同时大幅提升了系统的数据安全性和一致性。

**修改文件列表：**

1. `src/modules/components/controllers/components.controller.ts`
2. `src/modules/components/services/component-upload.service.ts`
3. `src/modules/components/services/component-validation.service.ts`
4. `src/shared/constants/error-codes.constant.ts`
5. `bruno-api-tests/Components/25-upload-component-wrong-applicationNo.bru`（新增）
6. `bruno-api-tests/Components/26-upload-component-missing-applicationNo.bru`（新增）

**修改类型：安全漏洞修复**  
**优先级：高**  
**影响范围：需要前端配合修改**
