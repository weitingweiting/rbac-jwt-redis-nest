# PM2 ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æŒ‡å—

## æ¦‚è¿°

PM2 æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ Node.js è¿›ç¨‹ç®¡ç†å™¨ï¼Œ**ä»…ç”¨äºç”Ÿäº§ç¯å¢ƒ**çš„åº”ç”¨éƒ¨ç½²å’Œç®¡ç†ã€‚

> ğŸ’¡ **æ³¨æ„**ï¼šå¼€å‘ç¯å¢ƒç›´æ¥ä½¿ç”¨ `make dev` æˆ– `pnpm start:dev`ï¼Œæ— éœ€ PM2ã€‚

### PM2 çš„ä¼˜åŠ¿

- ğŸ”„ **è‡ªåŠ¨é‡å¯** - è¿›ç¨‹å´©æºƒåç«‹å³é‡å¯
- ğŸ“Š **é›†ç¾¤æ¨¡å¼** - å……åˆ†åˆ©ç”¨å¤šæ ¸ CPUï¼Œæå‡æ€§èƒ½
- ğŸ’¾ **å†…å­˜ç›‘æ§** - è¶…è¿‡é™åˆ¶è‡ªåŠ¨é‡å¯é‡Šæ”¾å†…å­˜
- ğŸ“ **æ—¥å¿—ç®¡ç†** - è‡ªåŠ¨è®°å½•æ‰€æœ‰è¾“å‡ºå’Œé”™è¯¯
- ğŸ›¡ï¸ **ç¨³å®šè¿è¡Œ** - ä¿æŒæœåŠ¡é«˜å¯ç”¨æ€§
- ğŸ” **å®æ—¶ç›‘æ§** - æŸ¥çœ‹ CPUã€å†…å­˜ä½¿ç”¨æƒ…å†µ

---

## ğŸš€ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

### 1ï¸âƒ£ æ„å»ºåº”ç”¨

```bash
# æ„å»ºç”Ÿäº§ç‰ˆæœ¬
make build

# æˆ–ä½¿ç”¨ pnpm
pnpm build
```

æ„å»ºå®Œæˆåï¼Œä¼šåœ¨ `dist/` ç›®å½•ç”Ÿæˆç¼–è¯‘åçš„ JavaScript æ–‡ä»¶ã€‚

### 2ï¸âƒ£ å¯åŠ¨æœåŠ¡ï¼ˆPM2 é›†ç¾¤æ¨¡å¼ï¼‰

```bash
# ä½¿ç”¨ Makefileï¼ˆæ¨èï¼‰
make start

# æˆ–ç›´æ¥ä½¿ç”¨ PM2
npx pm2 start ecosystem.config.js
```

å¯åŠ¨åä¼šçœ‹åˆ°ï¼š

```
[PM2] Starting /path/to/dist/main.js in cluster_mode
[PM2] Done.
```

### 3ï¸âƒ£ æŸ¥çœ‹æœåŠ¡çŠ¶æ€

```bash
# æŸ¥çœ‹ PM2 è¿›ç¨‹çŠ¶æ€
make status

# æˆ–ç›´æ¥ç”¨ PM2
pm2 status
pm2 list
```

è¾“å‡ºç¤ºä¾‹ï¼ˆé›†ç¾¤æ¨¡å¼ï¼Œ4æ ¸CPUï¼‰ï¼š

```
â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ id â”‚ name             â”‚ mode    â”‚ status  â”‚ cpu      â”‚ memory â”‚ uptime   â”‚
â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 0  â”‚ rbac-nest-prod   â”‚ cluster â”‚ online  â”‚ 2.1%     â”‚ 185MB  â”‚ 2h       â”‚
â”‚ 1  â”‚ rbac-nest-prod   â”‚ cluster â”‚ online  â”‚ 1.8%     â”‚ 178MB  â”‚ 2h       â”‚
â”‚ 2  â”‚ rbac-nest-prod   â”‚ cluster â”‚ online  â”‚ 2.3%     â”‚ 192MB  â”‚ 2h       â”‚
â”‚ 3  â”‚ rbac-nest-prod   â”‚ cluster â”‚ online  â”‚ 1.9%     â”‚ 180MB  â”‚ 2h       â”‚
â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4ï¸âƒ£ æŸ¥çœ‹æ—¥å¿—

```bash
# æŸ¥çœ‹åº”ç”¨æ—¥å¿—ï¼ˆæœ€è¿‘ 50 è¡Œï¼‰
make logs-app

# æˆ–ç›´æ¥ç”¨ PM2
pm2 logs rbac-nest-prod --lines 50

# å®æ—¶æŸ¥çœ‹æ—¥å¿—
pm2 logs rbac-nest-prod
```

---

## ğŸ“Š PM2 ç®¡ç†å‘½ä»¤

### åŸºæœ¬æ“ä½œ

```bash
# é‡å¯æœåŠ¡
make restart
# æˆ–: pm2 restart rbac-nest-prod

# åœæ­¢æœåŠ¡
make stop
# æˆ–: pm2 stop rbac-nest-prod

# åˆ é™¤è¿›ç¨‹
make delete
# æˆ–: pm2 delete rbac-nest-prod

# æŸ¥çœ‹è¿›ç¨‹è¯¦æƒ…
pm2 show rbac-nest-prod

# å®æ—¶ç›‘æ§
pm2 monit
```

### æ—¥å¿—ç®¡ç†

```bash
# æŸ¥çœ‹æ—¥å¿—
pm2 logs rbac-nest-prod

# æ¸…ç©ºæ—¥å¿—
pm2 flush

# é‡è½½æ—¥å¿—
pm2 reloadLogs
```

### è¿›ç¨‹ç®¡ç†

```bash
# ä¿å­˜è¿›ç¨‹åˆ—è¡¨ï¼ˆé‡å¯æœåŠ¡å™¨åè‡ªåŠ¨æ¢å¤ï¼‰
pm2 save

# è®¾ç½®å¼€æœºè‡ªå¯
pm2 startup

# æ›´æ–° PM2
pm2 update
```

---

## âš™ï¸ PM2 é…ç½®æ–‡ä»¶

é…ç½®æ–‡ä»¶ä½äºï¼š`ecosystem.config.js`

```javascript
module.exports = {
  apps: [
    {
      name: 'rbac-nest-prod', // åº”ç”¨åç§°
      script: './dist/main.js', // å¯åŠ¨æ–‡ä»¶
      exec_mode: 'cluster', // é›†ç¾¤æ¨¡å¼
      instances: 'max', // ä½¿ç”¨æ‰€æœ‰ CPU æ ¸å¿ƒ
      max_memory_restart: '500M', // å†…å­˜é™åˆ¶
      autorestart: true, // è‡ªåŠ¨é‡å¯
      max_restarts: 10, // æœ€å¤§é‡å¯æ¬¡æ•°
      min_uptime: '10s', // æœ€å°è¿è¡Œæ—¶é—´
      restart_delay: 3000, // é‡å¯å»¶è¿Ÿ
      error_file: './logs/pm2-error.log',
      out_file: './logs/pm2-out.log',
      wait_ready: true, // ç­‰å¾…åº”ç”¨å°±ç»ªä¿¡å·
      shutdown_with_message: true // ä¼˜é›…é€€å‡º
    }
  ]
}
```

### å…³é”®é…ç½®è¯´æ˜

| é…ç½®é¡¹               | è¯´æ˜     | ç”Ÿäº§å»ºè®®                    |
| -------------------- | -------- | --------------------------- |
| `exec_mode`          | æ‰§è¡Œæ¨¡å¼ | `cluster` - é›†ç¾¤æ¨¡å¼        |
| `instances`          | å®ä¾‹æ•°é‡ | `max` - ä½¿ç”¨æ‰€æœ‰æ ¸å¿ƒ        |
| `max_memory_restart` | å†…å­˜é™åˆ¶ | `500M` - æ ¹æ®æœåŠ¡å™¨é…ç½®è°ƒæ•´ |
| `autorestart`        | è‡ªåŠ¨é‡å¯ | `true` - å´©æºƒåè‡ªåŠ¨æ¢å¤     |
| `wait_ready`         | ç­‰å¾…å°±ç»ª | `true` - ç¡®ä¿åº”ç”¨å®Œå…¨å¯åŠ¨   |

---

## ğŸ” ç›‘æ§ä¸å‘Šè­¦

### å®æ—¶ç›‘æ§é¢æ¿

```bash
# æ‰“å¼€ç›‘æ§é¢æ¿
pm2 monit
```

æ˜¾ç¤ºï¼š

- CPU ä½¿ç”¨ç‡
- å†…å­˜ä½¿ç”¨æƒ…å†µ
- æ—¥å¿—è¾“å‡º
- è¿›ç¨‹çŠ¶æ€

### æŸ¥çœ‹è¿›ç¨‹è¯¦æƒ…

```bash
pm2 show rbac-nest-prod
```

è¾“å‡ºåŒ…æ‹¬ï¼š

- è¿è¡Œæ—¶é—´
- é‡å¯æ¬¡æ•°
- å†…å­˜ä½¿ç”¨
- ç¯å¢ƒå˜é‡
- æ—¥å¿—è·¯å¾„

---

## ğŸš¨ æ•…éšœæ’æŸ¥

### åº”ç”¨æ— æ³•å¯åŠ¨

```bash
# 1. æŸ¥çœ‹é”™è¯¯æ—¥å¿—
pm2 logs rbac-nest-prod --err --lines 100

# 2. æŸ¥çœ‹è¿›ç¨‹è¯¦æƒ…
pm2 show rbac-nest-prod

# 3. æ£€æŸ¥æ„å»ºæ–‡ä»¶
ls -la dist/

# 4. æ‰‹åŠ¨è¿è¡Œæ£€æŸ¥
node dist/main.js
```

### å†…å­˜æŒç»­å¢é•¿

```bash
# 1. æŸ¥çœ‹å†…å­˜ä½¿ç”¨
pm2 status

# 2. é™ä½å†…å­˜é™åˆ¶è§¦å‘é‡å¯
# ç¼–è¾‘ ecosystem.config.js
max_memory_restart: '300M'

# 3. é‡æ–°åŠ è½½é…ç½®
pm2 reload rbac-nest-prod
```

### é¢‘ç¹é‡å¯

```bash
# 1. æŸ¥çœ‹é‡å¯æ¬¡æ•°å’ŒåŸå› 
pm2 show rbac-nest-prod

# 2. æŸ¥çœ‹é”™è¯¯æ—¥å¿—
pm2 logs rbac-nest-prod --err

# 3. å¢åŠ æœ€å°è¿è¡Œæ—¶é—´
min_uptime: '30s'
```

---

## ğŸ“ æœ€ä½³å®è·µ

### 1. æ—¥å¿—ç®¡ç†

```bash
# å®šæœŸæ¸…ç†æ—¥å¿—ï¼ˆé¿å…ç£ç›˜å æ»¡ï¼‰
pm2 flush

# æˆ–ä½¿ç”¨ logrotate è‡ªåŠ¨æ¸…ç†
# åˆ›å»º /etc/logrotate.d/pm2
/path/to/logs/pm2-*.log {
    daily
    rotate 7
    compress
    delaycompress
    notifempty
    missingok
}
```

### 2. æ€§èƒ½ä¼˜åŒ–

```javascript
// ecosystem.config.js
{
  instances: 'max',              // ä½¿ç”¨æ‰€æœ‰æ ¸å¿ƒ
  exec_mode: 'cluster',          // é›†ç¾¤æ¨¡å¼
  max_memory_restart: '500M',    // æ ¹æ®æœåŠ¡å™¨è°ƒæ•´
  node_args: '--max-old-space-size=512'  // Node.js å†…å­˜é™åˆ¶
}
```

### 3. ç›‘æ§å‘Šè­¦

å»ºè®®ä½¿ç”¨ï¼š

- **PM2 Plus**ï¼ˆå®˜æ–¹ç›‘æ§æœåŠ¡ï¼‰
- **Prometheus + Grafana**
- **ELK Stack**ï¼ˆæ—¥å¿—åˆ†æï¼‰

### 4. é›¶åœæœºéƒ¨ç½²

```bash
# ä½¿ç”¨ reload è€Œä¸æ˜¯ restartï¼ˆé›¶åœæœºï¼‰
pm2 reload rbac-nest-prod

# æˆ–ä½¿ç”¨ Makefile
make restart
```

---

## ğŸ” å®‰å…¨å»ºè®®

1. **é™åˆ¶ PM2 æƒé™**

   ```bash
   # ä½¿ç”¨é root ç”¨æˆ·è¿è¡Œ
   sudo useradd -m pm2user
   sudo -u pm2user pm2 start ecosystem.config.js
   ```

2. **ä¿æŠ¤æ—¥å¿—æ–‡ä»¶**

   ```bash
   chmod 600 logs/pm2-*.log
   ```

3. **ç¯å¢ƒå˜é‡éš”ç¦»**
   ```bash
   # ä¸è¦åœ¨ ecosystem.config.js ä¸­ç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯
   # ä½¿ç”¨ .env æ–‡ä»¶æˆ–ç³»ç»Ÿç¯å¢ƒå˜é‡
   ```

---

## ğŸ“š ç›¸å…³èµ„æº

- [PM2 å®˜æ–¹æ–‡æ¡£](https://pm2.keymetrics.io/docs/usage/quick-start/)
- [PM2 é›†ç¾¤æ¨¡å¼](https://pm2.keymetrics.io/docs/usage/cluster-mode/)
- [PM2 æœ€ä½³å®è·µ](https://pm2.keymetrics.io/docs/usage/best-practices/)

---

## â“ å¸¸è§é—®é¢˜

### Q: ä¸ºä»€ä¹ˆå¼€å‘ç¯å¢ƒä¸ç”¨ PM2ï¼Ÿ

A: å¼€å‘ç¯å¢ƒéœ€è¦é¢‘ç¹é‡å¯å’Œçƒ­é‡è½½ï¼ŒPM2 ä¼šå¢åŠ å¤æ‚æ€§ã€‚ç›´æ¥ä½¿ç”¨ `nest start --watch` æ›´æ–¹ä¾¿è°ƒè¯•ã€‚

### Q: é›†ç¾¤æ¨¡å¼å¦‚ä½•å¤„ç† WebSocketï¼Ÿ

A: ä½¿ç”¨ Redis adapter å®ç°è·¨è¿›ç¨‹é€šä¿¡ï¼š

```typescript
// ä½¿ç”¨ @nestjs/platform-socket.io çš„ Redis adapter
```

### Q: å¦‚ä½•é™åˆ¶ PM2 ä½¿ç”¨çš„ CPU æ ¸å¿ƒæ•°ï¼Ÿ

A: ä¿®æ”¹ `ecosystem.config.js`ï¼š

```javascript
instances: 2 // å›ºå®šä½¿ç”¨ 2 ä¸ªæ ¸å¿ƒ
```

### Q: PM2 æ—¥å¿—å¤ªå¤§æ€ä¹ˆåŠï¼Ÿ

A: ä½¿ç”¨ logrotate æˆ–å®šæœŸæ‰§è¡Œ `pm2 flush`
