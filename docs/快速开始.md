# 🚀 快速开始指南

本指南帮助你在 5 分钟内快速启动项目。

## 📋 前置要求

- **Node.js** >= 18（推荐使用 LTS 版本）
- **pnpm** >= 8（推荐使用 pnpm 作为包管理器）
- **Docker** 和 **Docker Compose**（用于运行 MySQL 和 Redis）

## 🛠️ 安装步骤

### 1. 克隆项目并安装依赖

```bash
# 克隆项目
git clone <repository-url>
cd rbac+jwt+redis-DEMO

# 安装依赖
pnpm install
```

### 2. 配置环境变量

```bash
# 复制环境变量模板
cp .env.example .env

# 编辑 .env 文件（可选，使用默认配置即可）
```

默认配置如下，适用于开发环境：

```env
# 应用配置
NODE_ENV=development
PORT=3000
APP_NAME=RBAC-Demo

# JWT 配置
JWT_SECRET=your-super-secret-jwt-key-change-in-production
JWT_EXPIRES_IN=24h

# 数据库配置
DATABASE_HOST=localhost
DATABASE_PORT=3306
DATABASE_USER=root
DATABASE_PASSWORD=password
DATABASE_NAME=rbac_demo

# Redis 配置
REDIS_HOST=localhost
REDIS_PORT=6379
```

### 3. 启动基础服务（MySQL + Redis）

```bash
# 方式一：使用 Makefile（推荐）
make up

# 方式二：直接使用 docker-compose
docker-compose up -d mysql redis
```

等待 10-15 秒，确保数据库完全启动。

### 4. 初始化数据库

**重要：** 有两种方式初始化数据库，**选择其一即可**：

#### 方式一：使用 Seed 脚本（推荐）⭐

```bash
# 使用 Makefile
make seed

# 或直接运行
npm run seed
```

**特点：**

- ✅ 自动创建所有表（TypeORM synchronize）
- ✅ 自动插入初始数据（权限、角色、用户）
- ✅ 支持增量更新
- ✅ **生产环境推荐方式**

#### 方式二：使用 SQL 脚本

```bash
# 方式 2.1：使用 docker exec
docker exec -i rbac-demo-mysql mysql -uroot -ppassword rbac_demo < init.sql

# 方式 2.2：通过 Adminer 手动导入
# 1. 访问 http://localhost:8080
# 2. 登录后选择 "导入" 功能
# 3. 上传 init.sql 文件
```

**特点：**

- ✅ 手动执行 SQL，完全可控
- ✅ 适合理解数据库结构
- ⚠️ 需要手动管理表结构变更

### 5. 启动开发服务器

```bash
# 使用 Makefile
make dev

# 或直接运行
npm run start:dev
```

看到以下输出表示启动成功：

```
[RBAC-Demo] LOG [NestApplication] Nest application successfully started
[RBAC-Demo] LOG [Bootstrap] Application is running on: http://localhost:3000
[RBAC-Demo] LOG [Bootstrap] API endpoint: http://localhost:3000/api
```

## ✅ 验证安装

### 1. 访问 API

打开浏览器访问：http://localhost:3000/api

应该看到欢迎信息：

```json
{
  "message": "Welcome to RBAC + JWT + Redis Demo API",
  "version": "1.0.0"
}
```

### 2. 测试登录

```bash
# 使用 admin 账户登录
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"Admin123"}'
```

应该返回包含 `accessToken` 的响应。

### 3. 测试权限保护的接口

```bash
# 使用返回的 token 访问受保护的接口
curl http://localhost:3000/api/auth/profile \
  -H "Authorization: Bearer <your-access-token>"
```

## 🎯 默认账户

初始化后会自动创建以下测试账户：

| 用户名 | 密码      | 角色   | 权限                       |
| ------ | --------- | ------ | -------------------------- |
| admin  | Admin123  | 管理员 | 所有权限（27个）           |
| editor | Editor123 | 编辑者 | 查看、创建、更新、发布权限 |
| viewer | Viewer123 | 查看者 | 仅查看权限                 |

## 🛠️ 管理工具

启动管理工具（可选）：

```bash
# 使用 Makefile
make up-tools

# 或直接使用 docker-compose
docker-compose --profile tools up -d
```

访问管理工具：

- **Adminer**（MySQL 管理）：http://localhost:8080
  - 系统：MySQL
  - 服务器：mysql
  - 用户名：root
  - 密码：password
  - 数据库：rbac_demo

- **RedisInsight**（Redis 管理）：http://localhost:8001

## 📚 下一步

- [查看项目结构](./项目结构.md) - 了解代码组织
- [查看 API 文档](./API接口.md) - 查看所有可用接口
- [查看开发指南](./开发指南.md) - 深入了解认证、权限等功能
- [查看部署指南](./部署指南.md) - 了解生产环境部署

## ❓ 常见问题

### 数据库连接失败

```bash
# 检查容器状态
docker ps

# 查看 MySQL 日志
docker logs rbac-demo-mysql

# 重启 MySQL
docker restart rbac-demo-mysql
```

### Redis 连接失败

```bash
# 检查 Redis 是否运行
docker exec rbac-demo-redis redis-cli ping

# 应该返回 PONG
```

### 端口冲突

如果端口被占用，修改 `docker-compose.yml` 中的端口映射：

```yaml
ports:
  - '3307:3306' # MySQL 改为 3307
  - '6380:6379' # Redis 改为 6380
```

然后在 `.env` 中也要相应修改端口。

## 🔧 可用命令

```bash
# 启动相关
make up          # 启动 MySQL 和 Redis
make up-tools    # 启动所有服务（包含管理工具）
make dev         # 启动开发服务器
make seed        # 初始化数据库

# 停止相关
make down        # 停止所有服务
make down-basic  # 只停止基础服务

# 数据库相关
make backup-db   # 备份数据库
make restore-db  # 恢复数据库

# 健康检查
make health      # 检查服务状态

# 完整流程
make init        # 完整初始化（创建目录 + 启动服务 + 安装依赖 + 初始化数据）
make reset       # 清理并重新初始化
```
